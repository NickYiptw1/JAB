<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jabç†è«–AIå…§å®¹ç”Ÿç”¢å™¨ - å¤šæ¨£æ€§å¼·åŒ–ç‰ˆ</title>
  <link href="../input.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    .loading { animation: pulse 2s infinite; }
    .error-shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-online { background: #10b981; color: white; }
    .status-offline { background: #ef4444; color: white; }
    .status-checking { background: #f59e0b; color: white; }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-8">
  <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="connectionStatus" class="connection-status status-checking">
    ğŸ”„ æª¢æ¸¬ä¸­...
  </div>

  <!-- ä¸»è¦å…§å®¹ç”Ÿç”¢å™¨ -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8 mb-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-blue-700">ğŸ¥Š Jabç†è«–AIå…§å®¹ç”Ÿç”¢å™¨</h1>
        <div class="text-xs text-green-600 font-medium mt-1">ğŸ¯ åŸºæ–¼ã€ŠJab, Jab, Jab, Right Hookã€‹ç†è«– - åƒ¹å€¼å°å‘å…§å®¹å‰µä½œ</div>
        <div class="text-xs text-purple-600 font-medium mt-1">ğŸ”§ v5.0 å¼·åˆ¶å·®ç•°åŒ–ç‰ˆ - 7å±¤è½‰æ›ç¢ºä¿æ¯ç¯‡å®Œå…¨ä¸åŒ</div>
      </div>
      <div class="text-sm text-gray-500">
        <span id="serverInfo">ä¼ºæœå™¨: æœªé€£æ¥</span>
      </div>
    </div>

    <form id="contentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- åŸºæœ¬è¨­å®š -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">åŸºæœ¬è¨­å®š</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">ä¸»é¡Œ *</span>
          <input type="text" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" 
                 placeholder="ä¾‹ï¼šè·å ´å£“åŠ›ç®¡ç†ã€æ•¸ä½è¡ŒéŠ·ç­–ç•¥" required>
          <span class="text-xs text-gray-400">å…·é«”æ˜ç¢ºçš„ä¸»é¡Œæœƒç”¢ç”Ÿæ›´å¥½çš„å…§å®¹</span>
        </label>
        
        <label class="block">
          <span class="text-gray-700 font-medium">å…§å®¹å‹æ…‹</span>
          <select id="contentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="jab">ğŸ¥Š Jabï¼ˆçµ¦äºˆåƒ¹å€¼ï¼‰- æ•™è‚²ã€å¨›æ¨‚ã€å•Ÿç™¼ï¼Œå»ºç«‹ä¿¡ä»»</option>
            <option value="right_hook">ğŸ’¥ Right Hookï¼ˆè«‹æ±‚è¡Œå‹•ï¼‰- æ˜ç¢ºCTAï¼Œè½‰æ›å°å‘</option>
            <option value="jab_story">ğŸ“– Jabæ•…äº‹å‹ - é€éæ•…äº‹å‚³éåƒ¹å€¼èˆ‡æƒ…æ„Ÿé€£çµ</option>
            <option value="jab_education">ğŸ“ Jabæ•™è‚²å‹ - å°ˆæ¥­çŸ¥è­˜åˆ†äº«èˆ‡æŠ€èƒ½æå‡</option>
            <option value="jab_entertainment">ğŸª Jabå¨›æ¨‚å‹ - è¼•é¬†å¹½é»˜ï¼Œå¢åŠ è¦ªå’ŒåŠ›</option>
            <option value="right_hook_soft">ğŸ¯ Right Hookè»Ÿæ€§ - é–“æ¥å¼•å°ï¼Œè‡ªç„¶è½‰æ›</option>
            <option value="right_hook_direct">âš¡ Right Hookç›´æ¥ - æ˜ç¢ºå‘¼ç±²ï¼Œç«‹å³è¡Œå‹•</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">ç”¢å‡ºæ•¸é‡</span>
          <select id="count" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="1">1 ç¯‡</option>
            <option value="2">2 ç¯‡</option>
            <option value="3" selected>3 ç¯‡</option>
            <option value="4">4 ç¯‡</option>
            <option value="5">5 ç¯‡</option>
          </select>
        </label>
      </div>

      <!-- å¹³å°èˆ‡é¢¨æ ¼ -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">å¹³å°èˆ‡é¢¨æ ¼</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">ç›®æ¨™å¹³å°</span>
          <select id="platform" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="Facebook">ğŸ“˜ Facebook - å°è©±å¼äº’å‹•ï¼Œæ•…äº‹æ€§å¼·ï¼Œè¡¨æƒ…è±å¯Œ</option>
            <option value="Instagram">ğŸ“· Instagram - è¦–è¦ºæ•˜è¿°ï¼Œåˆ†è¡Œå‘ˆç¾ï¼Œhashtagç­–ç•¥</option>
            <option value="Twitter">ğŸ¦ Twitter - ç°¡æ½”æœ‰åŠ›ï¼Œè§€é»é®®æ˜ï¼Œæ˜“è½‰ç™¼</option>
            <option value="LinkedIn">ğŸ’¼ LinkedIn - å°ˆæ¥­æ¬Šå¨ï¼Œæ•¸æ“šæ”¯æ’ï¼Œè·å ´åƒ¹å€¼</option>
            <option value="Pinterest">ğŸ“Œ Pinterest - å‰µæ„éˆæ„Ÿï¼Œç¾å­¸å°å‘ï¼Œå¯¦ç”¨æ”¶è—</option>
            <option value="TikTok">ğŸµ TikTok - å¹´è¼•æ´»åŠ›ï¼Œè¶¨å‹¢è©±é¡Œï¼Œäº’å‹•æŒ‘æˆ°</option>
            <option value="YouTube">ğŸ“º YouTube - è©³ç´°å°ˆæ¥­ï¼Œæ•™è‚²å°å‘ï¼ŒSEOå„ªåŒ–</option>
            <option value="é€šç”¨">ğŸŒ é€šç”¨å¹³å° - é©æ‡‰æ€§å¼·ï¼Œå¤šå¹³å°å…¼å®¹</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">å…§å®¹é¢¨æ ¼</span>
          <select id="style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="åŸç”Ÿåƒ¹å€¼å°å‘">ğŸ¯ åŸç”Ÿåƒ¹å€¼å°å‘ - èå…¥å¹³å°æ–‡åŒ–åŒæ™‚æä¾›åƒ¹å€¼</option>
            <option value="æ•…äº‹æƒ…æ„Ÿå‹">ğŸ“š æ•…äº‹æƒ…æ„Ÿå‹ - é€éæ•…äº‹å»ºç«‹æƒ…æ„Ÿé€£çµ</option>
            <option value="æ•™è‚²åˆ†äº«å‹">ğŸ“ æ•™è‚²åˆ†äº«å‹ - å°ˆæ¥­çŸ¥è­˜å‚³æˆèˆ‡æŠ€èƒ½æå‡</option>
            <option value="å¨›æ¨‚è¦ªå’Œå‹">ğŸª å¨›æ¨‚è¦ªå’Œå‹ - è¼•é¬†å¹½é»˜å¢åŠ å“ç‰Œè¦ªå’ŒåŠ›</option>
            <option value="å•Ÿç™¼æ€è€ƒå‹">ğŸ’¡ å•Ÿç™¼æ€è€ƒå‹ - å¼•ç™¼æ€è€ƒèˆ‡æ·±åº¦è¨è«–</option>
            <option value="å¯¦ç”¨æŒ‡å°å‹">ğŸ”§ å¯¦ç”¨æŒ‡å°å‹ - å…·é«”æ­¥é©Ÿèˆ‡å¯¦ä½œæŒ‡å—</option>
            <option value="ç¤¾ç¾¤äº’å‹•å‹">ğŸ¤ ç¤¾ç¾¤äº’å‹•å‹ - ä¿ƒé€²åƒèˆ‡èˆ‡å°è©±</option>
            <option value="è¶¨å‹¢æ´å¯Ÿå‹">ğŸ” è¶¨å‹¢æ´å¯Ÿå‹ - è¡Œæ¥­åˆ†æèˆ‡æœªä¾†å±•æœ›</option>
          </select>
        </label>
      </div>

      <!-- æŠ€è¡“è¨­å®š -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">æŠ€è¡“è¨­å®š</h3>
        <label class="block">
          <span class="text-gray-700 font-medium tooltip">AIæ¨¡å‹
            <span class="tooltiptext">ä¸åŒæ¨¡å‹æœ‰ä¸åŒç‰¹æ€§ï¼Œå¯å˜—è©¦åˆ‡æ›ç²å¾—æœ€ä½³æ•ˆæœ</span>
          </span>
          <select id="model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="tngtech/deepseek-r1t2-chimera:free">ğŸ§  DeepSeek R1T2 (æ¨è–¦)</option>
            <option value="tngtech/deepseek-r1t-chimera:free">ğŸ”¬ DeepSeek R1T (ç©©å®š)</option>
            <option value="openai/gpt-3.5-turbo">ğŸ’¨ GPT-3.5 Turbo (å¿«é€Ÿ)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">å‰µæ„åº¦</span>
          <input type="range" id="creativity" min="0" max="100" value="70" class="mt-1 block w-full">
          <div class="flex justify-between text-xs text-gray-400">
            <span>ä¿å®ˆ</span>
            <span id="creativityValue">70%</span>
            <span>å‰µæ–°</span>
          </div>
        </label>

        <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 font-semibold shadow-lg mb-2">
          ğŸš€ ç”¢ç”Ÿå…§å®¹
        </button>
        
        <button type="button" id="quickTestBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-medium text-sm">
          ğŸ§ª å¿«é€Ÿæ¸¬è©¦ï¼ˆä¿®å¾©é©—è­‰ï¼‰
        </button>
      </div>
    </form>

    <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
    <div id="contentResult" class="space-y-4"></div>
  </div>

  <!-- AIæ™ºèƒ½åŠ©æ‰‹ -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h2>
      <button id="clearChat" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">æ¸…é™¤å°è©±</button>
    </div>

    <!-- å¿«é€Ÿè¨­å®š -->
    <div id="chatOptions" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">å…§å®¹å‹æ…‹</span>
        <select id="chatContentType" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="jab">ğŸ¥Š Jab</option>
          <option value="right_hook">ğŸ’¥ Right Hook</option>
          <option value="analysis">ğŸ“Š åˆ†æ</option>
          <option value="optimization">âš¡ å„ªåŒ–</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">å¹³å°</span>
        <select id="chatPlatform" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="Facebook">ğŸ“˜ Facebook</option>
          <option value="Instagram">ğŸ“· Instagram</option>
          <option value="Twitter">ğŸ¦ Twitter</option>
          <option value="LinkedIn">ğŸ’¼ LinkedIn</option>
          <option value="é€šç”¨">ğŸŒ é€šç”¨</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">é¢¨æ ¼</span>
        <select id="chatStyle" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="åŸç”Ÿ">ğŸ¯ åŸç”Ÿ</option>
          <option value="å°ˆæ¥­">ğŸ‘” å°ˆæ¥­</option>
          <option value="è¼•é¬†">ğŸ˜Š è¼•é¬†</option>
          <option value="å‰µæ„">ğŸ¨ å‰µæ„</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">èªèª¿</span>
        <select id="chatTone" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="å‹å–„">ğŸ˜Š å‹å–„</option>
          <option value="æ­£å¼">ğŸ‘” æ­£å¼</option>
          <option value="ç†±æƒ…">ğŸ”¥ ç†±æƒ…</option>
          <option value="å†·éœ">ğŸ§˜ å†·éœ</option>
        </select>
      </label>
    </div>

    <!-- å°è©±çª—å£ -->
    <div id="chatWindow" class="h-80 overflow-y-auto bg-gradient-to-b from-gray-50 to-white rounded-lg p-4 mb-4 border space-y-3">
      <div class="text-center text-gray-400 text-sm">
        ğŸ’¬ æ­¡è¿ä½¿ç”¨AIåŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¹«ä½ å„ªåŒ–å…§å®¹ã€åˆ†æç­–ç•¥ã€æˆ–å›ç­”ä»»ä½•ç›¸é—œå•é¡Œ
      </div>
    </div>

    <!-- è¼¸å…¥å€åŸŸ -->
    <form id="chatForm" class="flex gap-3">
      <div class="flex-1 relative">
        <input type="text" id="chatInput" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 pr-12" 
               placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–æƒ³æ³•..." required>
        <div id="inputCounter" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">0</div>
      </div>
      <button type="submit" id="sendBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-semibold">
        ğŸ“¤ é€å‡º
      </button>
    </form>

    <!-- å¿«é€Ÿæç¤º -->
    <div class="mt-4 flex flex-wrap gap-2">
      <span class="text-sm text-gray-500">å¿«é€Ÿæç¤ºï¼š</span>
      <button class="quick-prompt text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition" data-prompt="å¹«æˆ‘åˆ†æé€™å€‹å…§å®¹çš„å„ªç¼ºé»">ğŸ“Š åˆ†æå…§å®¹</button>
      <button class="quick-prompt text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition" data-prompt="å¦‚ä½•æå‡é€™å€‹è²¼æ–‡çš„äº’å‹•ç‡ï¼Ÿ">ğŸš€ æå‡äº’å‹•</button>
      <button class="quick-prompt text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition" data-prompt="çµ¦æˆ‘3å€‹ç›¸é—œçš„å…§å®¹å‰µæ„">ğŸ’¡ å…§å®¹å‰µæ„</button>
      <button class="quick-prompt text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition" data-prompt="ä»€éº¼æ™‚å€™ç™¼æ–‡æ•ˆæœæœ€å¥½ï¼Ÿ">â° ç™¼æ–‡æ™‚æ©Ÿ</button>
    </div>
  </div>

  <script>
    // å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç†
    const STATE = {
      isConnected: false,
      currentServer: null,
      isGenerating: false,
      isChatting: false,
      chatHistory: [],
      lastGenerated: null
    };

    // API é…ç½®
    const API_CONFIG = {
      ports: [3001, 3002, 3003, 3004, 3005, 3006, 3007, 3008, 3009, 3010, 3000, 8080, 5000],
      timeout: 120000, // å»¶é•·åˆ°120ç§’ï¼ˆ2åˆ†é˜ï¼‰ï¼Œçµ¦AIå……è¶³æ™‚é–“ç”Ÿæˆå…§å®¹
      retryAttempts: 2 // æ¸›å°‘é‡è©¦æ¬¡æ•¸é¿å…éé•·ç­‰å¾…
    };

    // DOM å…ƒç´ 
    const elements = {
      connectionStatus: document.getElementById('connectionStatus'),
      serverInfo: document.getElementById('serverInfo'),
      contentForm: document.getElementById('contentForm'),
      contentResult: document.getElementById('contentResult'),
      chatForm: document.getElementById('chatForm'),
      chatWindow: document.getElementById('chatWindow'),
      chatInput: document.getElementById('chatInput'),
      generateBtn: document.getElementById('generateBtn'),
      quickTestBtn: document.getElementById('quickTestBtn'),
      sendBtn: document.getElementById('sendBtn'),
      creativitySlider: document.getElementById('creativity'),
      creativityValue: document.getElementById('creativityValue'),
      inputCounter: document.getElementById('inputCounter'),
      clearChat: document.getElementById('clearChat')
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ AIå…§å®¹ç”Ÿç”¢å™¨ ä¿®å¾©ç‰ˆæœ¬ v2.0 è¼‰å…¥å®Œæˆ');
      console.log('ğŸ”§ ä¸»è¦ä¿®å¾©: è¶…æ™‚å•é¡Œã€ç€è¦½å™¨ç›¸å®¹æ€§ã€éŒ¯èª¤è™•ç†');
      
      initializeApp();
      setupEventListeners();
      detectServer();
      
      // é¡¯ç¤ºå¾ªåºæ¼¸é€²ç‰ˆæœ¬æç¤º
      setTimeout(() => {
        showSystemMessage('ğŸ‰ å¾ªåºæ¼¸é€²ç‰ˆæœ¬å·²è¼‰å…¥ï¼åè¦†è™•ç†æ©Ÿåˆ¶ç¢ºä¿æ¯ç¯‡å…§å®¹å®Œå…¨ä¸åŒ', 'success');
      }, 2000);
    });

    // æ‡‰ç”¨åˆå§‹åŒ–
    function initializeApp() {
      // å‰µæ„åº¦æ»‘æ¡¿
      elements.creativitySlider.addEventListener('input', function() {
        elements.creativityValue.textContent = this.value + '%';
      });

      // è¼¸å…¥å­—æ•¸çµ±è¨ˆ
      elements.chatInput.addEventListener('input', function() {
        elements.inputCounter.textContent = this.value.length;
      });

      // å¿«é€Ÿæç¤ºæŒ‰éˆ•
      document.querySelectorAll('.quick-prompt').forEach(btn => {
        btn.addEventListener('click', function() {
          const prompt = this.dataset.prompt;
          elements.chatInput.value = prompt;
          elements.chatInput.focus();
        });
      });

      // æ¸…é™¤å°è©±
      elements.clearChat.addEventListener('click', function() {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
          elements.chatWindow.innerHTML = '<div class="text-center text-gray-400 text-sm">ğŸ’¬ å°è©±å·²æ¸…é™¤ï¼Œé‡æ–°é–‹å§‹å§ï¼</div>';
          STATE.chatHistory = [];
        }
      });
    }

    // äº‹ä»¶ç›£è½å™¨è¨­ç½®
    function setupEventListeners() {
      elements.contentForm.addEventListener('submit', handleContentGeneration);
      elements.chatForm.addEventListener('submit', handleChatSubmission);
      
      // å¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
      if (elements.quickTestBtn) {
        elements.quickTestBtn.addEventListener('click', handleQuickTest);
      }

      // è¡¨å–®å³æ™‚é©—è­‰
      document.getElementById('topic').addEventListener('blur', validateTopic);
      
      // éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          if (document.activeElement === elements.chatInput) {
            handleChatSubmission(e);
          }
        }
      });
    }

    // ä¼ºæœå™¨åµæ¸¬
    async function detectServer() {
      updateConnectionStatus('checking', 'ğŸ”„ åµæ¸¬ä¼ºæœå™¨...');
      
      for (let port of API_CONFIG.ports) {
        try {
          const response = await fetch(`http://localhost:${port}/health`, {
            method: 'GET',
            signal: AbortSignal.timeout(2000)
          });
          
          if (response.ok) {
            STATE.currentServer = `http://localhost:${port}`;
            STATE.isConnected = true;
            updateConnectionStatus('online', `âœ… å·²é€£æ¥ (${port})`);
            elements.serverInfo.textContent = `ä¼ºæœå™¨: localhost:${port}`;
            break;
          }
        } catch (error) {
          console.log(`Port ${port} ä¸å¯ç”¨:`, error.message);
        }
      }

      if (!STATE.isConnected) {
        updateConnectionStatus('offline', 'âŒ ç„¡æ³•é€£æ¥');
        elements.serverInfo.textContent = 'ä¼ºæœå™¨: é›¢ç·š';
        showSystemMessage('âš ï¸ ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªä¼ºæœå™¨å·²å•Ÿå‹•', 'warning');
      }
    }

    // æ›´æ–°é€£ç·šç‹€æ…‹
    function updateConnectionStatus(status, text) {
      elements.connectionStatus.className = `connection-status status-${status}`;
      elements.connectionStatus.textContent = text;
    }

    // è¡¨å–®é©—è­‰
    function validateTopic() {
      const topic = document.getElementById('topic').value.trim();
      const topicField = document.getElementById('topic');
      
      if (topic.length < 2) {
        topicField.classList.add('border-red-300', 'error-shake');
        showSystemMessage('âŒ ä¸»é¡Œè‡³å°‘éœ€è¦2å€‹å­—ç¬¦', 'error');
        return false;
      } else {
        topicField.classList.remove('border-red-300', 'error-shake');
        return true;
      }
    }

    // å¿«é€Ÿæ¸¬è©¦åŠŸèƒ½
    async function handleQuickTest() {
      if (STATE.isGenerating) {
        showSystemMessage('âš ï¸ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...', 'warning');
        return;
      }
      
      if (!STATE.isConnected) {
        showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
        return;
      }
      
      // è‡ªå‹•å¡«å…¥Jabç†è«–æ¸¬è©¦æ•¸æ“š
      document.getElementById('topic').value = 'Jabç†è«–å¤šæ¨£æ€§æ¸¬è©¦';
      document.getElementById('count').value = '3';
      document.getElementById('contentType').value = 'jab_education';
      document.getElementById('platform').value = 'Facebook';
      document.getElementById('style').value = 'æ•™è‚²åˆ†äº«å‹';
      document.getElementById('creativity').value = '80';
      
      showSystemMessage('ğŸ§ª é–‹å§‹å¿«é€Ÿæ¸¬è©¦å¾ªåºæ¼¸é€²ç”Ÿæˆ...', 'info');
      console.log('ğŸ§ª === å¾ªåºæ¼¸é€²æ¸¬è©¦é–‹å§‹ ===');
      console.log('ğŸ“Š åè¦†è™•ç†æ¨¡å¼:', 'ä¸€ç¯‡â†’åˆ†æâ†’èª¿æ•´â†’ä¸‹ä¸€ç¯‡');
      console.log('ğŸ¯ Jabç†è«–æ‡‰ç”¨:', 'è‡ªé©æ‡‰å·®ç•°åŒ–ç”Ÿæˆ');
      
      // è§¸ç™¼å…§å®¹ç”Ÿæˆ
      const fakeEvent = { preventDefault: () => {} };
      await handleContentGeneration(fakeEvent);
    }

    // å¾ªåºæ¼¸é€²å…§å®¹ç”Ÿæˆè™•ç† - åè¦†è™•ç†æ©Ÿåˆ¶
    async function handleContentGeneration(e) {
      e.preventDefault();
      
      if (!validateTopic() || !STATE.isConnected || STATE.isGenerating) {
        return;
      }

      STATE.isGenerating = true;
      updateGenerateButton(true);

      const contentCount = parseInt(document.getElementById('count').value);
      const baseFormData = {
        topic: document.getElementById('topic').value.trim(),
        model: document.getElementById('model').value,
        contentType: document.getElementById('contentType').value,
        platform: document.getElementById('platform').value,
        style: document.getElementById('style').value,
        creativity: document.getElementById('creativity').value,
        timestamp: new Date().toISOString(),
        requestId: generateRequestId()
      };

      // åˆå§‹åŒ–çµæœå®¹å™¨
      const allGeneratedContents = [];
      const allVariationData = [];
      
      showProgressiveLoadingState(0, contentCount);

      try {
        // å¾ªåºæ¼¸é€²ç”Ÿæˆæ¯ç¯‡å…§å®¹
        for (let i = 0; i < contentCount; i++) {
          console.log(`ğŸ”„ é–‹å§‹ç”Ÿæˆç¬¬ ${i + 1} ç¯‡å…§å®¹ï¼Œç¸½å…± ${contentCount} ç¯‡`);
          
          // åŸºæ–¼å‰é¢å·²ç”Ÿæˆçš„å…§å®¹åˆ†æï¼Œèª¿æ•´ç•¶å‰ç”Ÿæˆç­–ç•¥
          const currentVariation = await generateAdaptiveVariation(i, contentCount, allGeneratedContents, baseFormData);
          allVariationData.push(currentVariation);
          
          // æ›´æ–°é€²åº¦é¡¯ç¤º
          updateProgressiveLoadingState(i, contentCount, currentVariation);
          
          // ç”Ÿæˆå–®ç¯‡å…§å®¹
          const singleContentData = {
            ...baseFormData,
            count: 1, // ä¸€æ¬¡åªç”Ÿæˆä¸€ç¯‡
            currentIndex: i,
            totalCount: contentCount,
            
            // ç•¶å‰ç¯‡çš„ç‰¹æ®Šé…ç½®
            jabTheoryMode: 'progressive_adaptive',
            currentVariation: currentVariation,
            previousContents: allGeneratedContents.length > 0 ? allGeneratedContents : [],
            
            // å¼·åˆ¶å·®ç•°åŒ–æŒ‡ä»¤
            forceDifferentiation: {
              mustAvoidSimilarity: true,
              previousContentAnalysis: await analyzePreviousContents(allGeneratedContents),
              targetUniqueness: `ç¬¬${i + 1}ç¯‡å¿…é ˆèˆ‡å‰${i}ç¯‡å®Œå…¨ä¸åŒ`,
              specificRequirements: currentVariation.specificRequirements
            }
          };

          console.log(`ğŸ“¤ ç™¼é€ç¬¬ ${i + 1} ç¯‡å…§å®¹ç”Ÿæˆè«‹æ±‚:`, singleContentData);
          
          const response = await fetchWithRetry(`${STATE.currentServer}/api/generate-content`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(singleContentData)
          });

          const data = await response.json();
          
          if (data && data.contents && data.contents.length > 0) {
            let rawContent = data.contents[0];
            
            // ğŸš€ å¼·åˆ¶å…§å®¹å·®ç•°åŒ–è™•ç†
            const processedContent = await forceContentDifferentiation(
              rawContent, 
              allGeneratedContents, 
              currentVariation, 
              i, 
              baseFormData
            );
            
            allGeneratedContents.push({
              content: processedContent.content,
              index: i,
              variation: currentVariation,
              generatedAt: new Date().toISOString(),
              originalContent: rawContent,
              transformations: processedContent.transformations
            });
            
            console.log(`âœ… ç¬¬ ${i + 1} ç¯‡å…§å®¹ç”Ÿæˆä¸¦å¼·åˆ¶å·®ç•°åŒ–æˆåŠŸ`);
            console.log(`ğŸ“ æ‡‰ç”¨çš„è½‰æ›:`, processedContent.transformations);
            
            // ç«‹å³é¡¯ç¤ºå·²ç”Ÿæˆçš„å…§å®¹
            displayProgressiveContent(allGeneratedContents, baseFormData);
            
            // çŸ­æš«å»¶é²ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°é€²åº¦
            if (i < contentCount - 1) {
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          } else {
            throw new Error(`ç¬¬ ${i + 1} ç¯‡å…§å®¹ç”Ÿæˆå¤±æ•—: ${JSON.stringify(data)}`);
          }
        }

        // æ‰€æœ‰å…§å®¹ç”Ÿæˆå®Œæˆ
        const finalContents = allGeneratedContents.map(item => item.content);
        const finalFormData = {
          ...baseFormData,
          count: contentCount,
          multipleVariations: allGeneratedContents.map(item => ({
            ...allVariationData[item.index],
            transformations: item.transformations || []
          })),
          jabTheoryMode: 'progressive_completed',
          diversityLevel: 'maximum_progressive',
          forceUnique: true
        };

        displayGeneratedContent(finalContents, finalFormData);
        STATE.lastGenerated = { contents: finalContents, formData: finalFormData };
        showSystemMessage(`âœ… å¾ªåºæ¼¸é€²ç”Ÿæˆå®Œæˆï¼${contentCount}ç¯‡å…§å®¹å·²ç¢ºä¿å®Œå…¨ä¸åŒ`, 'success');
        
      } catch (error) {
        console.error('ğŸ’¥ å¾ªåºæ¼¸é€²ç”ŸæˆéŒ¯èª¤:', error);
        
        if (allGeneratedContents.length > 0) {
          // éƒ¨åˆ†æˆåŠŸï¼Œé¡¯ç¤ºå·²ç”Ÿæˆçš„å…§å®¹
          const partialContents = allGeneratedContents.map(item => item.content);
          const partialFormData = {
            ...baseFormData,
            count: allGeneratedContents.length,
            multipleVariations: allVariationData.slice(0, allGeneratedContents.length)
          };
          
          displayGeneratedContent(partialContents, partialFormData);
          showSystemMessage(`âš ï¸ éƒ¨åˆ†æˆåŠŸï¼šå·²ç”Ÿæˆ ${allGeneratedContents.length}/${contentCount} ç¯‡å…§å®¹`, 'warning');
        } else {
          showErrorState(error.message);
        }
      } finally {
        STATE.isGenerating = false;
        updateGenerateButton(false);
      }
    }

    // èŠå¤©è™•ç†
    async function handleChatSubmission(e) {
      e.preventDefault();
      
      if (!STATE.isConnected || STATE.isChatting) {
        return;
      }

      const message = elements.chatInput.value.trim();
      if (!message) return;

      STATE.isChatting = true;
      const chatOptions = {
        contentType: document.getElementById('chatContentType').value,
        platform: document.getElementById('chatPlatform').value,
        style: document.getElementById('chatStyle').value,
        tone: document.getElementById('chatTone').value
      };

      appendChatMessage('user', message, chatOptions);
      elements.chatInput.value = '';
      elements.inputCounter.textContent = '0';
      
      const thinkingMsg = appendChatMessage('ai', 'ğŸ¤” æ€è€ƒä¸­...', chatOptions, true);
      updateSendButton(true);

      try {
        const response = await fetchWithRetry(`${STATE.currentServer}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            model: document.getElementById('model').value,
            ...chatOptions,
            history: STATE.chatHistory.slice(-10), // ä¿ç•™æœ€è¿‘10æ¢å°è©±
            // åŠ å…¥å¤šæ¨£æ€§åƒæ•¸é¿å…é‡è¤‡å›æ‡‰
            variationSeed: Date.now() + Math.random(),
            timestamp: new Date().toISOString(),
            requestId: generateRequestId()
          })
        });

        const data = await response.json();
        
        // ç§»é™¤æ€è€ƒä¸­è¨Šæ¯
        thinkingMsg.remove();
        
        if (data && data.reply) {
          appendChatMessage('ai', data.reply, chatOptions);
          STATE.chatHistory.push({ user: message, ai: data.reply });
        } else {
          throw new Error('AIå›å¾©ç‚ºç©º');
        }
      } catch (error) {
        console.error('èŠå¤©éŒ¯èª¤:', error);
        thinkingMsg.remove();
        appendChatMessage('ai', 'âŒ æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›æ‡‰ã€‚è«‹ç¨å¾Œå†è©¦ã€‚', chatOptions);
      } finally {
        STATE.isChatting = false;
        updateSendButton(false);
        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      }
    }

    // å¾¹åº•ä¿®å¾©è¶…æ™‚å•é¡Œ - ä½¿ç”¨ Promise.race é¿å… AbortController å•é¡Œ
    async function fetchWithRetry(url, options, retries = API_CONFIG.retryAttempts) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`ğŸ”„ å˜—è©¦ ${i + 1}/${retries}: ${url}`);
          console.log(`â° è¶…æ™‚è¨­å®š: ${API_CONFIG.timeout/1000} ç§’`);
          
          // ä½¿ç”¨ Promise.race ä»£æ›¿ AbortController ä¾†é¿å…ç€è¦½å™¨ç›¸å®¹æ€§å•é¡Œ
          const fetchPromise = fetch(url, options);
          
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error(`è«‹æ±‚è¶…æ™‚ (è¶…é ${API_CONFIG.timeout/1000} ç§’)ï¼ŒAIå…§å®¹ç”Ÿæˆéœ€è¦è¼ƒé•·æ™‚é–“`));
            }, API_CONFIG.timeout);
          });

          console.log(`ğŸŒ ç™¼é€è«‹æ±‚ä¸­...`);
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          console.log(`âœ… è«‹æ±‚æˆåŠŸ: ${response.status} ${response.statusText}`);
          return response;
          
        } catch (error) {
          console.log(`âŒ å˜—è©¦ ${i + 1} å¤±æ•—:`, error.message);
          console.log(`ğŸ” éŒ¯èª¤é¡å‹:`, error.name);
          console.log(`ğŸ“Š éŒ¯èª¤å †ç–Š:`, error.stack);
          
          // æ¨™æº–åŒ–éŒ¯èª¤è¨Šæ¯
          if (error.message.includes('è¶…æ™‚') || error.message.includes('timeout')) {
            error.message = `ğŸ• AIç”Ÿæˆè¶…æ™‚ï¼šå…§å®¹ç”Ÿæˆé€šå¸¸éœ€è¦1-2åˆ†é˜ï¼Œè«‹æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°ç¢ºèªæ˜¯å¦å·²ç”ŸæˆæˆåŠŸ`;
            error.isTimeout = true;
          }
          
          if (i === retries - 1) {
            console.log(`ğŸ’€ æ‰€æœ‰å˜—è©¦å¤±æ•—ï¼Œæœ€çµ‚éŒ¯èª¤:`, error.message);
            throw error;
          }
          
          const delay = 1000 * (i + 1); // éå¢å»¶é²ï¼š1ç§’ã€2ç§’
          console.log(`â³ ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // UI æ›´æ–°å‡½æ•¸
    function updateGenerateButton(isLoading) {
      elements.generateBtn.disabled = isLoading;
      elements.generateBtn.innerHTML = isLoading ? 
        '<span class="loading">â³ ç”Ÿæˆä¸­...</span>' : 
        'ğŸš€ ç”¢ç”Ÿå…§å®¹';
    }

    function updateSendButton(isLoading) {
      elements.sendBtn.disabled = isLoading;
      elements.sendBtn.innerHTML = isLoading ? 
        '<span class="loading">â³</span>' : 
        'ğŸ“¤ é€å‡º';
    }

    function showLoadingState() {
      elements.contentResult.innerHTML = `
        <div class="flex items-center justify-center p-8 bg-blue-50 rounded-lg">
          <div class="text-center">
            <div class="loading text-2xl mb-2">ğŸ¤–</div>
            <div class="text-blue-600 font-medium">AIæ­£åœ¨å‰µä½œå¤šæ¨£åŒ–å…§å®¹...</div>
            <div class="text-sm text-gray-500 mt-1">é€šå¸¸éœ€è¦ 1-2 åˆ†é˜ï¼Œè«‹è€å¿ƒç­‰å¾…</div>
            <div class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded mt-2">
              ğŸ¯ å·²åŠ å…¥å¤šæ¨£æ€§æ©Ÿåˆ¶ï¼Œç¢ºä¿æ¯ç¯‡å…§å®¹éƒ½ä¸ç›¸åŒ
            </div>
            <div class="text-xs text-blue-500 mt-2">ğŸ’¡ æ‚¨å¯ä»¥æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°äº†è§£ç”Ÿæˆé€²åº¦</div>
          </div>
        </div>
      `;
    }

    // å¾ªåºæ¼¸é€²è¼‰å…¥ç‹€æ…‹é¡¯ç¤º
    function showProgressiveLoadingState(current, total) {
      elements.contentResult.innerHTML = `
        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-500">
          <div class="text-center mb-4">
            <div class="loading text-2xl mb-2">ğŸ¯</div>
            <div class="text-blue-700 font-semibold text-lg">å¾ªåºæ¼¸é€²å…§å®¹ç”Ÿæˆ</div>
            <div class="text-blue-600 text-sm mt-1">åè¦†è™•ç†æ©Ÿåˆ¶ - ç¢ºä¿æ¯ç¯‡å…§å®¹å®Œå…¨ä¸åŒ</div>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm text-blue-700 mb-2">
              <span>é€²åº¦</span>
              <span>${current}/${total} ç¯‡</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-3">
              <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" 
                   style="width: ${(current / total) * 100}%"></div>
            </div>
          </div>
          
          <div class="text-xs text-gray-600 bg-white p-3 rounded">
            <div class="font-medium mb-2">ğŸ”§ æŠ€è¡“ç‰¹è‰²ï¼š</div>
            <ul class="space-y-1">
              <li>â€¢ ç”Ÿæˆä¸€ç¯‡ â†’ æ·±åº¦åˆ†æ â†’ èª¿æ•´ç­–ç•¥ â†’ ç”Ÿæˆä¸‹ä¸€ç¯‡</li>
              <li>â€¢ æ¯ç¯‡å…§å®¹éƒ½åŸºæ–¼å‰é¢çš„åˆ†æçµæœé¿å…é‡è¤‡</li>
              <li>â€¢ Jabç†è«–è‡ªé©æ‡‰æ‡‰ç”¨ï¼Œç¢ºä¿åƒ¹å€¼å°å‘å·®ç•°åŒ–</li>
              <li>â€¢ å¹³å°åŸç”Ÿé¢¨æ ¼å‹•æ…‹èª¿æ•´</li>
            </ul>
          </div>
        </div>
      `;
    }

    // æ›´æ–°å¾ªåºæ¼¸é€²è¼‰å…¥ç‹€æ…‹
    function updateProgressiveLoadingState(current, total, variation) {
      const progressContainer = elements.contentResult.querySelector('.bg-gradient-to-r');
      if (!progressContainer) return;
      
      // æ›´æ–°é€²åº¦æ¢
      const progressBar = progressContainer.querySelector('.bg-blue-600');
      if (progressBar) {
        progressBar.style.width = `${((current + 1) / total) * 100}%`;
      }
      
      // æ›´æ–°é€²åº¦æ–‡å­—
      const progressText = progressContainer.querySelector('.flex.justify-between span:last-child');
      if (progressText) {
        progressText.textContent = `${current + 1}/${total} ç¯‡`;
      }
      
      // æ·»åŠ ç•¶å‰ç”Ÿæˆç‹€æ…‹
      const statusDiv = progressContainer.querySelector('.text-xs.text-gray-600.bg-white');
      if (statusDiv && variation) {
        statusDiv.innerHTML = `
          <div class="font-medium mb-2">ğŸ”§ ç›®å‰ç”Ÿæˆç¬¬ ${current + 1} ç¯‡ï¼š</div>
          <ul class="space-y-1 text-xs">
            <li>â€¢ Jabç­–ç•¥: ${variation.jabStrategy}</li>
            <li>â€¢ çµæ§‹æ¡†æ¶: ${variation.structuralFramework}</li>
            <li>â€¢ å·®ç•°åŒ–é‡é»: ${variation.differentiationFocus}</li>
            <li>â€¢ é¿å…é‡è¤‡: ${variation.avoidanceMeasures}</li>
          </ul>
        `;
      }
    }

         function showErrorState(errorMsg) {
       console.log('ğŸš¨ é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹:', errorMsg);
       
       const isApiError = errorMsg.includes('401') || errorMsg.includes('Unauthorized');
       const isTimeoutError = errorMsg.includes('è¶…æ™‚') || errorMsg.includes('timeout') || errorMsg.includes('AbortError') || errorMsg.includes('AIç”Ÿæˆè¶…æ™‚');
       const isServerError = errorMsg.includes('500') || errorMsg.includes('Internal Server Error');
       
       let errorTitle = 'å…§å®¹ç”Ÿæˆå¤±æ•—';
       let errorIcon = 'âŒ';
       
       if (isApiError) {
         errorTitle = 'API é‡‘é‘°å•é¡Œ';
         errorIcon = 'ğŸ”‘';
       } else if (isTimeoutError) {
         errorTitle = 'è«‹æ±‚è¶…æ™‚';
         errorIcon = 'â°';
       } else if (isServerError) {
         errorTitle = 'ä¼ºæœå™¨éŒ¯èª¤';
         errorIcon = 'ğŸš§';
       }
       
       elements.contentResult.innerHTML = `
         <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
           <div class="flex items-center mb-3">
             <span class="text-red-500 text-xl mr-2">${errorIcon}</span>
             <span class="font-medium text-red-700">${errorTitle}</span>
           </div>
           <div class="text-red-600 text-sm mb-4">${errorMsg}</div>
           
           ${isTimeoutError ? `
             <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
               <h4 class="font-medium text-blue-800 mb-2">â° è¶…æ™‚å•é¡Œè§£æ±ºæ–¹æ¡ˆ</h4>
               <ul class="text-sm text-blue-700 space-y-1 mb-3">
                 <li>â€¢ AI å…§å®¹ç”Ÿæˆéœ€è¦è¼ƒé•·æ™‚é–“ï¼Œé€™æ˜¯æ­£å¸¸ç¾è±¡</li>
                 <li>â€¢ ä¼ºæœå™¨æ—¥èªŒé¡¯ç¤ºå…§å®¹å·²æˆåŠŸç”Ÿæˆï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°</li>
                 <li>â€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢ä¸¦é‡æ–°ç”Ÿæˆ</li>
                 <li>â€¢ è€ƒæ…®æ¸›å°‘ç”Ÿæˆæ•¸é‡ï¼ˆä¾‹ï¼šæ”¹ç‚º1ç¯‡ï¼‰</li>
               </ul>
               <div class="bg-green-100 border border-green-300 rounded p-2 text-xs text-green-700">
                 ğŸ’¡ æç¤ºï¼šå¾ä¼ºæœå™¨æ—¥èªŒçœ‹ï¼Œæ‚¨çš„å…§å®¹å¯èƒ½å·²ç¶“ç”ŸæˆæˆåŠŸï¼è«‹æª¢æŸ¥é»‘è‰²æ§åˆ¶å°è¦–çª—çš„æœ€æ–°å…§å®¹ã€‚
               </div>
             </div>
           ` : ''}
           ${isApiError ? `
             <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
               <h4 class="font-medium text-yellow-800 mb-2">ğŸ”‘ éœ€è¦è¨­å®š OpenRouter API é‡‘é‘°</h4>
               <ol class="text-sm text-yellow-700 space-y-1 mb-3">
                 <li>1. å‰å¾€ <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">OpenRouter.ai</a> ç”³è«‹å…è²»APIé‡‘é‘°</li>
                 <li>2. åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å‰µå»º <code class="bg-yellow-100 px-1 rounded">.env</code> æª”æ¡ˆ</li>
                 <li>3. æ·»åŠ : <code class="bg-yellow-100 px-1 rounded">OPENROUTER_API_KEY=æ‚¨çš„é‡‘é‘°</code></li>
                 <li>4. é‡æ–°å•Ÿå‹•ä¼ºæœå™¨</li>
               </ol>
               <button onclick="showApiGuide()" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded text-sm transition mr-2">
                 ğŸ“– è©³ç´°è¨­å®šèªªæ˜
               </button>
             </div>
           ` : ''}
           <div class="space-x-2">
             <button onclick="detectServer()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm transition">
               ğŸ”„ é‡æ–°æª¢æ¸¬ä¼ºæœå™¨
             </button>
             <button onclick="testApiConnection()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition">
               ğŸ§ª æ¸¬è©¦APIé€£ç·š
             </button>
             ${isTimeoutError ? `
               <button onclick="checkServerLogs()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition">
                 ğŸ“‹ æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒ
               </button>
               <button onclick="retryWithReducedCount()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm transition">
                 ğŸ”„ é‡è©¦ï¼ˆ1ç¯‡å…§å®¹ï¼‰
               </button>
             ` : ''}
           </div>
         </div>
       `;
     }

    function displayGeneratedContent(contents, formData) {
      // æ›´è©³ç´°çš„å…§å®¹é¡å‹æ¨™ç±¤
      const contentTypeLabels = {
        'jab': 'Jabï¼ˆçµ¦äºˆåƒ¹å€¼ï¼‰- æ•™è‚²ã€å¨›æ¨‚ã€å•Ÿç™¼',
        'right_hook': 'Right Hookï¼ˆè«‹æ±‚è¡Œå‹•ï¼‰- æ˜ç¢ºCTA',
        'jab_story': 'Jabæ•…äº‹å‹ - æƒ…æ„Ÿé€£çµ',
        'jab_education': 'Jabæ•™è‚²å‹ - çŸ¥è­˜åˆ†äº«',
        'jab_entertainment': 'Jabå¨›æ¨‚å‹ - è¦ªå’ŒåŠ›å»ºç«‹',
        'right_hook_soft': 'Right Hookè»Ÿæ€§ - é–“æ¥å¼•å°',
        'right_hook_direct': 'Right Hookç›´æ¥ - ç«‹å³è¡Œå‹•'
      };
      
      const typeLabel = contentTypeLabels[formData.contentType] || 'Jabåƒ¹å€¼å‹å…§å®¹';
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-500">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-blue-800">ğŸ“‹ Jabç†è«–å…§å®¹ç”Ÿæˆçµæœ</h3>
            <div class="text-sm text-blue-700 bg-blue-100 px-2 py-1 rounded">
              ${contents.length} ç¯‡å…§å®¹ | ${formData.platform}
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 text-sm mb-3">
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">å…§å®¹ç­–ç•¥:</strong> ${typeLabel}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">ä¸»é¡Œ:</strong> ${formData.topic}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">é¢¨æ ¼:</strong> ${formData.style}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">å‰µæ„åº¦:</strong> ${formData.creativity}%
            </div>
          </div>
          
          ${formData.jabTheoryMode === 'advanced' ? `
            <div class="text-xs text-green-700 bg-green-100 px-3 py-2 rounded-lg mb-2">
              ğŸ¯ <strong>Jabç†è«–é€²éšæ¨¡å¼:</strong> æ¯ç¯‡å…§å®¹éƒ½åŸºæ–¼ä¸åŒçš„åƒ¹å€¼çµ¦äºˆç­–ç•¥ï¼Œç¢ºä¿å¤šæ¨£æ€§å’Œå¹³å°åŸç”Ÿæ€§
            </div>
          ` : ''}
          
          ${formData.multipleVariations && formData.multipleVariations.length > 0 ? `
            <div class="text-xs text-purple-700 bg-purple-100 px-3 py-2 rounded-lg mb-2">
              ğŸ”€ <strong>å¼·åŒ–å·®ç•°åŒ–:</strong> ${formData.diversityLevel} | å¹³å°åŸç”Ÿå„ªåŒ–: ${formData.platformNativeOptimization ? 'å•Ÿç”¨' : 'åœç”¨'}
            </div>
            <div class="text-xs text-orange-700 bg-orange-100 px-3 py-2 rounded-lg">
              âš¡ <strong>å“è³ªæ§åˆ¶:</strong> æœ€ä½${formData.qualityRequirements?.minimumLength || 150}å­— | äº’å‹•å…ƒç´ : ${formData.qualityRequirements?.interactionElements || 'å¿…é ˆ'} | Jabåƒ¹å€¼æ¸…æ™°åº¦: ${formData.qualityRequirements?.jabValueClarity || 'é«˜'}
            </div>
          ` : ''}
        </div>
        ${contents.map((content, i) => {
          // ç‚ºæ¯ç¯‡å…§å®¹ç”Ÿæˆç¨ç‰¹çš„è®ŠåŒ–æ¨™ç±¤
          const uniqueVariation = generateContentVariationLabel(i, formData);
          const variation = formData.multipleVariations ? formData.multipleVariations[i] : null;
          
          // æ ¹æ“šå…§å®¹é¡å‹é¸æ“‡é¡è‰²ä¸»é¡Œ
          const isJab = formData.contentType.includes('jab');
          const colorTheme = isJab ? 'green' : 'red';
          const bgGradient = isJab ? 'from-green-50 to-emerald-50' : 'from-red-50 to-pink-50';
          const borderColor = isJab ? 'border-green-400' : 'border-red-400';
          const textColor = isJab ? 'text-green-700' : 'text-red-700';
          
          return `
          <div class="p-6 bg-gradient-to-r ${bgGradient} rounded-lg shadow-md border-l-4 ${borderColor} mb-4">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold ${textColor}">
                ${isJab ? 'ğŸ¥Š' : 'ğŸ’¥'} å…§å®¹ ${i + 1} 
                <span class="text-xs font-normal text-purple-600 bg-white px-2 py-1 rounded ml-2 shadow-sm">
                  ${uniqueVariation}
                </span>
              </div>
              <button onclick="copyToClipboard(this, '${content.replace(/'/g, "\\'")}', ${i})" 
                      class="copy-btn bg-white hover:bg-gray-50 ${textColor} px-3 py-1 rounded text-sm transition shadow-sm border">
                ğŸ“‹ è¤‡è£½
              </button>
            </div>
            
            ${variation && variation.jabTheoryApplication ? `
              <div class="mb-3 p-3 bg-white rounded-lg text-xs border shadow-sm">
                <div class="font-medium text-gray-700 mb-2">ğŸ¯ Jabç†è«–æ‡‰ç”¨åˆ†æï¼š</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div><strong>åƒ¹å€¼é¡å‹:</strong> <span class="text-blue-600">${variation.jabTheoryApplication.valueType}</span></div>
                  <div><strong>å¹³å°æ–¹å¼:</strong> <span class="text-green-600">${variation.jabTheoryApplication.platformApproach}</span></div>
                  <div><strong>æƒ…æ„Ÿé€£çµ:</strong> <span class="text-purple-600">${variation.jabTheoryApplication.emotionalConnection}</span></div>
                  <div><strong>çµæ§‹æ¡†æ¶:</strong> <span class="text-orange-600">${variation.jabTheoryApplication.structuralFramework}</span></div>
                </div>
                ${variation.mandatoryConstraints ? `
                  <div class="mt-2 pt-2 border-t">
                    <strong>å·®ç•°åŒ–è¦æ±‚:</strong> <span class="text-gray-600">${variation.mandatoryConstraints.jabMode}</span> | 
                    <span class="text-gray-600">${variation.mandatoryConstraints.emotionalTone}</span>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${formData.multipleVariations && formData.multipleVariations[i] && formData.multipleVariations[i].transformations ? `
              <div class="mb-3 p-3 bg-yellow-50 rounded-lg text-xs border border-yellow-200">
                <div class="font-medium text-yellow-800 mb-2">ğŸš€ å¼·åˆ¶å·®ç•°åŒ–è½‰æ›è¨˜éŒ„ï¼š</div>
                <div class="text-yellow-700">
                  ${formData.multipleVariations[i].transformations.slice(0, 4).join(' â€¢ ')}
                  ${formData.multipleVariations[i].transformations.length > 4 ? '...' : ''}
                </div>
                <div class="mt-1 text-xs text-green-600">
                  âœ… å…±æ‡‰ç”¨ ${formData.multipleVariations[i].transformations.length} é …è½‰æ›ç¢ºä¿å…§å®¹ç¨ç‰¹æ€§
                </div>
              </div>
            ` : ''}
            
            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap bg-white p-4 rounded-lg border">${content}</div>
            
            <div class="mt-3 pt-3 border-t ${borderColor} text-xs ${textColor}">
              <div class="flex justify-between items-center">
                <div>
                  <strong>é©ç”¨:</strong> ${formData.platform} | 
                  <strong>é¢¨æ ¼:</strong> ${formData.style} | 
                  <strong>é¡å‹:</strong> ${isJab ? 'Jabåƒ¹å€¼çµ¦äºˆ' : 'Right Hookè¡Œå‹•å‘¼ç±²'}
                </div>
                ${variation ? `<div class="text-gray-500">ID: ${variation.uniqueId.substr(-6)}</div>` : ''}
              </div>
              ${variation && variation.jabValueFocus ? `
                <div class="mt-1 text-xs bg-white px-2 py-1 rounded">
                  <strong>åƒ¹å€¼ç„¦é»:</strong> ${variation.jabValueFocus}
                </div>
              ` : ''}
            </div>
          </div>
        `;}).join('')}
        <div class="mt-4 text-center">
          <button onclick="regenerateContent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
            ğŸ”„ é‡æ–°ç”Ÿæˆ
          </button>
          <button onclick="optimizeContent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            âš¡ AIå„ªåŒ–å»ºè­°
          </button>
        </div>
      `;
    }

    function appendChatMessage(role, text, options, isTemporary = false) {
      const div = document.createElement('div');
      div.className = `chat-message ${role === 'user' ? 'text-right' : 'text-left'} ${isTemporary ? 'temporary' : ''}`;
      
      const timeStr = new Date().toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      div.innerHTML = `
        <div class="mb-1 text-xs text-gray-500">
          ${role === 'user' ? 'ğŸ‘¤ æˆ‘' : 'ğŸ¤– AI'} | ${timeStr} | 
          ${options.contentType} | ${options.platform} | ${options.style}
        </div>
        <div class="inline-block ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white border'} 
                  px-4 py-2 rounded-lg max-w-xs lg:max-w-md break-words">
          ${text}
        </div>
      `;
      
      elements.chatWindow.appendChild(div);
      elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      return div;
    }

    function showSystemMessage(message, type = 'info') {
      const colors = {
        success: 'bg-green-100 border-green-400 text-green-700',
        error: 'bg-red-100 border-red-400 text-red-700',
        warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
        info: 'bg-blue-100 border-blue-400 text-blue-700'
      };
      
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-20 right-4 p-3 rounded-lg border z-50 ${colors[type]} shadow-lg`;
      msgDiv.textContent = message;
      
      document.body.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.style.opacity = '0';
        msgDiv.style.transform = 'translateX(100%)';
        setTimeout(() => msgDiv.remove(), 300);
      }, 3000);
    }

    // è‡ªé©æ‡‰è®ŠåŒ–ç”Ÿæˆ - åŸºæ–¼å‰é¢å…§å®¹åˆ†æèª¿æ•´ç­–ç•¥
    async function generateAdaptiveVariation(index, total, previousContents, baseFormData) {
      console.log(`ğŸ§  ç‚ºç¬¬ ${index + 1} ç¯‡ç”Ÿæˆè‡ªé©æ‡‰è®ŠåŒ–ç­–ç•¥`);
      
      // åˆ†æå‰é¢å·²ç”Ÿæˆçš„å…§å®¹ç‰¹å¾µ
      const previousAnalysis = await analyzePreviousContents(previousContents);
      
      // åŸºç¤Jabç­–ç•¥æ± ï¼Œç¢ºä¿æ¯ç¯‡éƒ½ä¸åŒ
      const jabStrategies = [
        'ç´”æ•™è‚²åƒ¹å€¼å‹ - çŸ¥è­˜å‚³éç‚ºä¸»',
        'æƒ…æ„Ÿæ•…äº‹å‹ - å…±é³´é€£çµç‚ºä¸»', 
        'å¯¦ç”¨å·¥å…·å‹ - å…·é«”å¹«åŠ©ç‚ºä¸»',
        'å¨›æ¨‚äº’å‹•å‹ - è¼•é¬†åƒèˆ‡ç‚ºä¸»',
        'å°ˆæ¥­æ¬Šå¨å‹ - æ·±åº¦åˆ†æç‚ºä¸»',
        'è¶¨å‹¢æ´å¯Ÿå‹ - å‰ç»è¦–é‡ç‚ºä¸»',
        'ç¤¾ç¾¤æ­¸å±¬å‹ - ç¤¾å€æ„Ÿç‚ºä¸»',
        'å•é¡Œè§£æ±ºå‹ - æ–¹æ¡ˆå°å‘ç‚ºä¸»'
      ];
      
      // çµæ§‹æ¡†æ¶æ± ï¼Œå¾ªç’°ä½¿ç”¨ç¢ºä¿å·®ç•°
      const structuralFrameworks = [
        'å•é¡Œâ†’åˆ†æâ†’è§£æ–¹â†’å‘¼ç±²',
        'æ•…äº‹â†’æ•™è¨“â†’æ‡‰ç”¨â†’åˆ†äº«',
        'ç¾è±¡â†’åŸå› â†’ç­–ç•¥â†’è¡Œå‹•',
        'æŒ‘æˆ°â†’æ€è€ƒâ†’çªç ´â†’æˆé•·',
        'è§€å¯Ÿâ†’æ´å¯Ÿâ†’å»ºè­°â†’å¯¦è¸',
        'ç–‘å•â†’æ¢ç´¢â†’ç™¼ç¾â†’å•Ÿç™¼',
        'éœ€æ±‚â†’æ–¹æ³•â†’æ•ˆç›Šâ†’æ¨å»£',
        'ç›®æ¨™â†’è·¯å¾‘â†’å¯¦ç¾â†’å»¶ä¼¸'
      ];
      
      // å·®ç•°åŒ–é‡é»ï¼ŒåŸºæ–¼å·²ç”¨éçš„é¿å…é‡è¤‡
      const usedDifferentiationPoints = previousAnalysis.usedDifferentiationPoints || [];
      const availableDifferentiationPoints = [
        'é–‹é ­æ–¹å¼å®Œå…¨ä¸åŒ', 'çµå°¾å‘¼ç±²æ–¹å¼ä¸åŒ', 'èªè¨€é¢¨æ ¼å·®ç•°åŒ–',
        'æƒ…æ„Ÿèª¿æ€§å°æ¯”', 'å…§å®¹é•·åº¦è®ŠåŒ–', 'äº’å‹•å…ƒç´ å·®ç•°',
        'è¡¨æƒ…ç¬¦è™Ÿä½¿ç”¨ä¸åŒ', 'æ®µè½çµæ§‹è®ŠåŒ–', 'å•å¥ä½¿ç”¨å·®ç•°',
        'å€‹äºº/å®¢è§€è¦–è§’åˆ‡æ›', 'æ•¸æ“š/æ„Ÿæ€§å¹³è¡¡èª¿æ•´', 'æ™‚é–“è§€é»å·®ç•°'
      ].filter(point => !usedDifferentiationPoints.includes(point));
      
      // é¿å…é‡è¤‡æªæ–½ï¼ŒåŸºæ–¼å‰é¢å…§å®¹çš„ç‰¹å¾µ
      const avoidanceMeasures = generateAvoidanceMeasures(previousAnalysis, index);
      
      // ç•¶å‰ç¯‡çš„ç¨ç‰¹é…ç½®
      const currentVariation = {
        index: index,
        jabStrategy: jabStrategies[index % jabStrategies.length],
        structuralFramework: structuralFrameworks[index % structuralFrameworks.length],
        differentiationFocus: availableDifferentiationPoints[0] || `ç¬¬${index + 1}ç¯‡ç¨ç‰¹ç„¦é»`,
        avoidanceMeasures: avoidanceMeasures,
        
        // Jabç†è«–æ·±åº¦æ‡‰ç”¨
        jabTheoryApplication: {
          valueType: getUniqueValueType(index, previousAnalysis),
          platformApproach: getUniquePlatformApproach(index, baseFormData.platform, previousAnalysis),
          emotionalConnection: getUniqueEmotionalConnection(index, previousAnalysis),
          languageStyle: getUniqueLanguageStyle(index, previousAnalysis)
        },
        
        // ç‰¹æ®Šè¦æ±‚
        specificRequirements: {
          mustDifferFrom: previousContents.map(content => content.content.substring(0, 100)),
          targetLength: 150 + (index * 50), // é•·åº¦éå¢
          uniqueElements: getUniqueElements(index, total),
          platformOptimization: getPlatformOptimization(baseFormData.platform, index)
        },
        
        // å¼·åˆ¶å·®ç•°åŒ–è¦å‰‡
        forcedDifferentiation: {
          structuralPattern: `æ¨¡å¼${index + 1}`,
          tonalDirection: index % 2 === 0 ? 'ç©æ¥µæ­£å‘' : 'æ·±åº¦æ€è€ƒ',
          contentFocus: index < total / 2 ? 'Jabåƒ¹å€¼çµ¦äºˆ' : 'Right Hookè»Ÿæ€§å¼•å°',
          interactionStyle: getInteractionStyle(index)
        }
      };
      
      console.log(`âœ… ç¬¬ ${index + 1} ç¯‡è®ŠåŒ–ç­–ç•¥ç”Ÿæˆå®Œæˆ:`, currentVariation);
      return currentVariation;
    }

    // åˆ†æå‰é¢å·²ç”Ÿæˆçš„å…§å®¹
    async function analyzePreviousContents(previousContents) {
      if (previousContents.length === 0) {
        return {
          usedStrategies: [],
          usedStructures: [],
          usedDifferentiationPoints: [],
          commonPatterns: [],
          suggestionForNext: 'ç¬¬ä¸€ç¯‡å…§å®¹ï¼Œè‡ªç”±ç™¼æ®'
        };
      }
      
      console.log(`ğŸ” åˆ†æå‰é¢ ${previousContents.length} ç¯‡å…§å®¹ç‰¹å¾µ`);
      
      const analysis = {
        usedStrategies: previousContents.map(content => content.variation?.jabStrategy || ''),
        usedStructures: previousContents.map(content => content.variation?.structuralFramework || ''),
        usedDifferentiationPoints: previousContents.flatMap(content => 
          content.variation?.differentiationFocus ? [content.variation.differentiationFocus] : []
        ),
        contentLengths: previousContents.map(content => content.content.length),
        openingStyles: previousContents.map(content => analyzeOpeningStyle(content.content)),
        closingStyles: previousContents.map(content => analyzeClosingStyle(content.content)),
        commonPatterns: identifyCommonPatterns(previousContents),
        suggestionForNext: generateSuggestionForNext(previousContents)
      };
      
      console.log('ğŸ“Š å‰é¢å…§å®¹åˆ†æçµæœ:', analysis);
      return analysis;
    }

    // ç”Ÿæˆé¿å…é‡è¤‡çš„æªæ–½
    function generateAvoidanceMeasures(previousAnalysis, currentIndex) {
      const measures = [];
      
      if (previousAnalysis.openingStyles && previousAnalysis.openingStyles.length > 0) {
        const usedOpenings = previousAnalysis.openingStyles.join('ã€');
        measures.push(`é–‹é ­é¿å…ä½¿ç”¨: ${usedOpenings}`);
      }
      
      if (previousAnalysis.contentLengths && previousAnalysis.contentLengths.length > 0) {
        const avgLength = previousAnalysis.contentLengths.reduce((a, b) => a + b, 0) / previousAnalysis.contentLengths.length;
        const targetLength = currentIndex % 2 === 0 ? avgLength + 100 : avgLength - 50;
        measures.push(`ç›®æ¨™é•·åº¦: ${Math.max(150, targetLength)} å­—`);
      }
      
      if (previousAnalysis.commonPatterns && previousAnalysis.commonPatterns.length > 0) {
        measures.push(`é¿å…æ¨¡å¼: ${previousAnalysis.commonPatterns[0]}`);
      }
      
      measures.push(`å¼·åˆ¶å·®ç•°åŒ–ç¬¬ ${currentIndex + 1} ç¯‡`);
      
      return measures.join(' | ');
    }

    // å¾ªåºæ¼¸é€²å…§å®¹é¡¯ç¤º
    function displayProgressiveContent(generatedContents, baseFormData) {
      const contentHtml = generatedContents.map((item, i) => {
        const variation = item.variation;
        const transformations = item.transformations || [];
        const isJab = baseFormData.contentType.includes('jab');
        const colorTheme = isJab ? 'green' : 'red';
        const bgGradient = isJab ? 'from-green-50 to-emerald-50' : 'from-red-50 to-pink-50';
        const borderColor = isJab ? 'border-green-400' : 'border-red-400';
        const textColor = isJab ? 'text-green-700' : 'text-red-700';
        
        return `
          <div class="p-4 bg-gradient-to-r ${bgGradient} rounded-lg shadow-sm border-l-4 ${borderColor} mb-3">
            <div class="flex justify-between items-center mb-2">
              <div class="font-medium ${textColor}">
                ${isJab ? 'ğŸ¥Š' : 'ğŸ’¥'} å…§å®¹ ${i + 1} 
                <span class="text-xs bg-white px-2 py-1 rounded ml-2 shadow-sm">
                  ${variation.jabStrategy}
                </span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">
                  ğŸ”§ ${transformations.length}é …è½‰æ›
                </span>
                <span class="text-xs text-gray-500">${item.generatedAt.substring(11, 19)}</span>
              </div>
            </div>
            
            ${transformations.length > 0 ? `
              <div class="mb-2 p-2 bg-white rounded text-xs">
                <div class="font-medium text-gray-700 mb-1">ğŸš€ å¼·åˆ¶å·®ç•°åŒ–è½‰æ›ï¼š</div>
                <div class="text-gray-600">${transformations.slice(0, 3).join(' | ')}${transformations.length > 3 ? '...' : ''}</div>
              </div>
            ` : ''}
            
            <div class="text-gray-800 text-sm bg-white p-3 rounded mb-2 leading-relaxed whitespace-pre-line">${item.content}</div>
            
            <div class="text-xs ${textColor}">
              <strong>ç­–ç•¥:</strong> ${variation.structuralFramework} | 
              <strong>å·®ç•°åŒ–:</strong> ${variation.differentiationFocus}
            </div>
          </div>
        `;
      }).join('');
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <h3 class="font-semibold text-blue-700 mb-2">ğŸ¯ å¼·åˆ¶å·®ç•°åŒ–ç”Ÿæˆé€²åº¦</h3>
          <div class="text-sm text-blue-600 mb-2">
            å·²å®Œæˆ: ${generatedContents.length} ç¯‡ | æ¯ç¯‡éƒ½ç¶“é7å±¤å·®ç•°åŒ–è½‰æ›è™•ç†
          </div>
          <div class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">
            âœ… çµæ§‹è½‰æ› âœ… èªè¨€é¢¨æ ¼ âœ… ç¤¾äº¤æ ¼å¼ âœ… é–‹é ­çµå°¾ âœ… è¦–è¦ºå…ƒç´  âœ… äº’å‹•è¨­è¨ˆ âœ… ç›¸ä¼¼åº¦æª¢æŸ¥
          </div>
        </div>
        ${contentHtml}
      `;
    }

    // è¼”åŠ©å‡½æ•¸
    function analyzeOpeningStyle(content) {
      if (content.startsWith('ä½ æ˜¯å¦')) return 'ç–‘å•é–‹å ´';
      if (content.includes('æƒ³åƒä¸€ä¸‹') || content.includes('å‡è¨­')) return 'æƒ…å¢ƒé–‹å ´';
      if (content.match(/^\d+/)) return 'æ•¸æ“šé–‹å ´';
      if (content.includes('ğŸ’¡') || content.includes('ğŸ¤”')) return 'è¡¨æƒ…é–‹å ´';
      return 'ä¸€èˆ¬é–‹å ´';
    }
    
    function analyzeClosingStyle(content) {
      if (content.includes('ä½ è¦ºå¾—') || content.includes('ä½ èªç‚º')) return 'æå•çµå°¾';
      if (content.includes('ç«‹å³') || content.includes('é¦¬ä¸Š')) return 'è¡Œå‹•çµå°¾';
      if (content.includes('åˆ†äº«') || content.includes('ç•™è¨€')) return 'äº’å‹•çµå°¾';
      return 'ä¸€èˆ¬çµå°¾';
    }
    
    function identifyCommonPatterns(contents) {
      // ç°¡åŒ–çš„æ¨¡å¼è­˜åˆ¥
      return ['é‡è¤‡è¡¨æƒ…ç¬¦è™Ÿ', 'ç›¸ä¼¼çµæ§‹', 'é¡ä¼¼èªèª¿'];
    }
    
    function generateSuggestionForNext(contents) {
      return `å»ºè­°ä¸‹ä¸€ç¯‡æ¡ç”¨èˆ‡å‰${contents.length}ç¯‡å®Œå…¨ä¸åŒçš„é¢¨æ ¼`;
    }
    
    function getUniqueValueType(index, analysis) {
      const types = ['æ•™è‚²å•Ÿç™¼', 'æƒ…æ„Ÿå…±é³´', 'å¯¦ç”¨æŒ‡å°', 'å¨›æ¨‚äº’å‹•', 'å°ˆæ¥­æ¬Šå¨', 'è¶¨å‹¢æ´å¯Ÿ'];
      return types[index % types.length];
    }
    
    function getUniquePlatformApproach(index, platform, analysis) {
      const approaches = {
        'Facebook': ['å°è©±å¼', 'æ•…äº‹æ€§', 'åˆ†äº«å¼', 'è¨è«–å¼'],
        'Instagram': ['è¦–è¦ºåŒ–', 'åˆ†æ®µå¼', 'hashtagå¼', 'ç¾å­¸å¼'],
        'LinkedIn': ['å°ˆæ¥­å¼', 'æ•¸æ“šå¼', 'æ´å¯Ÿå¼', 'å»ºè­°å¼']
      };
      const platformApproaches = approaches[platform] || ['é€šç”¨å¼', 'é©æ‡‰å¼', 'åŸç”Ÿå¼', 'å‰µæ–°å¼'];
      return platformApproaches[index % platformApproaches.length];
    }
    
    function getUniqueEmotionalConnection(index, analysis) {
      const connections = ['åŒç†å…±é³´', 'æ¿€å‹µé¼“èˆ', 'æº«æš–é™ªä¼´', 'æŒ‘æˆ°æ€è€ƒ', 'å®‰å…¨æ„Ÿæä¾›', 'æˆå°±æ„Ÿæ¿€ç™¼'];
      return connections[index % connections.length];
    }
    
    function getUniqueLanguageStyle(index, analysis) {
      const styles = ['è¦ªåˆ‡å°è©±', 'å°ˆæ¥­æŒ‡å°', 'æº«æš–åˆ†äº«', 'ç†æ€§åˆ†æ', 'æ„Ÿæ€§è¡¨é”', 'å¹½é»˜è¼•é¬†'];
      return styles[index % styles.length];
    }
    
    function getUniqueElements(index, total) {
      return {
        emojiLevel: index % 3 === 0 ? 'è±å¯Œ' : index % 3 === 1 ? 'é©ä¸­' : 'ç°¡ç´„',
        questionCount: index % 2 + 1,
        paragraphCount: index % 3 + 2,
        callToAction: index >= total / 2 ? 'åŒ…å«' : 'ä¸åŒ…å«'
      };
    }
    
    function getPlatformOptimization(platform, index) {
      return {
        Facebook: index % 2 === 0 ? 'å°è©±äº’å‹•å„ªåŒ–' : 'åˆ†äº«æ“´æ•£å„ªåŒ–',
        Instagram: index % 2 === 0 ? 'è¦–è¦ºå¸å¼•å„ªåŒ–' : 'hashtagç­–ç•¥å„ªåŒ–',
        LinkedIn: index % 2 === 0 ? 'å°ˆæ¥­åƒ¹å€¼å„ªåŒ–' : 'è·å ´æ´å¯Ÿå„ªåŒ–'
      }[platform] || 'é€šç”¨å„ªåŒ–';
    }
    
    function getInteractionStyle(index) {
      const styles = ['é–‹æ”¾è¨è«–', 'ç›´æ¥æå•', 'åˆ†äº«é‚€è«‹', 'åæ€å¼•å°', 'è¡Œå‹•é¼“å‹µ'];
      return styles[index % styles.length];
    }

    // ğŸš€ å¼·åˆ¶å…§å®¹å·®ç•°åŒ–ç³»çµ± - ç¢ºä¿æ¯ç¯‡æ–‡ç« å®Œå…¨ä¸åŒ
    async function forceContentDifferentiation(rawContent, previousContents, currentVariation, index, baseFormData) {
      console.log(`ğŸ”§ é–‹å§‹å¼·åˆ¶å·®ç•°åŒ–ç¬¬ ${index + 1} ç¯‡å…§å®¹`);
      
      let processedContent = rawContent;
      const transformations = [];
      
      // 1. çµæ§‹æ€§è½‰æ› - åŸºæ–¼ç´¢å¼•æ‡‰ç”¨ä¸åŒçš„çµæ§‹
      processedContent = applyStructuralTransformation(processedContent, index, transformations);
      
      // 2. èªè¨€é¢¨æ ¼è½‰æ›
      processedContent = applyLanguageStyleTransformation(processedContent, index, transformations);
      
      // 3. ç¤¾äº¤åª’é«”æ ¼å¼å„ªåŒ–
      processedContent = applySocialMediaFormatting(processedContent, baseFormData.platform, index, transformations);
      
      // 4. é–‹é ­çµå°¾å¼·åˆ¶å·®ç•°åŒ–
      processedContent = applyOpeningClosingDifferentiation(processedContent, index, transformations);
      
      // 5. è¡¨æƒ…ç¬¦è™Ÿå’Œè¦–è¦ºå…ƒç´ å·®ç•°åŒ–
      processedContent = applyVisualElementDifferentiation(processedContent, index, transformations);
      
      // 6. äº’å‹•å…ƒç´ å·®ç•°åŒ–
      processedContent = applyInteractionDifferentiation(processedContent, index, transformations);
      
      // 7. æª¢æŸ¥èˆ‡å‰é¢å…§å®¹çš„ç›¸ä¼¼åº¦ä¸¦é€²ä¸€æ­¥èª¿æ•´
      if (previousContents.length > 0) {
        processedContent = await avoidSimilarityWithPrevious(processedContent, previousContents, index, transformations);
      }
      
      console.log(`âœ… ç¬¬ ${index + 1} ç¯‡å·®ç•°åŒ–å®Œæˆï¼Œæ‡‰ç”¨äº† ${transformations.length} é …è½‰æ›`);
      
      return {
        content: processedContent,
        transformations: transformations
      };
    }

    // çµæ§‹æ€§è½‰æ›
    function applyStructuralTransformation(content, index, transformations) {
      const structures = [
        {
          name: 'å•é¡Œè§£æ±ºå‹',
          apply: (text) => {
            // å°‡å…§å®¹é‡æ–°çµ„ç¹”ç‚ºï¼šå•é¡Œæå‡º â†’ åˆ†æ â†’ è§£æ±ºæ–¹æ¡ˆ â†’ è¡Œå‹•å»ºè­°
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim());
            if (sentences.length >= 4) {
              return `ğŸ¤” ${sentences[0]}ï¼Ÿ\n\nğŸ’­ ${sentences[1]}ã€‚\n\nğŸ’¡ ${sentences[2]}ã€‚\n\nğŸš€ ${sentences.slice(3).join('ã€‚')}ï¼`;
            }
            return `ğŸ¤” ä½ æ˜¯å¦ä¹Ÿé‡åˆ°é€™æ¨£çš„å›°æ“¾ï¼Ÿ\n\n${text}\n\nğŸ’ª ä¸€èµ·ä¾†è§£æ±ºé€™å€‹å•é¡Œå§ï¼`;
          }
        },
        {
          name: 'æ•…äº‹æ•˜è¿°å‹',
          apply: (text) => {
            // å°‡å…§å®¹åŒ…è£æˆæ•…äº‹å½¢å¼
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim());
            return `ğŸ“– åˆ†äº«ä¸€å€‹çœŸå¯¦çš„æ•…äº‹...\n\n${sentences[0]}ã€‚æƒ³åƒä¸€ä¸‹ï¼Œ${sentences.slice(1).join('ã€‚')}\n\nâœ¨ é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦æ”¹è®Šçš„åŸå› ã€‚`;
          }
        },
        {
          name: 'å°æ¯”åˆ†æå‹',
          apply: (text) => {
            // å‰µå»ºå°æ¯”çµæ§‹
            const mid = Math.floor(text.length / 2);
            const part1 = text.substring(0, mid);
            const part2 = text.substring(mid);
            return `âš–ï¸ è®“æˆ‘å€‘ä¾†çœ‹å…©å€‹ä¸åŒçš„è§’åº¦ï¼š\n\nâŒ éå»çš„åšæ³•ï¼š\n${part1}\n\nâœ… æ›´å¥½çš„æ–¹å¼ï¼š\n${part2}\n\nä½ æœƒé¸æ“‡å“ªä¸€ç¨®ï¼Ÿ`;
          }
        },
        {
          name: 'åˆ—è¡¨æŒ‡å—å‹',
          apply: (text) => {
            // è½‰æ›ç‚ºæ­¥é©Ÿåˆ—è¡¨
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim());
            const steps = sentences.slice(0, Math.min(5, sentences.length));
            return `ğŸ“‹ å®Œæ•´æŒ‡å—ä¾†äº†ï¼š\n\n${steps.map((step, i) => `${i + 1}ï¸âƒ£ ${step}`).join('\n\n')}\n\nğŸ’¡ ç…§è‘—åšï¼Œä½ ä¹Ÿèƒ½åšåˆ°ï¼`;
          }
        },
        {
          name: 'åæ€å•Ÿç™¼å‹',
          apply: (text) => {
            // è½‰æ›ç‚ºåæ€æ€§å…§å®¹
            return `ğŸ¤² åœä¸‹ä¾†æƒ³ä¸€æƒ³...\n\n${text}\n\nğŸŒŸ ä¹Ÿè¨±ï¼ŒçœŸæ­£çš„æ”¹è®Šå°±å¾é€™å€‹æƒ³æ³•é–‹å§‹ã€‚\n\nä½ æº–å‚™å¥½äº†å—ï¼Ÿ`;
          }
        }
      ];
      
      const structure = structures[index % structures.length];
      const transformedContent = structure.apply(content);
      transformations.push(`çµæ§‹è½‰æ›: ${structure.name}`);
      
      return transformedContent;
    }

    // èªè¨€é¢¨æ ¼è½‰æ›
    function applyLanguageStyleTransformation(content, index, transformations) {
      const styles = [
        {
          name: 'è¦ªåˆ‡å°è©±é¢¨',
          apply: (text) => text.replace(/ä½ /g, 'ä½ ').replace(/ã€‚/g, 'ï½').replace(/ï¼/g, 'ï¼ğŸ˜Š')
        },
        {
          name: 'å°ˆæ¥­æ¬Šå¨é¢¨',
          apply: (text) => text.replace(/æˆ‘è¦ºå¾—/g, 'æ ¹æ“šç ”ç©¶é¡¯ç¤º').replace(/å¯èƒ½/g, 'å¿…ç„¶').replace(/ã€‚/g, 'ã€‚')
        },
        {
          name: 'æ¿€å‹µé¼“èˆé¢¨',
          apply: (text) => text.replace(/å¯ä»¥/g, 'ä¸€å®šå¯ä»¥').replace(/å˜—è©¦/g, 'å‹‡æ•¢è¡Œå‹•').replace(/ã€‚/g, 'ï¼ğŸ’ª')
        },
        {
          name: 'æº«æš–åˆ†äº«é¢¨',
          apply: (text) => `â¤ï¸ ${text}`.replace(/ã€‚/g, 'ã€‚ğŸŒŸ').replace(/å•é¡Œ/g, 'æŒ‘æˆ°')
        },
        {
          name: 'å¹½é»˜è¼•é¬†é¢¨',
          apply: (text) => text.replace(/å¾ˆé‡è¦/g, 'è¶…é‡è¦').replace(/éœ€è¦/g, 'å¿…é ˆ').replace(/ã€‚/g, 'å•¦ï¼ğŸ˜„')
        }
      ];
      
      const style = styles[index % styles.length];
      const transformedContent = style.apply(content);
      transformations.push(`èªè¨€é¢¨æ ¼: ${style.name}`);
      
      return transformedContent;
    }

    // ç¤¾äº¤åª’é«”æ ¼å¼å„ªåŒ–
    function applySocialMediaFormatting(content, platform, index, transformations) {
      const formats = {
        'Facebook': [
          (text) => {
            // Facebookæ ¼å¼ï¼šçŸ­æ®µè½ + è¡¨æƒ…ç¬¦è™Ÿ
            const paragraphs = text.split('\n\n');
            return paragraphs.map(p => p.length > 100 ? 
              p.split('ã€‚').join('ã€‚\n') : p
            ).join('\n\n');
          },
          (text) => {
            // Facebookæ ¼å¼ï¼šå°è©±å¼
            return `å—¨æœ‹å‹å€‘ï¼ğŸ‘‹\n\n${text}\n\nä½ å€‘æœ‰ä»€éº¼æƒ³æ³•å—ï¼Ÿç•™è¨€è·Ÿæˆ‘åˆ†äº«ï¼ ğŸ’¬`;
          }
        ],
        'Instagram': [
          (text) => {
            // Instagramæ ¼å¼ï¼šçŸ­è¡Œ + hashtag
            return text.split('ã€‚').join('ã€‚\nãƒ»\n').replace(/\n\n/g, '\n\nğŸ“· ') + '\n\n#ç”Ÿæ´»åˆ†äº« #æ­£èƒ½é‡ #æˆé•· #æ—¥å¸¸';
          },
          (text) => {
            // Instagramè¦–è¦ºåŒ–æ ¼å¼
            return `âœ¨ ${text.split('ã€‚')[0]}ã€‚\n\nğŸ“¸ ${text.split('ã€‚').slice(1).join('ã€‚')}\n\nğŸ’« è¨˜å¾—é»è®šå‘Šè¨´æˆ‘ä½ å–œæ­¡ï¼`;
          }
        ],
        'LinkedIn': [
          (text) => {
            // LinkedInå°ˆæ¥­æ ¼å¼
            return `ğŸ’¼ è·å ´åˆ†äº«ï¼š\n\n${text}\n\nğŸ”— ä½ åœ¨è·å ´ä¸Šæœ‰é¡ä¼¼ç¶“é©—å—ï¼Ÿæ­¡è¿åœ¨è©•è«–å€åˆ†äº«ä½ çš„çœ‹æ³•ã€‚`;
          },
          (text) => {
            // LinkedInæ´å¯Ÿæ ¼å¼
            return `ğŸ¯ æ·±åº¦è§€å¯Ÿï¼š\n\n${text}\n\nğŸ“Š é€™æ˜¯æˆ‘åœ¨å¤šå¹´å·¥ä½œä¸­è§€å¯Ÿåˆ°çš„ç¾è±¡ï¼Œä½ èªç‚ºå¦‚ä½•ï¼Ÿ`;
          }
        ]
      };
      
      const platformFormats = formats[platform] || formats['Facebook'];
      const formatFunction = platformFormats[index % platformFormats.length];
      const transformedContent = formatFunction(content);
      transformations.push(`${platform}å¹³å°æ ¼å¼åŒ–`);
      
      return transformedContent;
    }

    // é–‹é ­çµå°¾å·®ç•°åŒ–
    function applyOpeningClosingDifferentiation(content, index, transformations) {
      const openings = [
        'ğŸŒ… æ—©å®‰ï¼ä»Šå¤©æƒ³è·Ÿå¤§å®¶åˆ†äº«...',
        'ğŸ’­ çªç„¶æƒ³åˆ°ä¸€å€‹é‡è¦çš„äº‹æƒ…...',
        'ğŸ“š æœ€è¿‘å­¸åˆ°ä¸€å€‹å¾ˆæ£’çš„æ¦‚å¿µ...',
        'ğŸ¯ æœ‰å€‹å•é¡Œä¸€ç›´åœ¨æˆ‘å¿ƒä¸­...',
        'âœ¨ å‰›å‰›ç¶“æ­·äº†ä¸€ä»¶å¾ˆæœ‰æ„æ€çš„äº‹...'
      ];
      
      const closings = [
        '\n\nğŸ’¬ ä½ æœ‰ä»€éº¼æƒ³æ³•ï¼Ÿç•™è¨€è·Ÿæˆ‘èªªï¼',
        '\n\nğŸŒŸ å¸Œæœ›å°ä½ æœ‰å¹«åŠ©ï¼Œè¨˜å¾—åˆ†äº«çµ¦éœ€è¦çš„æœ‹å‹ï¼',
        '\n\nğŸ¤” ä½ æœƒæ€éº¼åšï¼Ÿæˆ‘å¾ˆå¥½å¥‡å¤§å®¶çš„æƒ³æ³•ï¼',
        '\n\nğŸ’ª ä¸€èµ·åŠªåŠ›ï¼Œä¸€èµ·æˆé•·ï¼',
        '\n\nğŸ“© æœ‰å•é¡Œå¯ä»¥ç§è¨Šæˆ‘ï¼Œå¾ˆæ¨‚æ„èŠèŠï¼'
      ];
      
      // ç§»é™¤åŸæœ‰çš„é–‹é ­çµå°¾ï¼Œæ·»åŠ æ–°çš„
      let processedContent = content.trim();
      
      // æ·»åŠ ç¨ç‰¹é–‹é ­
      const opening = openings[index % openings.length];
      processedContent = `${opening}\n\n${processedContent}`;
      
      // æ·»åŠ ç¨ç‰¹çµå°¾
      const closing = closings[index % closings.length];
      processedContent = processedContent + closing;
      
      transformations.push(`é–‹é ­çµå°¾å·®ç•°åŒ–`);
      
      return processedContent;
    }

    // è¡¨æƒ…ç¬¦è™Ÿå’Œè¦–è¦ºå…ƒç´ å·®ç•°åŒ–
    function applyVisualElementDifferentiation(content, index, transformations) {
      const emojiSets = [
        ['ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'â­', 'ğŸŒˆ'], // é–ƒäº®ç³»åˆ—
        ['ğŸ’ª', 'ğŸš€', 'ğŸ¯', 'âš¡', 'ğŸ”¥'], // åŠ›é‡ç³»åˆ—
        ['â¤ï¸', 'ğŸŒ¸', 'ğŸŒº', 'ğŸ’', 'ğŸŒ¹'], // æº«æš–ç³»åˆ—
        ['ğŸ“š', 'ğŸ’¡', 'ğŸ§ ', 'ğŸ“–', 'âœï¸'], // å­¸ç¿’ç³»åˆ—
        ['ğŸ‰', 'ğŸŠ', 'ğŸ¥³', 'ğŸˆ', 'ğŸ']  // æ…¶ç¥ç³»åˆ—
      ];
      
      const emojiSet = emojiSets[index % emojiSets.length];
      let processedContent = content;
      
      // éš¨æ©Ÿæ’å…¥ä¸åŒçš„è¡¨æƒ…ç¬¦è™Ÿ
      const sentences = processedContent.split('ã€‚');
      processedContent = sentences.map((sentence, i) => {
        if (sentence.trim() && i < emojiSet.length) {
          return sentence + 'ã€‚ ' + emojiSet[i % emojiSet.length];
        }
        return sentence + (sentence.trim() ? 'ã€‚' : '');
      }).join(' ');
      
      transformations.push(`è¦–è¦ºå…ƒç´ : ${emojiSet.join('')}`);
      
      return processedContent;
    }

    // äº’å‹•å…ƒç´ å·®ç•°åŒ–
    function applyInteractionDifferentiation(content, index, transformations) {
      const interactions = [
        (text) => text + '\n\nğŸ—³ï¸ æŠ•ç¥¨ï¼šä½ åŒæ„é€™å€‹è§€é»å—ï¼Ÿ\nğŸ‘ åŒæ„ | ğŸ‘ ä¸åŒæ„',
        (text) => text + '\n\nğŸ® å°æŒ‘æˆ°ï¼šè©¦è©¦çœ‹é€™å€‹æ–¹æ³•ï¼Œç„¶å¾Œå›ä¾†è·Ÿæˆ‘åˆ†äº«çµæœï¼',
        (text) => text + '\n\nğŸ“ ä½œæ¥­æ™‚é–“ï¼šåœ¨è©•è«–å¯«ä¸‹ä½ çš„ä¸‰å€‹è¡Œå‹•è¨ˆç•«ï¼',
        (text) => text + '\n\nğŸ¤ æ‰¾æœ‹å‹ï¼šæ¨™è¨˜ä¸€å€‹éœ€è¦çœ‹åˆ°é€™ç¯‡çš„æœ‹å‹ï¼',
        (text) => text + '\n\nğŸ’­ åæ€æ™‚é–“ï¼šèŠ±30ç§’æƒ³æƒ³ï¼Œé€™å°ä½ çš„ç”Ÿæ´»æœ‰ä»€éº¼å•Ÿç™¼ï¼Ÿ'
      ];
      
      const interaction = interactions[index % interactions.length];
      const transformedContent = interaction(content);
      transformations.push(`äº’å‹•å…ƒç´ : é¡å‹${index + 1}`);
      
      return transformedContent;
    }

    // é¿å…èˆ‡å‰é¢å…§å®¹ç›¸ä¼¼
    async function avoidSimilarityWithPrevious(content, previousContents, index, transformations) {
      let processedContent = content;
      
      // æª¢æŸ¥é—œéµè©é‡è¤‡
      const previousTexts = previousContents.map(item => item.content);
      const currentWords = processedContent.match(/\b\w+\b/g) || [];
      
      // å¦‚æœç™¼ç¾é‡è¤‡çš„é—œéµè©å¤ªå¤šï¼Œé€²è¡ŒåŒç¾©è©æ›¿æ›
      const synonymReplacements = {
        'é‡è¦': ['é—œéµ', 'æ ¸å¿ƒ', 'é‡é»', 'è¦ç·Š', 'é—œéµæ€§'],
        'æ–¹æ³•': ['ç­–ç•¥', 'æŠ€å·§', 'åšæ³•', 'è·¯å¾‘', 'ç§˜è¨£'],
        'å•é¡Œ': ['æŒ‘æˆ°', 'å›°é›£', 'éšœç¤™', 'èª²é¡Œ', 'é›£é¡Œ'],
        'æˆåŠŸ': ['æˆå°±', 'é”æˆ', 'å¯¦ç¾', 'å®Œæˆ', 'å‹åˆ©'],
        'å­¸ç¿’': ['å­¸æœƒ', 'æŒæ¡', 'äº†è§£', 'é ˜æ‚Ÿ', 'å¸æ”¶']
      };
      
      for (const [original, synonyms] of Object.entries(synonymReplacements)) {
        if (processedContent.includes(original)) {
          const replacement = synonyms[index % synonyms.length];
          processedContent = processedContent.replace(new RegExp(original, 'g'), replacement);
          transformations.push(`åŒç¾©è©æ›¿æ›: ${original}â†’${replacement}`);
        }
      }
      
      // å¦‚æœå…§å®¹é•·åº¦ç›¸ä¼¼ï¼Œèª¿æ•´é•·åº¦
      const averagePreviousLength = previousTexts.length > 0 ? 
        previousTexts.reduce((sum, text) => sum + text.length, 0) / previousTexts.length : 0;
      
      if (Math.abs(processedContent.length - averagePreviousLength) < 50) {
        if (index % 2 === 0) {
          // æ“´å±•å…§å®¹
          processedContent += '\n\nğŸ’¡ è£œå……èªªæ˜ï¼šé€™å€‹è§€é»å€¼å¾—æˆ‘å€‘æ·±å…¥æ€è€ƒï¼Œå› ç‚ºå®ƒä¸åƒ…å½±éŸ¿ç•¶ä¸‹ï¼Œæ›´é—œä¿‚åˆ°æœªä¾†çš„ç™¼å±•æ–¹å‘ã€‚';
          transformations.push('å…§å®¹æ“´å±•');
        } else {
          // ç²¾ç°¡å…§å®¹
          const sentences = processedContent.split('ã€‚');
          processedContent = sentences.slice(0, Math.max(2, sentences.length - 1)).join('ã€‚') + 'ã€‚';
          transformations.push('å…§å®¹ç²¾ç°¡');
        }
      }
      
      return processedContent;
    }

    // åŸºæ–¼Jabç†è«–çš„å¼·åŒ–å¤šæ¨£æ€§ç”Ÿæˆå‡½æ•¸
    function generateDiversityKeywords() {
      // Jabæ ¸å¿ƒåƒ¹å€¼é¡å‹
      const jabValueTypes = [
        'æ•™è‚²å•Ÿç™¼åƒ¹å€¼', 'å¨›æ¨‚äº’å‹•åƒ¹å€¼', 'æƒ…æ„Ÿå…±é³´åƒ¹å€¼', 'å¯¦ç”¨å·¥å…·åƒ¹å€¼', 
        'ç¤¾ç¾¤æ­¸å±¬åƒ¹å€¼', 'å°ˆæ¥­æ¬Šå¨åƒ¹å€¼', 'å‰µæ–°æ€ç¶­åƒ¹å€¼', 'ç”Ÿæ´»ç¾å­¸åƒ¹å€¼',
        'æˆé•·æ¿€å‹µåƒ¹å€¼', 'å•é¡Œè§£æ±ºåƒ¹å€¼', 'è¶¨å‹¢æ´å¯Ÿåƒ¹å€¼', 'æ–‡åŒ–èªåŒåƒ¹å€¼'
      ];
      
      // å¹³å°åŸç”Ÿè¡¨é”æ–¹å¼
      const platformNativeApproaches = [
        'Facebookå°è©±å¼æ•…äº‹', 'Instagramè¦–è¦ºåŒ–åˆ†æ®µ', 'LinkedInå°ˆæ¥­æ•¸æ“šåˆ†æ', 
        'Twitterè§€é»å¼é‡‘å¥', 'YouTubeæ·±åº¦æ•™å­¸å¼', 'TikTokè¶¨å‹¢æŒ‘æˆ°å¼',
        'å€‹äººç¶“é©—åˆ†äº«å¼', 'æ¡ˆä¾‹ç ”ç©¶å¼', 'æ­¥é©ŸæŒ‡å°å¼', 'å°æ¯”åˆ†æå¼',
        'å•ç­”äº’å‹•å¼', 'æ¸…å–®ç¸½çµå¼', 'å ´æ™¯æè¿°å¼', 'åæ€æ€è€ƒå¼'
      ];
      
      // æƒ…æ„Ÿé€£çµå±¤æ¬¡
      const emotionalConnections = [
        'åŒç†å¿ƒå…±é³´', 'æˆå°±æ„Ÿæ¿€å‹µ', 'æ­¸å±¬æ„Ÿå»ºç«‹', 'å®‰å…¨æ„Ÿæä¾›', 
        'å¥½å¥‡å¿ƒæ¿€ç™¼', 'æˆé•·æ„Ÿå•Ÿç™¼', 'èªåŒæ„Ÿå¼·åŒ–', 'å¹¸ç¦æ„Ÿå‚³é',
        'æŒ‘æˆ°æ„Ÿé¼“èˆ', 'æº«æš–æ„Ÿé™ªä¼´', 'æ–°é®®æ„Ÿé©šå–œ', 'åƒ¹å€¼æ„Ÿè‚¯å®š'
      ];

      // å…§å®¹çµæ§‹æ¡†æ¶ï¼ˆç¢ºä¿æ¯ç¯‡ä¸åŒï¼‰
      const structureFrameworks = [
        'å•é¡Œ-æ´å¯Ÿ-è§£æ±ºæ–¹æ¡ˆ', 'æ•…äº‹-æ•™è¨“-æ‡‰ç”¨', 'ç¾æ³-è¶¨å‹¢-å»ºè­°',
        'æŒ‘æˆ°-ç­–ç•¥-æˆæœ', 'è§€å¯Ÿ-åˆ†æ-è¡Œå‹•', 'ç¶“é©—-åæ€-åˆ†äº«',
        'ç™¼ç¾-é©—è­‰-æ¨å»£', 'å›°é›£-çªç ´-æˆé•·', 'éœ€æ±‚-æ–¹æ³•-æ•ˆç›Š',
        'ç¾è±¡-åŸå› -å°ç­–', 'ç›®æ¨™-è·¯å¾‘-å¯¦ç¾', 'ç–‘å•-æ¢ç´¢-ç­”æ¡ˆ'
      ];

      // èªè¨€é¢¨æ ¼è®ŠåŒ–ï¼ˆåŸºæ–¼Jabç†è«–çš„è‡ªç„¶åº¦ï¼‰
      const languageStyles = [
        'è¦ªåˆ‡æœ‹å‹å¼å°è©±', 'å°ˆæ¥­å°å¸«å¼æŒ‡å°', 'æº«æš–é•·è¼©å¼åˆ†äº«', 'æ´»åŠ›åŒä¼´å¼äº’å‹•',
        'ç¿æ™ºè§€å¯Ÿå®¶å¼', 'å¯¦å‹™ç¶“é©—å®¶å¼', 'å‰µæ„ç™¼æƒ³å®¶å¼', 'ç†æ€§åˆ†æå®¶å¼',
        'æ„Ÿæ€§æ•…äº‹å®¶å¼', 'å¹½é»˜é™ªä¼´è€…å¼', 'æ¿€å‹µæ•™ç·´å¼', 'æº«æŸ”å¼•å°è€…å¼'
      ];

      // ç¨ç‰¹è§’åº¦åˆ‡å…¥é»
      const uniquePerspectives = [
        'æ–°æ‰‹è¦–è§’ç™¼ç¾', 'å°ˆå®¶æ·±åº¦å‰–æ', 'è·¨ç•Œæ€ç¶­é€£çµ', 'é€†å‘æ€è€ƒæŒ‘æˆ°',
        'æ–‡åŒ–èƒŒæ™¯è§€å¯Ÿ', 'ä¸–ä»£å·®ç•°æ´å¯Ÿ', 'æ€§åˆ¥è¦–è§’åˆ†æ', 'è·æ¥­ç‰¹è‰²è§’åº¦',
        'åœ°åŸŸæ–‡åŒ–ç‰¹è‰²', 'æ™‚é–“è»¸æ¼”è®Š', 'åƒ¹å€¼è§€è¡çª', 'ç”Ÿæ´»å‹æ…‹å·®ç•°'
      ];
      
      return {
        jabValue: jabValueTypes[Math.floor(Math.random() * jabValueTypes.length)],
        platformApproach: platformNativeApproaches[Math.floor(Math.random() * platformNativeApproaches.length)],
        emotionalLayer: emotionalConnections[Math.floor(Math.random() * emotionalConnections.length)],
        structureType: structureFrameworks[Math.floor(Math.random() * structureFrameworks.length)],
        languageStyle: languageStyles[Math.floor(Math.random() * languageStyles.length)],
        uniqueAngle: uniquePerspectives[Math.floor(Math.random() * uniquePerspectives.length)]
      };
    }

    function generateStyleVariations(baseStyle) {
      const jabTheoryVariations = {
        'åŸç”Ÿåƒ¹å€¼å°å‘': ['å¹³å°è‡ªç„¶èå…¥', 'åƒ¹å€¼å„ªå…ˆå‘ˆç¾', 'ç¤¾ç¾¤æ–‡åŒ–é©æ‡‰', 'ç„¡å£“åŠ›çµ¦äºˆ'],
        'æ•…äº‹æƒ…æ„Ÿå‹': ['å€‹äººç¶“é©—åˆ†äº«', 'æƒ…æ„Ÿå…±é³´è§¸ç™¼', 'ç”Ÿæ´»å ´æ™¯é€£çµ', 'æº«æš–äººæ€§åŒ–'],
        'æ•™è‚²åˆ†äº«å‹': ['å°ˆæ¥­çŸ¥è­˜å‚³é', 'æŠ€èƒ½æå‡æŒ‡å°', 'å­¸ç¿’åƒ¹å€¼å‰µé€ ', 'æˆé•·å•Ÿç™¼'],
        'å¨›æ¨‚è¦ªå’Œå‹': ['è¼•é¬†å¹½é»˜äº’å‹•', 'è¦ªå’ŒåŠ›å»ºç«‹', 'æ­£å‘æƒ…ç·’å‚³é', 'ç¤¾ç¾¤å¨›æ¨‚'],
        'å•Ÿç™¼æ€è€ƒå‹': ['æ·±åº¦è§€é»åˆ†äº«', 'æ€ç¶­è§’åº¦æ‹“å±•', 'æ´å¯ŸåŠ›æä¾›', 'æ™ºæ…§å•Ÿç™¼'],
        'å¯¦ç”¨æŒ‡å°å‹': ['å…·é«”æ­¥é©ŸæŒ‡å—', 'å¯¦ä½œåƒ¹å€¼æä¾›', 'å•é¡Œè§£æ±ºå°å‘', 'ç«‹å³æ‡‰ç”¨'],
        'ç¤¾ç¾¤äº’å‹•å‹': ['å°è©±åƒèˆ‡ä¿ƒé€²', 'ç¤¾ç¾¤é€£çµå¼·åŒ–', 'äº’å‹•åƒ¹å€¼å‰µé€ ', 'é—œä¿‚å»ºç«‹'],
        'è¶¨å‹¢æ´å¯Ÿå‹': ['å‰ç»è¦–é‡åˆ†äº«', 'è¶¨å‹¢åˆ†æåƒ¹å€¼', 'æœªä¾†æ€è€ƒå•Ÿç™¼', 'æ´å¯Ÿæ™ºæ…§']
      };
      
      const baseVariations = jabTheoryVariations[baseStyle] || ['Jabåƒ¹å€¼å‰µé€ ', 'Right Hookè¡Œå‹•', 'åŸç”Ÿè¡¨é”', 'æƒ…æ„Ÿé€£çµ'];
      return baseVariations[Math.floor(Math.random() * baseVariations.length)];
    }

    function generateRequestId() {
      return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // åŸºæ–¼Jabç†è«–çš„å…§å®¹å·®ç•°åŒ–é™åˆ¶æ¢ä»¶
    function generateContentConstraints(index, total) {
      // Jab vs Right Hook å·®ç•°åŒ–è¦æ±‚
      const jabRightHookModes = [
        'pure_jab_education', 'pure_jab_entertainment', 'pure_jab_inspiration',
        'soft_right_hook', 'direct_right_hook', 'story_based_jab',
        'data_driven_jab', 'emotional_jab', 'practical_jab'
      ];
      
      // å…§å®¹çµæ§‹æ¨¡æ¿ï¼ˆç¢ºä¿æˆªç„¶ä¸åŒï¼‰
      const structuralTemplates = [
        'å•é¡Œæå‡ºâ†’æ·±åº¦åˆ†æâ†’è§£æ±ºå»ºè­°â†’åƒ¹å€¼ç¸½çµ',
        'æ•…äº‹é–‹å ´â†’æ•™è¨“æå–â†’å¯¦ç”¨æ‡‰ç”¨â†’æ„Ÿæ‚Ÿåˆ†äº«',
        'æ•¸æ“šéœ‡æ’¼â†’è¶¨å‹¢è§£è®€â†’è¡Œå‹•æŒ‡å—â†’æœªä¾†å±•æœ›',
        'å€‹äººç¶“é©—â†’åæ€æ´å¯Ÿâ†’é€šç”¨åŸå‰‡â†’å•Ÿç™¼é‚€è«‹',
        'ç¾è±¡è§€å¯Ÿâ†’åŸå› å‰–æâ†’ç­–ç•¥å»ºè­°â†’è¡Œå‹•å‘¼ç±²',
        'å°æ¯”åˆ†æâ†’å„ªåŠ£è©•ä¼°â†’æœ€ä½³å¯¦è¸â†’å­¸ç¿’å»ºè­°',
        'æ¡ˆä¾‹ç ”ç©¶â†’æˆåŠŸè¦ç´ â†’è¤‡è£½æ–¹æ³•â†’é€²éšæ€è€ƒ',
        'å›°é›£æè¿°â†’çªç ´éç¨‹â†’é—œéµå­¸ç¿’â†’æˆé•·åˆ†äº«'
      ];
      
      // èªè¨€é¢¨æ ¼å¼·åˆ¶å·®ç•°
      const languageMandates = [
        'ç¬¬ä¸€äººç¨±è¦ªèº«ç¶“é©—æ•˜è¿°', 'ç¬¬äºŒäººç¨±ç›´æ¥å°è©±å¼', 'ç¬¬ä¸‰äººç¨±å®¢è§€åˆ†æå¼',
        'å•ç­”è‡ªå•è‡ªç­”å¼', 'åˆ—è¡¨æ¢ç†åŒ–å‘ˆç¾', 'å°è©±æƒ…å¢ƒæ¨¡æ“¬å¼',
        'æ¯”å–»é¡æ¯”èªªæ˜å¼', 'æ•¸æ“šåœ–è¡¨æè¿°å¼', 'æ™‚é–“é †åºæ•˜è¿°å¼'
      ];
      
      // æƒ…æ„Ÿèª¿æ€§å·®ç•°
      const emotionalTones = [
        'æº«æš–é¼“å‹µæ”¯æŒèª¿æ€§', 'å°ˆæ¥­æ¬Šå¨æŒ‡å°èª¿æ€§', 'è¼•é¬†å¹½é»˜äº’å‹•èª¿æ€§',
        'æ·±åº¦æ€è€ƒå•Ÿç™¼èª¿æ€§', 'æ€¥è¿«è¡Œå‹•å‘¼ç±²èª¿æ€§', 'æº«å’Œå»ºè­°åˆ†äº«èª¿æ€§',
        'æ¿€å‹µé¼“èˆæŒ‘æˆ°èª¿æ€§', 'ç†æ€§å®¢è§€åˆ†æèª¿æ€§', 'æ„Ÿæ€§å…±é³´é€£çµèª¿æ€§'
      ];
      
      // å…§å®¹é–‹é ­æ–¹å¼ï¼ˆå¼·åˆ¶ä¸åŒï¼‰
      const openingStyles = [
        'å•é¡Œæå•é–‹å ´', 'æ•¸æ“šéœ‡æ’¼é–‹å ´', 'æ•…äº‹æƒ…å¢ƒé–‹å ´', 'å€‹äººæ„Ÿæ‚Ÿé–‹å ´',
        'è¶¨å‹¢è§€å¯Ÿé–‹å ´', 'å°æ¯”è¡çªé–‹å ´', 'å ´æ™¯æè¿°é–‹å ´', 'åè¨€å¼•ç”¨é–‹å ´',
        'åæ€è³ªç–‘é–‹å ´', 'ç¶“é©—åˆ†äº«é–‹å ´', 'æœªä¾†é æ¸¬é–‹å ´', 'ç¾æ³æè¿°é–‹å ´'
      ];
      
      // çµå°¾å‘¼ç±²æ–¹å¼
      const closingStyles = [
        'é–‹æ”¾å¼æ€è€ƒé‚€è«‹', 'å…·é«”è¡Œå‹•å»ºè­°', 'ç¤¾ç¾¤äº’å‹•å‘¼ç±²', 'é€²ä¸€æ­¥å­¸ç¿’å»ºè­°',
        'å€‹äººç¶“é©—åˆ†äº«é‚€è«‹', 'æœªä¾†å±•æœ›åˆ†äº«', 'åæ€å•é¡Œæå‡º', 'å¯¦è¸æŒ‘æˆ°ç™¼èµ·',
        'è³‡æºæ¨è–¦æä¾›', 'ç¤¾ç¾¤é€£çµå»ºç«‹', 'æŒçºŒé—œæ³¨é‚€è«‹', 'åƒ¹å€¼ç¢ºèªå¼·åŒ–'
      ];
      
      // åŸºæ–¼ç´¢å¼•å’Œç¸½æ•¸å‰µå»ºç¨ç‰¹çµ„åˆ
      const uniqueSeed = (index + 1) * (total + 1) * Date.now();
      
      return {
        // Jabç†è«–æ‡‰ç”¨
        jabMode: jabRightHookModes[index % jabRightHookModes.length],
        structuralTemplate: structuralTemplates[index % structuralTemplates.length],
        languageMandate: languageMandates[index % languageMandates.length],
        emotionalTone: emotionalTones[index % emotionalTones.length],
        openingStyle: openingStyles[index % openingStyles.length],
        closingStyle: closingStyles[index % closingStyles.length],
        
        // å¼·åˆ¶å·®ç•°åŒ–è¦æ±‚
        mustDiffer: true,
        contentNumber: index + 1,
        totalCount: total,
        uniquenessSeed: uniqueSeed,
        
        // ç‰¹æ®Šå·®ç•°åŒ–æŒ‡ä»¤
        differentiation: {
          structural: `å¿…é ˆä½¿ç”¨èˆ‡å…¶ä»–${total-1}ç¯‡å®Œå…¨ä¸åŒçš„çµæ§‹æ¨¡æ¿`,
          tonal: `æƒ…æ„Ÿèª¿æ€§å¿…é ˆèˆ‡å…¶ä»–ç¯‡ç« å½¢æˆé®®æ˜å°æ¯”`,
          linguistic: `èªè¨€é¢¨æ ¼å¿…é ˆå±•ç¾ç¨ç‰¹çš„è¡¨é”æ–¹å¼`,
          perspective: `åˆ‡å…¥è§’åº¦å¿…é ˆæä¾›å…¨æ–°çš„è§€é»è¦–é‡`,
          format: `å…§å®¹æ ¼å¼å¿…é ˆå‘ˆç¾ä¸åŒçš„çµ„ç¹”æ–¹å¼`
        },
        
        // Jabåƒ¹å€¼å·®ç•°åŒ–
        jabValueDifferentiation: index === 0 ? 'æ•™è‚²å•Ÿç™¼ä¸»å°' : 
                                index === 1 ? 'æƒ…æ„Ÿé€£çµä¸»å°' :
                                index === 2 ? 'å¯¦ç”¨åƒ¹å€¼ä¸»å°' :
                                index === 3 ? 'å¨›æ¨‚äº’å‹•ä¸»å°' :
                                'ç¶œåˆåƒ¹å€¼å‰µæ–°'
      };
    }

    function generateContentVariationLabel(index, formData) {
      // åŸºæ–¼Jabç†è«–çš„å…§å®¹é¡å‹
      const jabTheoryTypes = [
        'Jabæ•™è‚²å‹', 'Jabå¨›æ¨‚å‹', 'Jabå•Ÿç™¼å‹', 'Jabå…±é³´å‹', 'Jabå¯¦ç”¨å‹',
        'Right Hookè»Ÿæ€§', 'Right Hookç›´æ¥', 'Jabæ•…äº‹å‹', 'Jabå°ˆæ¥­å‹', 'Jabäº’å‹•å‹'
      ];
      
      // å¹³å°åŸç”Ÿè§’åº¦
      const platformNativeAngles = [
        'Facebookå°è©±é¢¨', 'Instagramè¦–è¦ºé¢¨', 'LinkedInå°ˆæ¥­é¢¨', 'Twitterè§€é»é¢¨',
        'å€‹äººç¶“é©—åˆ†äº«', 'å°ˆæ¥­æ´å¯Ÿåˆ†æ', 'ç”Ÿæ´»å ´æ™¯é€£çµ', 'è¶¨å‹¢è§€å¯Ÿè§£è®€',
        'æƒ…æ„Ÿæ•…äº‹æ•˜è¿°', 'å¯¦ç”¨æŠ€å·§æŒ‡å°', 'æ·±åº¦æ€è€ƒå•Ÿç™¼', 'è¼•é¬†å¹½é»˜äº’å‹•'
      ];
      
      // æ ¹æ“šå…§å®¹é¡å‹æ±ºå®šJabæ¨™ç±¤
      const contentTypeLabels = {
        'jab': 'Jabç´”ç²¹çµ¦äºˆ',
        'right_hook': 'Right Hookè¡Œå‹•',
        'jab_story': 'Jabæ•…äº‹åƒ¹å€¼',
        'jab_education': 'Jabæ•™è‚²åƒ¹å€¼',
        'jab_entertainment': 'Jabå¨›æ¨‚åƒ¹å€¼',
        'right_hook_soft': 'Right Hookæº«å’Œ',
        'right_hook_direct': 'Right Hookç›´æ¥'
      };
      
      // åŸºæ–¼ç´¢å¼•ç¢ºä¿æ¯ç¯‡éƒ½ä¸åŒ
      const typeIndex = index % jabTheoryTypes.length;
      const angleIndex = (index + 1) % platformNativeAngles.length;
      
      const baseLabel = contentTypeLabels[formData.contentType] || 'Jabåƒ¹å€¼å‹';
      const variationType = jabTheoryTypes[typeIndex];
      const angleType = platformNativeAngles[angleIndex];
      
      return `${baseLabel}ãƒ»${variationType}ãƒ»${angleType}`;
    }

    // å¯¦ç”¨å‡½æ•¸
    function copyToClipboard(button, text, index) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ… å·²è¤‡è£½';
        button.style.backgroundColor = '#10b981';
        button.style.color = 'white';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
          button.style.color = '';
        }, 2000);
      }).catch(() => {
        showSystemMessage('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æ–‡å­—', 'error');
      });
    }

    function regenerateContent() {
      if (STATE.lastGenerated) {
        document.getElementById('topic').value = STATE.lastGenerated.formData.topic;
        elements.contentForm.dispatchEvent(new Event('submit'));
      }
    }

    function optimizeContent() {
      if (STATE.lastGenerated) {
        const content = STATE.lastGenerated.contents[0];
        elements.chatInput.value = `è«‹å¹«æˆ‘åˆ†æä¸¦å„ªåŒ–é€™å€‹å…§å®¹ï¼š\n\n${content}`;
        elements.chatForm.dispatchEvent(new Event('submit'));
      }
    }

         // é¡å¤–å¯¦ç”¨å‡½æ•¸
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
         return;
       }
       
       try {
         showSystemMessage('ğŸ§ª æ¸¬è©¦APIé€£ç·šä¸­...', 'info');
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: AbortSignal.timeout(10000)
         });
         
         const data = await response.json();
         if (response.ok) {
           showSystemMessage('âœ… APIé€£ç·šæ­£å¸¸ï¼', 'success');
         } else {
           showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
         }
       } catch (error) {
         showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
       }
     }
     
     function showApiGuide() {
       const guideContent = `
         <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto p-6">
             <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-bold text-gray-800">ğŸ”‘ OpenRouter API è¨­å®šæŒ‡å—</h3>
               <button onclick="closeApiGuide()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
             </div>
             
             <div class="space-y-4 text-sm">
               <div class="bg-blue-50 p-4 rounded">
                 <h4 class="font-medium text-blue-800 mb-2">ğŸ“ æ­¥é©Ÿ 1: ç”³è«‹APIé‡‘é‘°</h4>
                 <p class="text-blue-700">å‰å¾€ <a href="https://openrouter.ai/keys" target="_blank" class="underline">OpenRouter.ai</a> è¨»å†Šå¸³è™Ÿä¸¦å‰µå»ºAPIé‡‘é‘°</p>
               </div>
               
               <div class="bg-green-50 p-4 rounded">
                 <h4 class="font-medium text-green-800 mb-2">ğŸ“„ æ­¥é©Ÿ 2: å‰µå»º .env æª”æ¡ˆ</h4>
                 <p class="text-green-700 mb-2">åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å‰µå»º .env æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š</p>
                 <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">OPENROUTER_API_KEY=sk-or-v1-ä½ çš„å¯¦éš›é‡‘é‘°
PORT=3001
DEBUG=true</pre>
               </div>
               
               <div class="bg-orange-50 p-4 rounded">
                 <h4 class="font-medium text-orange-800 mb-2">ğŸ”„ æ­¥é©Ÿ 3: é‡æ–°å•Ÿå‹•</h4>
                 <p class="text-orange-700">åœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œ <code class="bg-gray-100 px-1 rounded">npm start</code> é‡æ–°å•Ÿå‹•ä¼ºæœå™¨</p>
               </div>
               
               <div class="bg-purple-50 p-4 rounded">
                 <h4 class="font-medium text-purple-800 mb-2">ğŸ’¡ å…è²»é¡åº¦èªªæ˜</h4>
                 <ul class="text-purple-700 space-y-1">
                   <li>â€¢ æ–°ç”¨æˆ¶æœ‰ $5 å…è²»é¡åº¦</li>
                   <li>â€¢ éƒ¨åˆ†æ¨¡å‹å®Œå…¨å…è²»ä½¿ç”¨</li>
                   <li>â€¢ DeepSeek æ¨¡å‹æ€§åƒ¹æ¯”æ¥µé«˜</li>
                 </ul>
               </div>
             </div>
             
             <div class="mt-6 flex justify-end space-x-2">
               <a href="https://openrouter.ai/keys" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                 ğŸ”— å‰å¾€ç”³è«‹é‡‘é‘°
               </a>
               <button onclick="closeApiGuide()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition">
                 é—œé–‰
               </button>
             </div>
           </div>
         </div>
       `;
       
       document.body.insertAdjacentHTML('beforeend', guideContent);
     }
     
     function closeApiGuide() {
       const guide = document.querySelector('.fixed.inset-0');
       if (guide) guide.remove();
     }

     // æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒï¼ˆè¶…æ™‚éŒ¯èª¤å°ˆç”¨ï¼‰
     function checkServerLogs() {
       showSystemMessage('ğŸ’¡ è«‹æŸ¥çœ‹é»‘è‰²æ§åˆ¶å°è¦–çª—ï¼ˆä¼ºæœå™¨æ—¥èªŒï¼‰ï¼Œå…§å®¹å¯èƒ½å·²ç¶“æˆåŠŸç”Ÿæˆ', 'info');
       // å˜—è©¦æª¢æŸ¥æœ€è¿‘çš„å¥åº·ç‹€æ…‹
       if (STATE.currentServer) {
         fetch(`${STATE.currentServer}/health`)
           .then(response => response.json())
           .then(data => {
             console.log('ğŸ¥ ä¼ºæœå™¨å¥åº·ç‹€æ…‹:', data);
             showSystemMessage('âœ… ä¼ºæœå™¨é‹è¡Œæ­£å¸¸ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°çš„è©³ç´°æ—¥èªŒ', 'success');
           })
           .catch(err => {
             console.error('âŒ å¥åº·æª¢æŸ¥å¤±æ•—:', err);
           });
       }
     }

     // é‡è©¦ç”Ÿæˆï¼ˆæ¸›å°‘æ•¸é‡ï¼‰
     function retryWithReducedCount() {
       if (STATE.isGenerating) return;
       
       // è¨­å®šç‚º1ç¯‡å…§å®¹
       document.getElementById('count').value = '1';
       showSystemMessage('ğŸ”„ é‡æ–°å˜—è©¦ç”Ÿæˆ 1 ç¯‡å…§å®¹...', 'info');
       
       // é‡æ–°æäº¤è¡¨å–®
       setTimeout(() => {
         elements.contentForm.dispatchEvent(new Event('submit'));
       }, 1000);
     }

     // å¢å¼·çš„APIæ¸¬è©¦
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
         return;
       }
       
       try {
         showSystemMessage('ğŸ§ª æ¸¬è©¦APIé€£ç·šä¸­...', 'info');
         updateGenerateButton(true);
         
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: new AbortController().signal
         });
         
         const data = await response.json();
         if (response.ok && data.success) {
           showSystemMessage(`âœ… APIé€£ç·šæ­£å¸¸ï¼AIå›æ‡‰: ${data.response || 'OK'}`, 'success');
           console.log('ğŸ§ª APIæ¸¬è©¦çµæœ:', data);
         } else {
           showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
         }
       } catch (error) {
         console.error('âŒ APIæ¸¬è©¦éŒ¯èª¤:', error);
         showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
       } finally {
         updateGenerateButton(false);
       }
     }

     // åœç”¨å®šæœŸæª¢æŸ¥ä»¥é¿å…å¹²æ“¾ï¼ˆèª¿è©¦æœŸé–“ï¼‰
     console.log('â„¹ï¸ å®šæœŸå¥åº·æª¢æŸ¥å·²åœç”¨ï¼Œé¿å…å¹²æ“¾å…§å®¹ç”Ÿæˆ');
     /*
     setInterval(() => {
       if (STATE.isConnected) {
         fetch(`${STATE.currentServer}/health`)
           .catch(() => {
             STATE.isConnected = false;
             updateConnectionStatus('offline', 'âŒ é€£ç·šä¸­æ–·');
             showSystemMessage('âš ï¸ èˆ‡ä¼ºæœå™¨çš„é€£ç·šå·²ä¸­æ–·', 'warning');
           });
       }
     }, 30000);
     */
  </script>
</body>
</html>

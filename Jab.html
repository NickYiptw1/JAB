<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI內容生產器與智能助手 - 修復版本</title>
  <link href="../input.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    .loading { animation: pulse 2s infinite; }
    .error-shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-online { background: #10b981; color: white; }
    .status-offline { background: #ef4444; color: white; }
    .status-checking { background: #f59e0b; color: white; }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-8">
  <!-- 連線狀態指示器 -->
  <div id="connectionStatus" class="connection-status status-checking">
    🔄 檢測中...
  </div>

  <!-- 主要內容生產器 -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8 mb-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-blue-700">📝 AI內容生產器</h1>
        <div class="text-xs text-green-600 font-medium mt-1">🔧 修復版本 v2.0 - 超時問題已解決</div>
      </div>
      <div class="text-sm text-gray-500">
        <span id="serverInfo">伺服器: 未連接</span>
      </div>
    </div>

    <form id="contentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- 基本設定 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">基本設定</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">主題 *</span>
          <input type="text" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" 
                 placeholder="例：職場壓力管理、數位行銷策略" required>
          <span class="text-xs text-gray-400">具體明確的主題會產生更好的內容</span>
        </label>
        
        <label class="block">
          <span class="text-gray-700 font-medium">內容型態</span>
          <select id="contentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="jab">🥊 Jab（鋪墊型）- 建立關係與信任</option>
            <option value="right_hook">💥 Right Hook（主打型）- 促進行動呼籲</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">產出數量</span>
          <select id="count" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="1">1 篇</option>
            <option value="2">2 篇</option>
            <option value="3" selected>3 篇</option>
            <option value="4">4 篇</option>
            <option value="5">5 篇</option>
          </select>
        </label>
      </div>

      <!-- 平台與風格 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">平台與風格</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">目標平台</span>
          <select id="platform" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="Facebook">📘 Facebook - 社群互動</option>
            <option value="Instagram">📷 Instagram - 視覺內容</option>
            <option value="Twitter">🐦 Twitter - 即時動態</option>
            <option value="LinkedIn">💼 LinkedIn - 專業網絡</option>
            <option value="Pinterest">📌 Pinterest - 創意靈感</option>
            <option value="TikTok">🎵 TikTok - 短影音</option>
            <option value="YouTube">📺 YouTube - 長影音</option>
            <option value="通用">🌐 通用平台</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">內容風格</span>
          <select id="style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="原生">🎯 原生風格 - 融入平台文化</option>
            <option value="非干擾">🤝 非干擾型 - 自然不強推</option>
            <option value="少要求">💭 低壓力型 - 輕鬆互動</option>
            <option value="流行文化">🔥 流行文化 - 結合熱點</option>
            <option value="微型">⚡ 微型內容 - 簡潔有力</option>
            <option value="專業">👔 專業正式 - 權威可信</option>
            <option value="情感">❤️ 情感共鳴 - 觸動人心</option>
          </select>
        </label>
      </div>

      <!-- 技術設定 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">技術設定</h3>
        <label class="block">
          <span class="text-gray-700 font-medium tooltip">AI模型
            <span class="tooltiptext">不同模型有不同特性，可嘗試切換獲得最佳效果</span>
          </span>
          <select id="model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="tngtech/deepseek-r1t2-chimera:free">🧠 DeepSeek R1T2 (推薦)</option>
            <option value="tngtech/deepseek-r1t-chimera:free">🔬 DeepSeek R1T (穩定)</option>
            <option value="openai/gpt-3.5-turbo">💨 GPT-3.5 Turbo (快速)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">創意度</span>
          <input type="range" id="creativity" min="0" max="100" value="70" class="mt-1 block w-full">
          <div class="flex justify-between text-xs text-gray-400">
            <span>保守</span>
            <span id="creativityValue">70%</span>
            <span>創新</span>
          </div>
        </label>

        <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 font-semibold shadow-lg mb-2">
          🚀 產生內容
        </button>
        
        <button type="button" id="quickTestBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-medium text-sm">
          🧪 快速測試（修復驗證）
        </button>
      </div>
    </form>

    <!-- 結果顯示區域 -->
    <div id="contentResult" class="space-y-4"></div>
  </div>

  <!-- AI智能助手 -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">🤖 AI智能助手</h2>
      <button id="clearChat" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">清除對話</button>
    </div>

    <!-- 快速設定 -->
    <div id="chatOptions" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">內容型態</span>
        <select id="chatContentType" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="jab">🥊 Jab</option>
          <option value="right_hook">💥 Right Hook</option>
          <option value="analysis">📊 分析</option>
          <option value="optimization">⚡ 優化</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">平台</span>
        <select id="chatPlatform" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="Facebook">📘 Facebook</option>
          <option value="Instagram">📷 Instagram</option>
          <option value="Twitter">🐦 Twitter</option>
          <option value="LinkedIn">💼 LinkedIn</option>
          <option value="通用">🌐 通用</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">風格</span>
        <select id="chatStyle" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="原生">🎯 原生</option>
          <option value="專業">👔 專業</option>
          <option value="輕鬆">😊 輕鬆</option>
          <option value="創意">🎨 創意</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">語調</span>
        <select id="chatTone" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="友善">😊 友善</option>
          <option value="正式">👔 正式</option>
          <option value="熱情">🔥 熱情</option>
          <option value="冷靜">🧘 冷靜</option>
        </select>
      </label>
    </div>

    <!-- 對話窗口 -->
    <div id="chatWindow" class="h-80 overflow-y-auto bg-gradient-to-b from-gray-50 to-white rounded-lg p-4 mb-4 border space-y-3">
      <div class="text-center text-gray-400 text-sm">
        💬 歡迎使用AI助手！我可以幫你優化內容、分析策略、或回答任何相關問題
      </div>
    </div>

    <!-- 輸入區域 -->
    <form id="chatForm" class="flex gap-3">
      <div class="flex-1 relative">
        <input type="text" id="chatInput" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 pr-12" 
               placeholder="輸入你的問題或想法..." required>
        <div id="inputCounter" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">0</div>
      </div>
      <button type="submit" id="sendBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-semibold">
        📤 送出
      </button>
    </form>

    <!-- 快速提示 -->
    <div class="mt-4 flex flex-wrap gap-2">
      <span class="text-sm text-gray-500">快速提示：</span>
      <button class="quick-prompt text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition" data-prompt="幫我分析這個內容的優缺點">📊 分析內容</button>
      <button class="quick-prompt text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition" data-prompt="如何提升這個貼文的互動率？">🚀 提升互動</button>
      <button class="quick-prompt text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition" data-prompt="給我3個相關的內容創意">💡 內容創意</button>
      <button class="quick-prompt text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition" data-prompt="什麼時候發文效果最好？">⏰ 發文時機</button>
    </div>
  </div>

  <script>
    // 全域變數與狀態管理
    const STATE = {
      isConnected: false,
      currentServer: null,
      isGenerating: false,
      isChatting: false,
      chatHistory: [],
      lastGenerated: null
    };

    // API 配置
    const API_CONFIG = {
      ports: [3001, 3002, 3003, 3004, 3005, 3006, 3007, 3008, 3009, 3010, 3000, 8080, 5000],
      timeout: 120000, // 延長到120秒（2分鐘），給AI充足時間生成內容
      retryAttempts: 2 // 減少重試次數避免過長等待
    };

    // DOM 元素
    const elements = {
      connectionStatus: document.getElementById('connectionStatus'),
      serverInfo: document.getElementById('serverInfo'),
      contentForm: document.getElementById('contentForm'),
      contentResult: document.getElementById('contentResult'),
      chatForm: document.getElementById('chatForm'),
      chatWindow: document.getElementById('chatWindow'),
      chatInput: document.getElementById('chatInput'),
      generateBtn: document.getElementById('generateBtn'),
      quickTestBtn: document.getElementById('quickTestBtn'),
      sendBtn: document.getElementById('sendBtn'),
      creativitySlider: document.getElementById('creativity'),
      creativityValue: document.getElementById('creativityValue'),
      inputCounter: document.getElementById('inputCounter'),
      clearChat: document.getElementById('clearChat')
    };

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 AI內容生產器 修復版本 v2.0 載入完成');
      console.log('🔧 主要修復: 超時問題、瀏覽器相容性、錯誤處理');
      
      initializeApp();
      setupEventListeners();
      detectServer();
      
      // 顯示修復版本提示
      setTimeout(() => {
        showSystemMessage('🎉 修復版本已載入！超時問題已解決，支援2分鐘AI生成時間', 'success');
      }, 2000);
    });

    // 應用初始化
    function initializeApp() {
      // 創意度滑桿
      elements.creativitySlider.addEventListener('input', function() {
        elements.creativityValue.textContent = this.value + '%';
      });

      // 輸入字數統計
      elements.chatInput.addEventListener('input', function() {
        elements.inputCounter.textContent = this.value.length;
      });

      // 快速提示按鈕
      document.querySelectorAll('.quick-prompt').forEach(btn => {
        btn.addEventListener('click', function() {
          const prompt = this.dataset.prompt;
          elements.chatInput.value = prompt;
          elements.chatInput.focus();
        });
      });

      // 清除對話
      elements.clearChat.addEventListener('click', function() {
        if (confirm('確定要清除所有對話記錄嗎？')) {
          elements.chatWindow.innerHTML = '<div class="text-center text-gray-400 text-sm">💬 對話已清除，重新開始吧！</div>';
          STATE.chatHistory = [];
        }
      });
    }

    // 事件監聽器設置
    function setupEventListeners() {
      elements.contentForm.addEventListener('submit', handleContentGeneration);
      elements.chatForm.addEventListener('submit', handleChatSubmission);
      
      // 快速測試按鈕
      if (elements.quickTestBtn) {
        elements.quickTestBtn.addEventListener('click', handleQuickTest);
      }

      // 表單即時驗證
      document.getElementById('topic').addEventListener('blur', validateTopic);
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          if (document.activeElement === elements.chatInput) {
            handleChatSubmission(e);
          }
        }
      });
    }

    // 伺服器偵測
    async function detectServer() {
      updateConnectionStatus('checking', '🔄 偵測伺服器...');
      
      for (let port of API_CONFIG.ports) {
        try {
          const response = await fetch(`http://localhost:${port}/health`, {
            method: 'GET',
            signal: AbortSignal.timeout(2000)
          });
          
          if (response.ok) {
            STATE.currentServer = `http://localhost:${port}`;
            STATE.isConnected = true;
            updateConnectionStatus('online', `✅ 已連接 (${port})`);
            elements.serverInfo.textContent = `伺服器: localhost:${port}`;
            break;
          }
        } catch (error) {
          console.log(`Port ${port} 不可用:`, error.message);
        }
      }

      if (!STATE.isConnected) {
        updateConnectionStatus('offline', '❌ 無法連接');
        elements.serverInfo.textContent = '伺服器: 離線';
        showSystemMessage('⚠️ 無法連接到後端伺服器，請確認伺服器已啟動', 'warning');
      }
    }

    // 更新連線狀態
    function updateConnectionStatus(status, text) {
      elements.connectionStatus.className = `connection-status status-${status}`;
      elements.connectionStatus.textContent = text;
    }

    // 表單驗證
    function validateTopic() {
      const topic = document.getElementById('topic').value.trim();
      const topicField = document.getElementById('topic');
      
      if (topic.length < 2) {
        topicField.classList.add('border-red-300', 'error-shake');
        showSystemMessage('❌ 主題至少需要2個字符', 'error');
        return false;
      } else {
        topicField.classList.remove('border-red-300', 'error-shake');
        return true;
      }
    }

    // 快速測試功能
    async function handleQuickTest() {
      if (STATE.isGenerating) {
        showSystemMessage('⚠️ 正在生成中，請稍候...', 'warning');
        return;
      }
      
      if (!STATE.isConnected) {
        showSystemMessage('❌ 請先連接到伺服器', 'error');
        return;
      }
      
      // 自動填入測試數據
      document.getElementById('topic').value = '測試超時修復';
      document.getElementById('count').value = '1';
      document.getElementById('contentType').value = 'jab';
      document.getElementById('platform').value = 'Facebook';
      document.getElementById('style').value = '非干擾型';
      document.getElementById('creativity').value = '70';
      
      showSystemMessage('🧪 開始快速測試修復效果...', 'info');
      console.log('🧪 === 快速測試開始 ===');
      console.log('📊 超時設定:', API_CONFIG.timeout, 'ms');
      console.log('🔄 重試次數:', API_CONFIG.retryAttempts);
      
      // 觸發內容生成
      const fakeEvent = { preventDefault: () => {} };
      await handleContentGeneration(fakeEvent);
    }

    // 內容生成處理
    async function handleContentGeneration(e) {
      e.preventDefault();
      
      if (!validateTopic() || !STATE.isConnected || STATE.isGenerating) {
        return;
      }

      STATE.isGenerating = true;
      updateGenerateButton(true);

      const formData = {
        topic: document.getElementById('topic').value.trim(),
        count: document.getElementById('count').value,
        model: document.getElementById('model').value,
        contentType: document.getElementById('contentType').value,
        platform: document.getElementById('platform').value,
        style: document.getElementById('style').value,
        creativity: document.getElementById('creativity').value
      };

      showLoadingState();

      try {
        console.log('📤 開始發送內容生成請求:', formData);
        
        const response = await fetchWithRetry(`${STATE.currentServer}/api/generate-content`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        console.log('📨 收到響應，開始解析JSON...');
        const data = await response.json();
        console.log('✅ JSON解析成功:', data);
        
        if (data && Array.isArray(data.contents)) {
          displayGeneratedContent(data.contents, formData);
          STATE.lastGenerated = { contents: data.contents, formData };
          showSystemMessage('✅ 內容生成成功！', 'success');
        } else {
          console.error('❌ 數據格式錯誤:', data);
          throw new Error(`返回數據格式錯誤: ${JSON.stringify(data)}`);
        }
      } catch (error) {
        console.error('💥 內容生成完整錯誤:', {
          message: error.message,
          name: error.name,
          stack: error.stack,
          isTimeout: error.isTimeout
        });
        
        // 特殊處理超時錯誤
        if (error.isTimeout || error.message.includes('超時')) {
          showErrorState(`${error.message}\n\n💡 提示：請檢查伺服器控制台，內容可能已經成功生成！`);
          console.log('🔍 建議檢查伺服器日誌，內容可能已生成但前端超時');
        } else {
          showErrorState(error.message);
        }
      } finally {
        STATE.isGenerating = false;
        updateGenerateButton(false);
      }
    }

    // 聊天處理
    async function handleChatSubmission(e) {
      e.preventDefault();
      
      if (!STATE.isConnected || STATE.isChatting) {
        return;
      }

      const message = elements.chatInput.value.trim();
      if (!message) return;

      STATE.isChatting = true;
      const chatOptions = {
        contentType: document.getElementById('chatContentType').value,
        platform: document.getElementById('chatPlatform').value,
        style: document.getElementById('chatStyle').value,
        tone: document.getElementById('chatTone').value
      };

      appendChatMessage('user', message, chatOptions);
      elements.chatInput.value = '';
      elements.inputCounter.textContent = '0';
      
      const thinkingMsg = appendChatMessage('ai', '🤔 思考中...', chatOptions, true);
      updateSendButton(true);

      try {
        const response = await fetchWithRetry(`${STATE.currentServer}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            model: document.getElementById('model').value,
            ...chatOptions,
            history: STATE.chatHistory.slice(-10) // 保留最近10條對話
          })
        });

        const data = await response.json();
        
        // 移除思考中訊息
        thinkingMsg.remove();
        
        if (data && data.reply) {
          appendChatMessage('ai', data.reply, chatOptions);
          STATE.chatHistory.push({ user: message, ai: data.reply });
        } else {
          throw new Error('AI回復為空');
        }
      } catch (error) {
        console.error('聊天錯誤:', error);
        thinkingMsg.remove();
        appendChatMessage('ai', '❌ 抱歉，我現在無法回應。請稍後再試。', chatOptions);
      } finally {
        STATE.isChatting = false;
        updateSendButton(false);
        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      }
    }

    // 徹底修復超時問題 - 使用 Promise.race 避免 AbortController 問題
    async function fetchWithRetry(url, options, retries = API_CONFIG.retryAttempts) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`🔄 嘗試 ${i + 1}/${retries}: ${url}`);
          console.log(`⏰ 超時設定: ${API_CONFIG.timeout/1000} 秒`);
          
          // 使用 Promise.race 代替 AbortController 來避免瀏覽器相容性問題
          const fetchPromise = fetch(url, options);
          
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error(`請求超時 (超過 ${API_CONFIG.timeout/1000} 秒)，AI內容生成需要較長時間`));
            }, API_CONFIG.timeout);
          });

          console.log(`🌐 發送請求中...`);
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          console.log(`✅ 請求成功: ${response.status} ${response.statusText}`);
          return response;
          
        } catch (error) {
          console.log(`❌ 嘗試 ${i + 1} 失敗:`, error.message);
          console.log(`🔍 錯誤類型:`, error.name);
          console.log(`📊 錯誤堆疊:`, error.stack);
          
          // 標準化錯誤訊息
          if (error.message.includes('超時') || error.message.includes('timeout')) {
            error.message = `🕐 AI生成超時：內容生成通常需要1-2分鐘，請查看伺服器控制台確認是否已生成成功`;
            error.isTimeout = true;
          }
          
          if (i === retries - 1) {
            console.log(`💀 所有嘗試失敗，最終錯誤:`, error.message);
            throw error;
          }
          
          const delay = 1000 * (i + 1); // 遞增延遲：1秒、2秒
          console.log(`⏳ 等待 ${delay}ms 後重試...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // UI 更新函數
    function updateGenerateButton(isLoading) {
      elements.generateBtn.disabled = isLoading;
      elements.generateBtn.innerHTML = isLoading ? 
        '<span class="loading">⏳ 生成中...</span>' : 
        '🚀 產生內容';
    }

    function updateSendButton(isLoading) {
      elements.sendBtn.disabled = isLoading;
      elements.sendBtn.innerHTML = isLoading ? 
        '<span class="loading">⏳</span>' : 
        '📤 送出';
    }

    function showLoadingState() {
      elements.contentResult.innerHTML = `
        <div class="flex items-center justify-center p-8 bg-blue-50 rounded-lg">
          <div class="text-center">
            <div class="loading text-2xl mb-2">🤖</div>
            <div class="text-blue-600 font-medium">AI正在創作中...</div>
            <div class="text-sm text-gray-500 mt-1">通常需要 1-2 分鐘，請耐心等待</div>
            <div class="text-xs text-blue-500 mt-2">💡 您可以查看伺服器控制台了解生成進度</div>
          </div>
        </div>
      `;
    }

         function showErrorState(errorMsg) {
       console.log('🚨 顯示錯誤狀態:', errorMsg);
       
       const isApiError = errorMsg.includes('401') || errorMsg.includes('Unauthorized');
       const isTimeoutError = errorMsg.includes('超時') || errorMsg.includes('timeout') || errorMsg.includes('AbortError') || errorMsg.includes('AI生成超時');
       const isServerError = errorMsg.includes('500') || errorMsg.includes('Internal Server Error');
       
       let errorTitle = '內容生成失敗';
       let errorIcon = '❌';
       
       if (isApiError) {
         errorTitle = 'API 金鑰問題';
         errorIcon = '🔑';
       } else if (isTimeoutError) {
         errorTitle = '請求超時';
         errorIcon = '⏰';
       } else if (isServerError) {
         errorTitle = '伺服器錯誤';
         errorIcon = '🚧';
       }
       
       elements.contentResult.innerHTML = `
         <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
           <div class="flex items-center mb-3">
             <span class="text-red-500 text-xl mr-2">${errorIcon}</span>
             <span class="font-medium text-red-700">${errorTitle}</span>
           </div>
           <div class="text-red-600 text-sm mb-4">${errorMsg}</div>
           
           ${isTimeoutError ? `
             <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
               <h4 class="font-medium text-blue-800 mb-2">⏰ 超時問題解決方案</h4>
               <ul class="text-sm text-blue-700 space-y-1 mb-3">
                 <li>• AI 內容生成需要較長時間，這是正常現象</li>
                 <li>• 伺服器日誌顯示內容已成功生成，請檢查控制台</li>
                 <li>• 嘗試重新整理頁面並重新生成</li>
                 <li>• 考慮減少生成數量（例：改為1篇）</li>
               </ul>
               <div class="bg-green-100 border border-green-300 rounded p-2 text-xs text-green-700">
                 💡 提示：從伺服器日誌看，您的內容可能已經生成成功！請檢查黑色控制台視窗的最新內容。
               </div>
             </div>
           ` : ''}
           ${isApiError ? `
             <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
               <h4 class="font-medium text-yellow-800 mb-2">🔑 需要設定 OpenRouter API 金鑰</h4>
               <ol class="text-sm text-yellow-700 space-y-1 mb-3">
                 <li>1. 前往 <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">OpenRouter.ai</a> 申請免費API金鑰</li>
                 <li>2. 在專案根目錄創建 <code class="bg-yellow-100 px-1 rounded">.env</code> 檔案</li>
                 <li>3. 添加: <code class="bg-yellow-100 px-1 rounded">OPENROUTER_API_KEY=您的金鑰</code></li>
                 <li>4. 重新啟動伺服器</li>
               </ol>
               <button onclick="showApiGuide()" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded text-sm transition mr-2">
                 📖 詳細設定說明
               </button>
             </div>
           ` : ''}
           <div class="space-x-2">
             <button onclick="detectServer()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm transition">
               🔄 重新檢測伺服器
             </button>
             <button onclick="testApiConnection()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition">
               🧪 測試API連線
             </button>
             ${isTimeoutError ? `
               <button onclick="checkServerLogs()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition">
                 📋 檢查伺服器日誌
               </button>
               <button onclick="retryWithReducedCount()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm transition">
                 🔄 重試（1篇內容）
               </button>
             ` : ''}
           </div>
         </div>
       `;
     }

    function displayGeneratedContent(contents, formData) {
      const typeLabel = formData.contentType === 'jab' ? 'Jab（鋪墊型）' : 'Right Hook（主打型）';
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold text-blue-700">📋 生成結果</h3>
            <div class="text-sm text-blue-600">
              ${contents.length} 篇內容 | ${typeLabel} | ${formData.platform}
            </div>
          </div>
          <div class="text-sm text-gray-600">
            主題: ${formData.topic} | 風格: ${formData.style} | 創意度: ${formData.creativity}%
          </div>
        </div>
        ${contents.map((content, i) => `
          <div class="p-6 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg shadow-md border-l-4 border-blue-400 mb-4">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold text-blue-700">📝 內容 ${i + 1}</div>
              <button onclick="copyToClipboard(this, '${content.replace(/'/g, "\\'")}', ${i})" 
                      class="copy-btn bg-blue-200 hover:bg-blue-300 text-blue-700 px-3 py-1 rounded text-sm transition">
                📋 複製
              </button>
            </div>
            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap">${content}</div>
            <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-blue-600">
              適用: ${formData.platform} | 風格: ${formData.style}
            </div>
          </div>
        `).join('')}
        <div class="mt-4 text-center">
          <button onclick="regenerateContent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
            🔄 重新生成
          </button>
          <button onclick="optimizeContent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            ⚡ AI優化建議
          </button>
        </div>
      `;
    }

    function appendChatMessage(role, text, options, isTemporary = false) {
      const div = document.createElement('div');
      div.className = `chat-message ${role === 'user' ? 'text-right' : 'text-left'} ${isTemporary ? 'temporary' : ''}`;
      
      const timeStr = new Date().toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      div.innerHTML = `
        <div class="mb-1 text-xs text-gray-500">
          ${role === 'user' ? '👤 我' : '🤖 AI'} | ${timeStr} | 
          ${options.contentType} | ${options.platform} | ${options.style}
        </div>
        <div class="inline-block ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white border'} 
                  px-4 py-2 rounded-lg max-w-xs lg:max-w-md break-words">
          ${text}
        </div>
      `;
      
      elements.chatWindow.appendChild(div);
      elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      return div;
    }

    function showSystemMessage(message, type = 'info') {
      const colors = {
        success: 'bg-green-100 border-green-400 text-green-700',
        error: 'bg-red-100 border-red-400 text-red-700',
        warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
        info: 'bg-blue-100 border-blue-400 text-blue-700'
      };
      
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-20 right-4 p-3 rounded-lg border z-50 ${colors[type]} shadow-lg`;
      msgDiv.textContent = message;
      
      document.body.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.style.opacity = '0';
        msgDiv.style.transform = 'translateX(100%)';
        setTimeout(() => msgDiv.remove(), 300);
      }, 3000);
    }

    // 實用函數
    function copyToClipboard(button, text, index) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '✅ 已複製';
        button.style.backgroundColor = '#10b981';
        button.style.color = 'white';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
          button.style.color = '';
        }, 2000);
      }).catch(() => {
        showSystemMessage('❌ 複製失敗，請手動選擇文字', 'error');
      });
    }

    function regenerateContent() {
      if (STATE.lastGenerated) {
        document.getElementById('topic').value = STATE.lastGenerated.formData.topic;
        elements.contentForm.dispatchEvent(new Event('submit'));
      }
    }

    function optimizeContent() {
      if (STATE.lastGenerated) {
        const content = STATE.lastGenerated.contents[0];
        elements.chatInput.value = `請幫我分析並優化這個內容：\n\n${content}`;
        elements.chatForm.dispatchEvent(new Event('submit'));
      }
    }

         // 額外實用函數
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('❌ 請先連接到伺服器', 'error');
         return;
       }
       
       try {
         showSystemMessage('🧪 測試API連線中...', 'info');
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: AbortSignal.timeout(10000)
         });
         
         const data = await response.json();
         if (response.ok) {
           showSystemMessage('✅ API連線正常！', 'success');
         } else {
           showSystemMessage(`❌ API測試失敗: ${data.error || '未知錯誤'}`, 'error');
         }
       } catch (error) {
         showSystemMessage(`❌ API測試失敗: ${error.message}`, 'error');
       }
     }
     
     function showApiGuide() {
       const guideContent = `
         <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto p-6">
             <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-bold text-gray-800">🔑 OpenRouter API 設定指南</h3>
               <button onclick="closeApiGuide()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
             </div>
             
             <div class="space-y-4 text-sm">
               <div class="bg-blue-50 p-4 rounded">
                 <h4 class="font-medium text-blue-800 mb-2">📝 步驟 1: 申請API金鑰</h4>
                 <p class="text-blue-700">前往 <a href="https://openrouter.ai/keys" target="_blank" class="underline">OpenRouter.ai</a> 註冊帳號並創建API金鑰</p>
               </div>
               
               <div class="bg-green-50 p-4 rounded">
                 <h4 class="font-medium text-green-800 mb-2">📄 步驟 2: 創建 .env 檔案</h4>
                 <p class="text-green-700 mb-2">在專案根目錄創建 .env 檔案，內容如下：</p>
                 <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">OPENROUTER_API_KEY=sk-or-v1-你的實際金鑰
PORT=3001
DEBUG=true</pre>
               </div>
               
               <div class="bg-orange-50 p-4 rounded">
                 <h4 class="font-medium text-orange-800 mb-2">🔄 步驟 3: 重新啟動</h4>
                 <p class="text-orange-700">在終端機執行 <code class="bg-gray-100 px-1 rounded">npm start</code> 重新啟動伺服器</p>
               </div>
               
               <div class="bg-purple-50 p-4 rounded">
                 <h4 class="font-medium text-purple-800 mb-2">💡 免費額度說明</h4>
                 <ul class="text-purple-700 space-y-1">
                   <li>• 新用戶有 $5 免費額度</li>
                   <li>• 部分模型完全免費使用</li>
                   <li>• DeepSeek 模型性價比極高</li>
                 </ul>
               </div>
             </div>
             
             <div class="mt-6 flex justify-end space-x-2">
               <a href="https://openrouter.ai/keys" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                 🔗 前往申請金鑰
               </a>
               <button onclick="closeApiGuide()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition">
                 關閉
               </button>
             </div>
           </div>
         </div>
       `;
       
       document.body.insertAdjacentHTML('beforeend', guideContent);
     }
     
     function closeApiGuide() {
       const guide = document.querySelector('.fixed.inset-0');
       if (guide) guide.remove();
     }

     // 檢查伺服器日誌（超時錯誤專用）
     function checkServerLogs() {
       showSystemMessage('💡 請查看黑色控制台視窗（伺服器日誌），內容可能已經成功生成', 'info');
       // 嘗試檢查最近的健康狀態
       if (STATE.currentServer) {
         fetch(`${STATE.currentServer}/health`)
           .then(response => response.json())
           .then(data => {
             console.log('🏥 伺服器健康狀態:', data);
             showSystemMessage('✅ 伺服器運行正常，請檢查控制台的詳細日誌', 'success');
           })
           .catch(err => {
             console.error('❌ 健康檢查失敗:', err);
           });
       }
     }

     // 重試生成（減少數量）
     function retryWithReducedCount() {
       if (STATE.isGenerating) return;
       
       // 設定為1篇內容
       document.getElementById('count').value = '1';
       showSystemMessage('🔄 重新嘗試生成 1 篇內容...', 'info');
       
       // 重新提交表單
       setTimeout(() => {
         elements.contentForm.dispatchEvent(new Event('submit'));
       }, 1000);
     }

     // 增強的API測試
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('❌ 請先連接到伺服器', 'error');
         return;
       }
       
       try {
         showSystemMessage('🧪 測試API連線中...', 'info');
         updateGenerateButton(true);
         
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: new AbortController().signal
         });
         
         const data = await response.json();
         if (response.ok && data.success) {
           showSystemMessage(`✅ API連線正常！AI回應: ${data.response || 'OK'}`, 'success');
           console.log('🧪 API測試結果:', data);
         } else {
           showSystemMessage(`❌ API測試失敗: ${data.error || '未知錯誤'}`, 'error');
         }
       } catch (error) {
         console.error('❌ API測試錯誤:', error);
         showSystemMessage(`❌ API測試失敗: ${error.message}`, 'error');
       } finally {
         updateGenerateButton(false);
       }
     }

     // 停用定期檢查以避免干擾（調試期間）
     console.log('ℹ️ 定期健康檢查已停用，避免干擾內容生成');
     /*
     setInterval(() => {
       if (STATE.isConnected) {
         fetch(`${STATE.currentServer}/health`)
           .catch(() => {
             STATE.isConnected = false;
             updateConnectionStatus('offline', '❌ 連線中斷');
             showSystemMessage('⚠️ 與伺服器的連線已中斷', 'warning');
           });
       }
     }, 30000);
     */
  </script>
</body>
</html>

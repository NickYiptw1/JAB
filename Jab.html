<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jab理論AI內容生產器 - 多樣性強化版</title>
  <link href="../input.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    .loading { animation: pulse 2s infinite; }
    .error-shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-online { background: #10b981; color: white; }
    .status-offline { background: #ef4444; color: white; }
    .status-checking { background: #f59e0b; color: white; }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-8">
  <!-- 連線狀態指示器 -->
  <div id="connectionStatus" class="connection-status status-checking">
    🔄 檢測中...
  </div>

  <!-- 主要內容生產器 -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8 mb-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-blue-700">🥊 Jab理論AI內容生產器</h1>
        <div class="text-xs text-green-600 font-medium mt-1">🎯 基於《Jab, Jab, Jab, Right Hook》理論 - 價值導向內容創作</div>
        <div class="text-xs text-purple-600 font-medium mt-1">🔧 v5.0 強制差異化版 - 7層轉換確保每篇完全不同</div>
      </div>
      <div class="text-sm text-gray-500">
        <span id="serverInfo">伺服器: 未連接</span>
      </div>
    </div>

    <form id="contentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- 基本設定 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">基本設定</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">主題 *</span>
          <input type="text" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" 
                 placeholder="例：職場壓力管理、數位行銷策略" required>
          <span class="text-xs text-gray-400">具體明確的主題會產生更好的內容</span>
        </label>
        
        <label class="block">
          <span class="text-gray-700 font-medium">內容型態</span>
          <select id="contentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="jab">🥊 Jab（給予價值）- 教育、娛樂、啟發，建立信任</option>
            <option value="right_hook">💥 Right Hook（請求行動）- 明確CTA，轉換導向</option>
            <option value="jab_story">📖 Jab故事型 - 透過故事傳遞價值與情感連結</option>
            <option value="jab_education">🎓 Jab教育型 - 專業知識分享與技能提升</option>
            <option value="jab_entertainment">🎪 Jab娛樂型 - 輕鬆幽默，增加親和力</option>
            <option value="right_hook_soft">🎯 Right Hook軟性 - 間接引導，自然轉換</option>
            <option value="right_hook_direct">⚡ Right Hook直接 - 明確呼籲，立即行動</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">產出數量</span>
          <select id="count" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="1">1 篇</option>
            <option value="2">2 篇</option>
            <option value="3" selected>3 篇</option>
            <option value="4">4 篇</option>
            <option value="5">5 篇</option>
          </select>
        </label>
      </div>

      <!-- 平台與風格 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">平台與風格</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">目標平台</span>
          <select id="platform" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="Facebook">📘 Facebook - 對話式互動，故事性強，表情豐富</option>
            <option value="Instagram">📷 Instagram - 視覺敘述，分行呈現，hashtag策略</option>
            <option value="Twitter">🐦 Twitter - 簡潔有力，觀點鮮明，易轉發</option>
            <option value="LinkedIn">💼 LinkedIn - 專業權威，數據支撐，職場價值</option>
            <option value="Pinterest">📌 Pinterest - 創意靈感，美學導向，實用收藏</option>
            <option value="TikTok">🎵 TikTok - 年輕活力，趨勢話題，互動挑戰</option>
            <option value="YouTube">📺 YouTube - 詳細專業，教育導向，SEO優化</option>
            <option value="通用">🌐 通用平台 - 適應性強，多平台兼容</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">內容風格</span>
          <select id="style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="原生價值導向">🎯 原生價值導向 - 融入平台文化同時提供價值</option>
            <option value="故事情感型">📚 故事情感型 - 透過故事建立情感連結</option>
            <option value="教育分享型">🎓 教育分享型 - 專業知識傳授與技能提升</option>
            <option value="娛樂親和型">🎪 娛樂親和型 - 輕鬆幽默增加品牌親和力</option>
            <option value="啟發思考型">💡 啟發思考型 - 引發思考與深度討論</option>
            <option value="實用指導型">🔧 實用指導型 - 具體步驟與實作指南</option>
            <option value="社群互動型">🤝 社群互動型 - 促進參與與對話</option>
            <option value="趨勢洞察型">🔍 趨勢洞察型 - 行業分析與未來展望</option>
          </select>
        </label>
      </div>

      <!-- 技術設定 -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">技術設定</h3>
        <label class="block">
          <span class="text-gray-700 font-medium tooltip">AI模型
            <span class="tooltiptext">不同模型有不同特性，可嘗試切換獲得最佳效果</span>
          </span>
          <select id="model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="tngtech/deepseek-r1t2-chimera:free">🧠 DeepSeek R1T2 (推薦)</option>
            <option value="tngtech/deepseek-r1t-chimera:free">🔬 DeepSeek R1T (穩定)</option>
            <option value="openai/gpt-3.5-turbo">💨 GPT-3.5 Turbo (快速)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">創意度</span>
          <input type="range" id="creativity" min="0" max="100" value="70" class="mt-1 block w-full">
          <div class="flex justify-between text-xs text-gray-400">
            <span>保守</span>
            <span id="creativityValue">70%</span>
            <span>創新</span>
          </div>
        </label>

        <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 font-semibold shadow-lg mb-2">
          🚀 產生內容
        </button>
        
        <button type="button" id="quickTestBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-medium text-sm">
          🧪 快速測試（修復驗證）
        </button>
      </div>
    </form>

    <!-- 結果顯示區域 -->
    <div id="contentResult" class="space-y-4"></div>
  </div>

  <!-- AI智能助手 -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">🤖 AI智能助手</h2>
      <button id="clearChat" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">清除對話</button>
    </div>

    <!-- 快速設定 -->
    <div id="chatOptions" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">內容型態</span>
        <select id="chatContentType" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="jab">🥊 Jab</option>
          <option value="right_hook">💥 Right Hook</option>
          <option value="analysis">📊 分析</option>
          <option value="optimization">⚡ 優化</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">平台</span>
        <select id="chatPlatform" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="Facebook">📘 Facebook</option>
          <option value="Instagram">📷 Instagram</option>
          <option value="Twitter">🐦 Twitter</option>
          <option value="LinkedIn">💼 LinkedIn</option>
          <option value="通用">🌐 通用</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">風格</span>
        <select id="chatStyle" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="原生">🎯 原生</option>
          <option value="專業">👔 專業</option>
          <option value="輕鬆">😊 輕鬆</option>
          <option value="創意">🎨 創意</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">語調</span>
        <select id="chatTone" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="友善">😊 友善</option>
          <option value="正式">👔 正式</option>
          <option value="熱情">🔥 熱情</option>
          <option value="冷靜">🧘 冷靜</option>
        </select>
      </label>
    </div>

    <!-- 對話窗口 -->
    <div id="chatWindow" class="h-80 overflow-y-auto bg-gradient-to-b from-gray-50 to-white rounded-lg p-4 mb-4 border space-y-3">
      <div class="text-center text-gray-400 text-sm">
        💬 歡迎使用AI助手！我可以幫你優化內容、分析策略、或回答任何相關問題
      </div>
    </div>

    <!-- 輸入區域 -->
    <form id="chatForm" class="flex gap-3">
      <div class="flex-1 relative">
        <input type="text" id="chatInput" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 pr-12" 
               placeholder="輸入你的問題或想法..." required>
        <div id="inputCounter" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">0</div>
      </div>
      <button type="submit" id="sendBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-semibold">
        📤 送出
      </button>
    </form>

    <!-- 快速提示 -->
    <div class="mt-4 flex flex-wrap gap-2">
      <span class="text-sm text-gray-500">快速提示：</span>
      <button class="quick-prompt text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition" data-prompt="幫我分析這個內容的優缺點">📊 分析內容</button>
      <button class="quick-prompt text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition" data-prompt="如何提升這個貼文的互動率？">🚀 提升互動</button>
      <button class="quick-prompt text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition" data-prompt="給我3個相關的內容創意">💡 內容創意</button>
      <button class="quick-prompt text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition" data-prompt="什麼時候發文效果最好？">⏰ 發文時機</button>
    </div>
  </div>

  <script>
    // 全域變數與狀態管理
    const STATE = {
      isConnected: false,
      currentServer: null,
      isGenerating: false,
      isChatting: false,
      chatHistory: [],
      lastGenerated: null
    };

    // API 配置
    const API_CONFIG = {
      ports: [3001, 3002, 3003, 3004, 3005, 3006, 3007, 3008, 3009, 3010, 3000, 8080, 5000],
      timeout: 120000, // 延長到120秒（2分鐘），給AI充足時間生成內容
      retryAttempts: 2 // 減少重試次數避免過長等待
    };

    // DOM 元素
    const elements = {
      connectionStatus: document.getElementById('connectionStatus'),
      serverInfo: document.getElementById('serverInfo'),
      contentForm: document.getElementById('contentForm'),
      contentResult: document.getElementById('contentResult'),
      chatForm: document.getElementById('chatForm'),
      chatWindow: document.getElementById('chatWindow'),
      chatInput: document.getElementById('chatInput'),
      generateBtn: document.getElementById('generateBtn'),
      quickTestBtn: document.getElementById('quickTestBtn'),
      sendBtn: document.getElementById('sendBtn'),
      creativitySlider: document.getElementById('creativity'),
      creativityValue: document.getElementById('creativityValue'),
      inputCounter: document.getElementById('inputCounter'),
      clearChat: document.getElementById('clearChat')
    };

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 AI內容生產器 修復版本 v2.0 載入完成');
      console.log('🔧 主要修復: 超時問題、瀏覽器相容性、錯誤處理');
      
      initializeApp();
      setupEventListeners();
      detectServer();
      
      // 顯示循序漸進版本提示
      setTimeout(() => {
        showSystemMessage('🎉 循序漸進版本已載入！反覆處理機制確保每篇內容完全不同', 'success');
      }, 2000);
    });

    // 應用初始化
    function initializeApp() {
      // 創意度滑桿
      elements.creativitySlider.addEventListener('input', function() {
        elements.creativityValue.textContent = this.value + '%';
      });

      // 輸入字數統計
      elements.chatInput.addEventListener('input', function() {
        elements.inputCounter.textContent = this.value.length;
      });

      // 快速提示按鈕
      document.querySelectorAll('.quick-prompt').forEach(btn => {
        btn.addEventListener('click', function() {
          const prompt = this.dataset.prompt;
          elements.chatInput.value = prompt;
          elements.chatInput.focus();
        });
      });

      // 清除對話
      elements.clearChat.addEventListener('click', function() {
        if (confirm('確定要清除所有對話記錄嗎？')) {
          elements.chatWindow.innerHTML = '<div class="text-center text-gray-400 text-sm">💬 對話已清除，重新開始吧！</div>';
          STATE.chatHistory = [];
        }
      });
    }

    // 事件監聽器設置
    function setupEventListeners() {
      elements.contentForm.addEventListener('submit', handleContentGeneration);
      elements.chatForm.addEventListener('submit', handleChatSubmission);
      
      // 快速測試按鈕
      if (elements.quickTestBtn) {
        elements.quickTestBtn.addEventListener('click', handleQuickTest);
      }

      // 表單即時驗證
      document.getElementById('topic').addEventListener('blur', validateTopic);
      
      // 鍵盤快捷鍵
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          if (document.activeElement === elements.chatInput) {
            handleChatSubmission(e);
          }
        }
      });
    }

    // 伺服器偵測
    async function detectServer() {
      updateConnectionStatus('checking', '🔄 偵測伺服器...');
      
      for (let port of API_CONFIG.ports) {
        try {
          const response = await fetch(`http://localhost:${port}/health`, {
            method: 'GET',
            signal: AbortSignal.timeout(2000)
          });
          
          if (response.ok) {
            STATE.currentServer = `http://localhost:${port}`;
            STATE.isConnected = true;
            updateConnectionStatus('online', `✅ 已連接 (${port})`);
            elements.serverInfo.textContent = `伺服器: localhost:${port}`;
            break;
          }
        } catch (error) {
          console.log(`Port ${port} 不可用:`, error.message);
        }
      }

      if (!STATE.isConnected) {
        updateConnectionStatus('offline', '❌ 無法連接');
        elements.serverInfo.textContent = '伺服器: 離線';
        showSystemMessage('⚠️ 無法連接到後端伺服器，請確認伺服器已啟動', 'warning');
      }
    }

    // 更新連線狀態
    function updateConnectionStatus(status, text) {
      elements.connectionStatus.className = `connection-status status-${status}`;
      elements.connectionStatus.textContent = text;
    }

    // 表單驗證
    function validateTopic() {
      const topic = document.getElementById('topic').value.trim();
      const topicField = document.getElementById('topic');
      
      if (topic.length < 2) {
        topicField.classList.add('border-red-300', 'error-shake');
        showSystemMessage('❌ 主題至少需要2個字符', 'error');
        return false;
      } else {
        topicField.classList.remove('border-red-300', 'error-shake');
        return true;
      }
    }

    // 快速測試功能
    async function handleQuickTest() {
      if (STATE.isGenerating) {
        showSystemMessage('⚠️ 正在生成中，請稍候...', 'warning');
        return;
      }
      
      if (!STATE.isConnected) {
        showSystemMessage('❌ 請先連接到伺服器', 'error');
        return;
      }
      
      // 自動填入Jab理論測試數據
      document.getElementById('topic').value = 'Jab理論多樣性測試';
      document.getElementById('count').value = '3';
      document.getElementById('contentType').value = 'jab_education';
      document.getElementById('platform').value = 'Facebook';
      document.getElementById('style').value = '教育分享型';
      document.getElementById('creativity').value = '80';
      
      showSystemMessage('🧪 開始快速測試循序漸進生成...', 'info');
      console.log('🧪 === 循序漸進測試開始 ===');
      console.log('📊 反覆處理模式:', '一篇→分析→調整→下一篇');
      console.log('🎯 Jab理論應用:', '自適應差異化生成');
      
      // 觸發內容生成
      const fakeEvent = { preventDefault: () => {} };
      await handleContentGeneration(fakeEvent);
    }

    // 循序漸進內容生成處理 - 反覆處理機制
    async function handleContentGeneration(e) {
      e.preventDefault();
      
      if (!validateTopic() || !STATE.isConnected || STATE.isGenerating) {
        return;
      }

      STATE.isGenerating = true;
      updateGenerateButton(true);

      const contentCount = parseInt(document.getElementById('count').value);
      const baseFormData = {
        topic: document.getElementById('topic').value.trim(),
        model: document.getElementById('model').value,
        contentType: document.getElementById('contentType').value,
        platform: document.getElementById('platform').value,
        style: document.getElementById('style').value,
        creativity: document.getElementById('creativity').value,
        timestamp: new Date().toISOString(),
        requestId: generateRequestId()
      };

      // 初始化結果容器
      const allGeneratedContents = [];
      const allVariationData = [];
      
      showProgressiveLoadingState(0, contentCount);

      try {
        // 循序漸進生成每篇內容
        for (let i = 0; i < contentCount; i++) {
          console.log(`🔄 開始生成第 ${i + 1} 篇內容，總共 ${contentCount} 篇`);
          
          // 基於前面已生成的內容分析，調整當前生成策略
          const currentVariation = await generateAdaptiveVariation(i, contentCount, allGeneratedContents, baseFormData);
          allVariationData.push(currentVariation);
          
          // 更新進度顯示
          updateProgressiveLoadingState(i, contentCount, currentVariation);
          
          // 生成單篇內容
          const singleContentData = {
            ...baseFormData,
            count: 1, // 一次只生成一篇
            currentIndex: i,
            totalCount: contentCount,
            
            // 當前篇的特殊配置
            jabTheoryMode: 'progressive_adaptive',
            currentVariation: currentVariation,
            previousContents: allGeneratedContents.length > 0 ? allGeneratedContents : [],
            
            // 強制差異化指令
            forceDifferentiation: {
              mustAvoidSimilarity: true,
              previousContentAnalysis: await analyzePreviousContents(allGeneratedContents),
              targetUniqueness: `第${i + 1}篇必須與前${i}篇完全不同`,
              specificRequirements: currentVariation.specificRequirements
            }
          };

          console.log(`📤 發送第 ${i + 1} 篇內容生成請求:`, singleContentData);
          
          const response = await fetchWithRetry(`${STATE.currentServer}/api/generate-content`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(singleContentData)
          });

          const data = await response.json();
          
          if (data && data.contents && data.contents.length > 0) {
            let rawContent = data.contents[0];
            
            // 🚀 強制內容差異化處理
            const processedContent = await forceContentDifferentiation(
              rawContent, 
              allGeneratedContents, 
              currentVariation, 
              i, 
              baseFormData
            );
            
            allGeneratedContents.push({
              content: processedContent.content,
              index: i,
              variation: currentVariation,
              generatedAt: new Date().toISOString(),
              originalContent: rawContent,
              transformations: processedContent.transformations
            });
            
            console.log(`✅ 第 ${i + 1} 篇內容生成並強制差異化成功`);
            console.log(`📝 應用的轉換:`, processedContent.transformations);
            
            // 立即顯示已生成的內容
            displayProgressiveContent(allGeneratedContents, baseFormData);
            
            // 短暫延遲，讓用戶看到進度
            if (i < contentCount - 1) {
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          } else {
            throw new Error(`第 ${i + 1} 篇內容生成失敗: ${JSON.stringify(data)}`);
          }
        }

        // 所有內容生成完成
        const finalContents = allGeneratedContents.map(item => item.content);
        const finalFormData = {
          ...baseFormData,
          count: contentCount,
          multipleVariations: allGeneratedContents.map(item => ({
            ...allVariationData[item.index],
            transformations: item.transformations || []
          })),
          jabTheoryMode: 'progressive_completed',
          diversityLevel: 'maximum_progressive',
          forceUnique: true
        };

        displayGeneratedContent(finalContents, finalFormData);
        STATE.lastGenerated = { contents: finalContents, formData: finalFormData };
        showSystemMessage(`✅ 循序漸進生成完成！${contentCount}篇內容已確保完全不同`, 'success');
        
      } catch (error) {
        console.error('💥 循序漸進生成錯誤:', error);
        
        if (allGeneratedContents.length > 0) {
          // 部分成功，顯示已生成的內容
          const partialContents = allGeneratedContents.map(item => item.content);
          const partialFormData = {
            ...baseFormData,
            count: allGeneratedContents.length,
            multipleVariations: allVariationData.slice(0, allGeneratedContents.length)
          };
          
          displayGeneratedContent(partialContents, partialFormData);
          showSystemMessage(`⚠️ 部分成功：已生成 ${allGeneratedContents.length}/${contentCount} 篇內容`, 'warning');
        } else {
          showErrorState(error.message);
        }
      } finally {
        STATE.isGenerating = false;
        updateGenerateButton(false);
      }
    }

    // 聊天處理
    async function handleChatSubmission(e) {
      e.preventDefault();
      
      if (!STATE.isConnected || STATE.isChatting) {
        return;
      }

      const message = elements.chatInput.value.trim();
      if (!message) return;

      STATE.isChatting = true;
      const chatOptions = {
        contentType: document.getElementById('chatContentType').value,
        platform: document.getElementById('chatPlatform').value,
        style: document.getElementById('chatStyle').value,
        tone: document.getElementById('chatTone').value
      };

      appendChatMessage('user', message, chatOptions);
      elements.chatInput.value = '';
      elements.inputCounter.textContent = '0';
      
      const thinkingMsg = appendChatMessage('ai', '🤔 思考中...', chatOptions, true);
      updateSendButton(true);

      try {
        const response = await fetchWithRetry(`${STATE.currentServer}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            model: document.getElementById('model').value,
            ...chatOptions,
            history: STATE.chatHistory.slice(-10), // 保留最近10條對話
            // 加入多樣性參數避免重複回應
            variationSeed: Date.now() + Math.random(),
            timestamp: new Date().toISOString(),
            requestId: generateRequestId()
          })
        });

        const data = await response.json();
        
        // 移除思考中訊息
        thinkingMsg.remove();
        
        if (data && data.reply) {
          appendChatMessage('ai', data.reply, chatOptions);
          STATE.chatHistory.push({ user: message, ai: data.reply });
        } else {
          throw new Error('AI回復為空');
        }
      } catch (error) {
        console.error('聊天錯誤:', error);
        thinkingMsg.remove();
        appendChatMessage('ai', '❌ 抱歉，我現在無法回應。請稍後再試。', chatOptions);
      } finally {
        STATE.isChatting = false;
        updateSendButton(false);
        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      }
    }

    // 徹底修復超時問題 - 使用 Promise.race 避免 AbortController 問題
    async function fetchWithRetry(url, options, retries = API_CONFIG.retryAttempts) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`🔄 嘗試 ${i + 1}/${retries}: ${url}`);
          console.log(`⏰ 超時設定: ${API_CONFIG.timeout/1000} 秒`);
          
          // 使用 Promise.race 代替 AbortController 來避免瀏覽器相容性問題
          const fetchPromise = fetch(url, options);
          
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error(`請求超時 (超過 ${API_CONFIG.timeout/1000} 秒)，AI內容生成需要較長時間`));
            }, API_CONFIG.timeout);
          });

          console.log(`🌐 發送請求中...`);
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          console.log(`✅ 請求成功: ${response.status} ${response.statusText}`);
          return response;
          
        } catch (error) {
          console.log(`❌ 嘗試 ${i + 1} 失敗:`, error.message);
          console.log(`🔍 錯誤類型:`, error.name);
          console.log(`📊 錯誤堆疊:`, error.stack);
          
          // 標準化錯誤訊息
          if (error.message.includes('超時') || error.message.includes('timeout')) {
            error.message = `🕐 AI生成超時：內容生成通常需要1-2分鐘，請查看伺服器控制台確認是否已生成成功`;
            error.isTimeout = true;
          }
          
          if (i === retries - 1) {
            console.log(`💀 所有嘗試失敗，最終錯誤:`, error.message);
            throw error;
          }
          
          const delay = 1000 * (i + 1); // 遞增延遲：1秒、2秒
          console.log(`⏳ 等待 ${delay}ms 後重試...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // UI 更新函數
    function updateGenerateButton(isLoading) {
      elements.generateBtn.disabled = isLoading;
      elements.generateBtn.innerHTML = isLoading ? 
        '<span class="loading">⏳ 生成中...</span>' : 
        '🚀 產生內容';
    }

    function updateSendButton(isLoading) {
      elements.sendBtn.disabled = isLoading;
      elements.sendBtn.innerHTML = isLoading ? 
        '<span class="loading">⏳</span>' : 
        '📤 送出';
    }

    function showLoadingState() {
      elements.contentResult.innerHTML = `
        <div class="flex items-center justify-center p-8 bg-blue-50 rounded-lg">
          <div class="text-center">
            <div class="loading text-2xl mb-2">🤖</div>
            <div class="text-blue-600 font-medium">AI正在創作多樣化內容...</div>
            <div class="text-sm text-gray-500 mt-1">通常需要 1-2 分鐘，請耐心等待</div>
            <div class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded mt-2">
              🎯 已加入多樣性機制，確保每篇內容都不相同
            </div>
            <div class="text-xs text-blue-500 mt-2">💡 您可以查看伺服器控制台了解生成進度</div>
          </div>
        </div>
      `;
    }

    // 循序漸進載入狀態顯示
    function showProgressiveLoadingState(current, total) {
      elements.contentResult.innerHTML = `
        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-500">
          <div class="text-center mb-4">
            <div class="loading text-2xl mb-2">🎯</div>
            <div class="text-blue-700 font-semibold text-lg">循序漸進內容生成</div>
            <div class="text-blue-600 text-sm mt-1">反覆處理機制 - 確保每篇內容完全不同</div>
          </div>
          
          <div class="mb-4">
            <div class="flex justify-between text-sm text-blue-700 mb-2">
              <span>進度</span>
              <span>${current}/${total} 篇</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-3">
              <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" 
                   style="width: ${(current / total) * 100}%"></div>
            </div>
          </div>
          
          <div class="text-xs text-gray-600 bg-white p-3 rounded">
            <div class="font-medium mb-2">🔧 技術特色：</div>
            <ul class="space-y-1">
              <li>• 生成一篇 → 深度分析 → 調整策略 → 生成下一篇</li>
              <li>• 每篇內容都基於前面的分析結果避免重複</li>
              <li>• Jab理論自適應應用，確保價值導向差異化</li>
              <li>• 平台原生風格動態調整</li>
            </ul>
          </div>
        </div>
      `;
    }

    // 更新循序漸進載入狀態
    function updateProgressiveLoadingState(current, total, variation) {
      const progressContainer = elements.contentResult.querySelector('.bg-gradient-to-r');
      if (!progressContainer) return;
      
      // 更新進度條
      const progressBar = progressContainer.querySelector('.bg-blue-600');
      if (progressBar) {
        progressBar.style.width = `${((current + 1) / total) * 100}%`;
      }
      
      // 更新進度文字
      const progressText = progressContainer.querySelector('.flex.justify-between span:last-child');
      if (progressText) {
        progressText.textContent = `${current + 1}/${total} 篇`;
      }
      
      // 添加當前生成狀態
      const statusDiv = progressContainer.querySelector('.text-xs.text-gray-600.bg-white');
      if (statusDiv && variation) {
        statusDiv.innerHTML = `
          <div class="font-medium mb-2">🔧 目前生成第 ${current + 1} 篇：</div>
          <ul class="space-y-1 text-xs">
            <li>• Jab策略: ${variation.jabStrategy}</li>
            <li>• 結構框架: ${variation.structuralFramework}</li>
            <li>• 差異化重點: ${variation.differentiationFocus}</li>
            <li>• 避免重複: ${variation.avoidanceMeasures}</li>
          </ul>
        `;
      }
    }

         function showErrorState(errorMsg) {
       console.log('🚨 顯示錯誤狀態:', errorMsg);
       
       const isApiError = errorMsg.includes('401') || errorMsg.includes('Unauthorized');
       const isTimeoutError = errorMsg.includes('超時') || errorMsg.includes('timeout') || errorMsg.includes('AbortError') || errorMsg.includes('AI生成超時');
       const isServerError = errorMsg.includes('500') || errorMsg.includes('Internal Server Error');
       
       let errorTitle = '內容生成失敗';
       let errorIcon = '❌';
       
       if (isApiError) {
         errorTitle = 'API 金鑰問題';
         errorIcon = '🔑';
       } else if (isTimeoutError) {
         errorTitle = '請求超時';
         errorIcon = '⏰';
       } else if (isServerError) {
         errorTitle = '伺服器錯誤';
         errorIcon = '🚧';
       }
       
       elements.contentResult.innerHTML = `
         <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
           <div class="flex items-center mb-3">
             <span class="text-red-500 text-xl mr-2">${errorIcon}</span>
             <span class="font-medium text-red-700">${errorTitle}</span>
           </div>
           <div class="text-red-600 text-sm mb-4">${errorMsg}</div>
           
           ${isTimeoutError ? `
             <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
               <h4 class="font-medium text-blue-800 mb-2">⏰ 超時問題解決方案</h4>
               <ul class="text-sm text-blue-700 space-y-1 mb-3">
                 <li>• AI 內容生成需要較長時間，這是正常現象</li>
                 <li>• 伺服器日誌顯示內容已成功生成，請檢查控制台</li>
                 <li>• 嘗試重新整理頁面並重新生成</li>
                 <li>• 考慮減少生成數量（例：改為1篇）</li>
               </ul>
               <div class="bg-green-100 border border-green-300 rounded p-2 text-xs text-green-700">
                 💡 提示：從伺服器日誌看，您的內容可能已經生成成功！請檢查黑色控制台視窗的最新內容。
               </div>
             </div>
           ` : ''}
           ${isApiError ? `
             <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
               <h4 class="font-medium text-yellow-800 mb-2">🔑 需要設定 OpenRouter API 金鑰</h4>
               <ol class="text-sm text-yellow-700 space-y-1 mb-3">
                 <li>1. 前往 <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">OpenRouter.ai</a> 申請免費API金鑰</li>
                 <li>2. 在專案根目錄創建 <code class="bg-yellow-100 px-1 rounded">.env</code> 檔案</li>
                 <li>3. 添加: <code class="bg-yellow-100 px-1 rounded">OPENROUTER_API_KEY=您的金鑰</code></li>
                 <li>4. 重新啟動伺服器</li>
               </ol>
               <button onclick="showApiGuide()" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded text-sm transition mr-2">
                 📖 詳細設定說明
               </button>
             </div>
           ` : ''}
           <div class="space-x-2">
             <button onclick="detectServer()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm transition">
               🔄 重新檢測伺服器
             </button>
             <button onclick="testApiConnection()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition">
               🧪 測試API連線
             </button>
             ${isTimeoutError ? `
               <button onclick="checkServerLogs()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition">
                 📋 檢查伺服器日誌
               </button>
               <button onclick="retryWithReducedCount()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm transition">
                 🔄 重試（1篇內容）
               </button>
             ` : ''}
           </div>
         </div>
       `;
     }

    function displayGeneratedContent(contents, formData) {
      // 更詳細的內容類型標籤
      const contentTypeLabels = {
        'jab': 'Jab（給予價值）- 教育、娛樂、啟發',
        'right_hook': 'Right Hook（請求行動）- 明確CTA',
        'jab_story': 'Jab故事型 - 情感連結',
        'jab_education': 'Jab教育型 - 知識分享',
        'jab_entertainment': 'Jab娛樂型 - 親和力建立',
        'right_hook_soft': 'Right Hook軟性 - 間接引導',
        'right_hook_direct': 'Right Hook直接 - 立即行動'
      };
      
      const typeLabel = contentTypeLabels[formData.contentType] || 'Jab價值型內容';
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-500">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold text-blue-800">📋 Jab理論內容生成結果</h3>
            <div class="text-sm text-blue-700 bg-blue-100 px-2 py-1 rounded">
              ${contents.length} 篇內容 | ${formData.platform}
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 text-sm mb-3">
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">內容策略:</strong> ${typeLabel}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">主題:</strong> ${formData.topic}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">風格:</strong> ${formData.style}
            </div>
            <div class="bg-white p-2 rounded">
              <strong class="text-gray-700">創意度:</strong> ${formData.creativity}%
            </div>
          </div>
          
          ${formData.jabTheoryMode === 'advanced' ? `
            <div class="text-xs text-green-700 bg-green-100 px-3 py-2 rounded-lg mb-2">
              🎯 <strong>Jab理論進階模式:</strong> 每篇內容都基於不同的價值給予策略，確保多樣性和平台原生性
            </div>
          ` : ''}
          
          ${formData.multipleVariations && formData.multipleVariations.length > 0 ? `
            <div class="text-xs text-purple-700 bg-purple-100 px-3 py-2 rounded-lg mb-2">
              🔀 <strong>強化差異化:</strong> ${formData.diversityLevel} | 平台原生優化: ${formData.platformNativeOptimization ? '啟用' : '停用'}
            </div>
            <div class="text-xs text-orange-700 bg-orange-100 px-3 py-2 rounded-lg">
              ⚡ <strong>品質控制:</strong> 最低${formData.qualityRequirements?.minimumLength || 150}字 | 互動元素: ${formData.qualityRequirements?.interactionElements || '必須'} | Jab價值清晰度: ${formData.qualityRequirements?.jabValueClarity || '高'}
            </div>
          ` : ''}
        </div>
        ${contents.map((content, i) => {
          // 為每篇內容生成獨特的變化標籤
          const uniqueVariation = generateContentVariationLabel(i, formData);
          const variation = formData.multipleVariations ? formData.multipleVariations[i] : null;
          
          // 根據內容類型選擇顏色主題
          const isJab = formData.contentType.includes('jab');
          const colorTheme = isJab ? 'green' : 'red';
          const bgGradient = isJab ? 'from-green-50 to-emerald-50' : 'from-red-50 to-pink-50';
          const borderColor = isJab ? 'border-green-400' : 'border-red-400';
          const textColor = isJab ? 'text-green-700' : 'text-red-700';
          
          return `
          <div class="p-6 bg-gradient-to-r ${bgGradient} rounded-lg shadow-md border-l-4 ${borderColor} mb-4">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold ${textColor}">
                ${isJab ? '🥊' : '💥'} 內容 ${i + 1} 
                <span class="text-xs font-normal text-purple-600 bg-white px-2 py-1 rounded ml-2 shadow-sm">
                  ${uniqueVariation}
                </span>
              </div>
              <button onclick="copyToClipboard(this, '${content.replace(/'/g, "\\'")}', ${i})" 
                      class="copy-btn bg-white hover:bg-gray-50 ${textColor} px-3 py-1 rounded text-sm transition shadow-sm border">
                📋 複製
              </button>
            </div>
            
            ${variation && variation.jabTheoryApplication ? `
              <div class="mb-3 p-3 bg-white rounded-lg text-xs border shadow-sm">
                <div class="font-medium text-gray-700 mb-2">🎯 Jab理論應用分析：</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div><strong>價值類型:</strong> <span class="text-blue-600">${variation.jabTheoryApplication.valueType}</span></div>
                  <div><strong>平台方式:</strong> <span class="text-green-600">${variation.jabTheoryApplication.platformApproach}</span></div>
                  <div><strong>情感連結:</strong> <span class="text-purple-600">${variation.jabTheoryApplication.emotionalConnection}</span></div>
                  <div><strong>結構框架:</strong> <span class="text-orange-600">${variation.jabTheoryApplication.structuralFramework}</span></div>
                </div>
                ${variation.mandatoryConstraints ? `
                  <div class="mt-2 pt-2 border-t">
                    <strong>差異化要求:</strong> <span class="text-gray-600">${variation.mandatoryConstraints.jabMode}</span> | 
                    <span class="text-gray-600">${variation.mandatoryConstraints.emotionalTone}</span>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${formData.multipleVariations && formData.multipleVariations[i] && formData.multipleVariations[i].transformations ? `
              <div class="mb-3 p-3 bg-yellow-50 rounded-lg text-xs border border-yellow-200">
                <div class="font-medium text-yellow-800 mb-2">🚀 強制差異化轉換記錄：</div>
                <div class="text-yellow-700">
                  ${formData.multipleVariations[i].transformations.slice(0, 4).join(' • ')}
                  ${formData.multipleVariations[i].transformations.length > 4 ? '...' : ''}
                </div>
                <div class="mt-1 text-xs text-green-600">
                  ✅ 共應用 ${formData.multipleVariations[i].transformations.length} 項轉換確保內容獨特性
                </div>
              </div>
            ` : ''}
            
            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap bg-white p-4 rounded-lg border">${content}</div>
            
            <div class="mt-3 pt-3 border-t ${borderColor} text-xs ${textColor}">
              <div class="flex justify-between items-center">
                <div>
                  <strong>適用:</strong> ${formData.platform} | 
                  <strong>風格:</strong> ${formData.style} | 
                  <strong>類型:</strong> ${isJab ? 'Jab價值給予' : 'Right Hook行動呼籲'}
                </div>
                ${variation ? `<div class="text-gray-500">ID: ${variation.uniqueId.substr(-6)}</div>` : ''}
              </div>
              ${variation && variation.jabValueFocus ? `
                <div class="mt-1 text-xs bg-white px-2 py-1 rounded">
                  <strong>價值焦點:</strong> ${variation.jabValueFocus}
                </div>
              ` : ''}
            </div>
          </div>
        `;}).join('')}
        <div class="mt-4 text-center">
          <button onclick="regenerateContent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
            🔄 重新生成
          </button>
          <button onclick="optimizeContent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            ⚡ AI優化建議
          </button>
        </div>
      `;
    }

    function appendChatMessage(role, text, options, isTemporary = false) {
      const div = document.createElement('div');
      div.className = `chat-message ${role === 'user' ? 'text-right' : 'text-left'} ${isTemporary ? 'temporary' : ''}`;
      
      const timeStr = new Date().toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      div.innerHTML = `
        <div class="mb-1 text-xs text-gray-500">
          ${role === 'user' ? '👤 我' : '🤖 AI'} | ${timeStr} | 
          ${options.contentType} | ${options.platform} | ${options.style}
        </div>
        <div class="inline-block ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white border'} 
                  px-4 py-2 rounded-lg max-w-xs lg:max-w-md break-words">
          ${text}
        </div>
      `;
      
      elements.chatWindow.appendChild(div);
      elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      return div;
    }

    function showSystemMessage(message, type = 'info') {
      const colors = {
        success: 'bg-green-100 border-green-400 text-green-700',
        error: 'bg-red-100 border-red-400 text-red-700',
        warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
        info: 'bg-blue-100 border-blue-400 text-blue-700'
      };
      
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-20 right-4 p-3 rounded-lg border z-50 ${colors[type]} shadow-lg`;
      msgDiv.textContent = message;
      
      document.body.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.style.opacity = '0';
        msgDiv.style.transform = 'translateX(100%)';
        setTimeout(() => msgDiv.remove(), 300);
      }, 3000);
    }

    // 自適應變化生成 - 基於前面內容分析調整策略
    async function generateAdaptiveVariation(index, total, previousContents, baseFormData) {
      console.log(`🧠 為第 ${index + 1} 篇生成自適應變化策略`);
      
      // 分析前面已生成的內容特徵
      const previousAnalysis = await analyzePreviousContents(previousContents);
      
      // 基礎Jab策略池，確保每篇都不同
      const jabStrategies = [
        '純教育價值型 - 知識傳遞為主',
        '情感故事型 - 共鳴連結為主', 
        '實用工具型 - 具體幫助為主',
        '娛樂互動型 - 輕鬆參與為主',
        '專業權威型 - 深度分析為主',
        '趨勢洞察型 - 前瞻視野為主',
        '社群歸屬型 - 社區感為主',
        '問題解決型 - 方案導向為主'
      ];
      
      // 結構框架池，循環使用確保差異
      const structuralFrameworks = [
        '問題→分析→解方→呼籲',
        '故事→教訓→應用→分享',
        '現象→原因→策略→行動',
        '挑戰→思考→突破→成長',
        '觀察→洞察→建議→實踐',
        '疑問→探索→發現→啟發',
        '需求→方法→效益→推廣',
        '目標→路徑→實現→延伸'
      ];
      
      // 差異化重點，基於已用過的避免重複
      const usedDifferentiationPoints = previousAnalysis.usedDifferentiationPoints || [];
      const availableDifferentiationPoints = [
        '開頭方式完全不同', '結尾呼籲方式不同', '語言風格差異化',
        '情感調性對比', '內容長度變化', '互動元素差異',
        '表情符號使用不同', '段落結構變化', '問句使用差異',
        '個人/客觀視角切換', '數據/感性平衡調整', '時間觀點差異'
      ].filter(point => !usedDifferentiationPoints.includes(point));
      
      // 避免重複措施，基於前面內容的特徵
      const avoidanceMeasures = generateAvoidanceMeasures(previousAnalysis, index);
      
      // 當前篇的獨特配置
      const currentVariation = {
        index: index,
        jabStrategy: jabStrategies[index % jabStrategies.length],
        structuralFramework: structuralFrameworks[index % structuralFrameworks.length],
        differentiationFocus: availableDifferentiationPoints[0] || `第${index + 1}篇獨特焦點`,
        avoidanceMeasures: avoidanceMeasures,
        
        // Jab理論深度應用
        jabTheoryApplication: {
          valueType: getUniqueValueType(index, previousAnalysis),
          platformApproach: getUniquePlatformApproach(index, baseFormData.platform, previousAnalysis),
          emotionalConnection: getUniqueEmotionalConnection(index, previousAnalysis),
          languageStyle: getUniqueLanguageStyle(index, previousAnalysis)
        },
        
        // 特殊要求
        specificRequirements: {
          mustDifferFrom: previousContents.map(content => content.content.substring(0, 100)),
          targetLength: 150 + (index * 50), // 長度遞增
          uniqueElements: getUniqueElements(index, total),
          platformOptimization: getPlatformOptimization(baseFormData.platform, index)
        },
        
        // 強制差異化規則
        forcedDifferentiation: {
          structuralPattern: `模式${index + 1}`,
          tonalDirection: index % 2 === 0 ? '積極正向' : '深度思考',
          contentFocus: index < total / 2 ? 'Jab價值給予' : 'Right Hook軟性引導',
          interactionStyle: getInteractionStyle(index)
        }
      };
      
      console.log(`✅ 第 ${index + 1} 篇變化策略生成完成:`, currentVariation);
      return currentVariation;
    }

    // 分析前面已生成的內容
    async function analyzePreviousContents(previousContents) {
      if (previousContents.length === 0) {
        return {
          usedStrategies: [],
          usedStructures: [],
          usedDifferentiationPoints: [],
          commonPatterns: [],
          suggestionForNext: '第一篇內容，自由發揮'
        };
      }
      
      console.log(`🔍 分析前面 ${previousContents.length} 篇內容特徵`);
      
      const analysis = {
        usedStrategies: previousContents.map(content => content.variation?.jabStrategy || ''),
        usedStructures: previousContents.map(content => content.variation?.structuralFramework || ''),
        usedDifferentiationPoints: previousContents.flatMap(content => 
          content.variation?.differentiationFocus ? [content.variation.differentiationFocus] : []
        ),
        contentLengths: previousContents.map(content => content.content.length),
        openingStyles: previousContents.map(content => analyzeOpeningStyle(content.content)),
        closingStyles: previousContents.map(content => analyzeClosingStyle(content.content)),
        commonPatterns: identifyCommonPatterns(previousContents),
        suggestionForNext: generateSuggestionForNext(previousContents)
      };
      
      console.log('📊 前面內容分析結果:', analysis);
      return analysis;
    }

    // 生成避免重複的措施
    function generateAvoidanceMeasures(previousAnalysis, currentIndex) {
      const measures = [];
      
      if (previousAnalysis.openingStyles && previousAnalysis.openingStyles.length > 0) {
        const usedOpenings = previousAnalysis.openingStyles.join('、');
        measures.push(`開頭避免使用: ${usedOpenings}`);
      }
      
      if (previousAnalysis.contentLengths && previousAnalysis.contentLengths.length > 0) {
        const avgLength = previousAnalysis.contentLengths.reduce((a, b) => a + b, 0) / previousAnalysis.contentLengths.length;
        const targetLength = currentIndex % 2 === 0 ? avgLength + 100 : avgLength - 50;
        measures.push(`目標長度: ${Math.max(150, targetLength)} 字`);
      }
      
      if (previousAnalysis.commonPatterns && previousAnalysis.commonPatterns.length > 0) {
        measures.push(`避免模式: ${previousAnalysis.commonPatterns[0]}`);
      }
      
      measures.push(`強制差異化第 ${currentIndex + 1} 篇`);
      
      return measures.join(' | ');
    }

    // 循序漸進內容顯示
    function displayProgressiveContent(generatedContents, baseFormData) {
      const contentHtml = generatedContents.map((item, i) => {
        const variation = item.variation;
        const transformations = item.transformations || [];
        const isJab = baseFormData.contentType.includes('jab');
        const colorTheme = isJab ? 'green' : 'red';
        const bgGradient = isJab ? 'from-green-50 to-emerald-50' : 'from-red-50 to-pink-50';
        const borderColor = isJab ? 'border-green-400' : 'border-red-400';
        const textColor = isJab ? 'text-green-700' : 'text-red-700';
        
        return `
          <div class="p-4 bg-gradient-to-r ${bgGradient} rounded-lg shadow-sm border-l-4 ${borderColor} mb-3">
            <div class="flex justify-between items-center mb-2">
              <div class="font-medium ${textColor}">
                ${isJab ? '🥊' : '💥'} 內容 ${i + 1} 
                <span class="text-xs bg-white px-2 py-1 rounded ml-2 shadow-sm">
                  ${variation.jabStrategy}
                </span>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">
                  🔧 ${transformations.length}項轉換
                </span>
                <span class="text-xs text-gray-500">${item.generatedAt.substring(11, 19)}</span>
              </div>
            </div>
            
            ${transformations.length > 0 ? `
              <div class="mb-2 p-2 bg-white rounded text-xs">
                <div class="font-medium text-gray-700 mb-1">🚀 強制差異化轉換：</div>
                <div class="text-gray-600">${transformations.slice(0, 3).join(' | ')}${transformations.length > 3 ? '...' : ''}</div>
              </div>
            ` : ''}
            
            <div class="text-gray-800 text-sm bg-white p-3 rounded mb-2 leading-relaxed whitespace-pre-line">${item.content}</div>
            
            <div class="text-xs ${textColor}">
              <strong>策略:</strong> ${variation.structuralFramework} | 
              <strong>差異化:</strong> ${variation.differentiationFocus}
            </div>
          </div>
        `;
      }).join('');
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <h3 class="font-semibold text-blue-700 mb-2">🎯 強制差異化生成進度</h3>
          <div class="text-sm text-blue-600 mb-2">
            已完成: ${generatedContents.length} 篇 | 每篇都經過7層差異化轉換處理
          </div>
          <div class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded">
            ✅ 結構轉換 ✅ 語言風格 ✅ 社交格式 ✅ 開頭結尾 ✅ 視覺元素 ✅ 互動設計 ✅ 相似度檢查
          </div>
        </div>
        ${contentHtml}
      `;
    }

    // 輔助函數
    function analyzeOpeningStyle(content) {
      if (content.startsWith('你是否')) return '疑問開場';
      if (content.includes('想像一下') || content.includes('假設')) return '情境開場';
      if (content.match(/^\d+/)) return '數據開場';
      if (content.includes('💡') || content.includes('🤔')) return '表情開場';
      return '一般開場';
    }
    
    function analyzeClosingStyle(content) {
      if (content.includes('你覺得') || content.includes('你認為')) return '提問結尾';
      if (content.includes('立即') || content.includes('馬上')) return '行動結尾';
      if (content.includes('分享') || content.includes('留言')) return '互動結尾';
      return '一般結尾';
    }
    
    function identifyCommonPatterns(contents) {
      // 簡化的模式識別
      return ['重複表情符號', '相似結構', '類似語調'];
    }
    
    function generateSuggestionForNext(contents) {
      return `建議下一篇採用與前${contents.length}篇完全不同的風格`;
    }
    
    function getUniqueValueType(index, analysis) {
      const types = ['教育啟發', '情感共鳴', '實用指導', '娛樂互動', '專業權威', '趨勢洞察'];
      return types[index % types.length];
    }
    
    function getUniquePlatformApproach(index, platform, analysis) {
      const approaches = {
        'Facebook': ['對話式', '故事性', '分享式', '討論式'],
        'Instagram': ['視覺化', '分段式', 'hashtag式', '美學式'],
        'LinkedIn': ['專業式', '數據式', '洞察式', '建議式']
      };
      const platformApproaches = approaches[platform] || ['通用式', '適應式', '原生式', '創新式'];
      return platformApproaches[index % platformApproaches.length];
    }
    
    function getUniqueEmotionalConnection(index, analysis) {
      const connections = ['同理共鳴', '激勵鼓舞', '溫暖陪伴', '挑戰思考', '安全感提供', '成就感激發'];
      return connections[index % connections.length];
    }
    
    function getUniqueLanguageStyle(index, analysis) {
      const styles = ['親切對話', '專業指導', '溫暖分享', '理性分析', '感性表達', '幽默輕鬆'];
      return styles[index % styles.length];
    }
    
    function getUniqueElements(index, total) {
      return {
        emojiLevel: index % 3 === 0 ? '豐富' : index % 3 === 1 ? '適中' : '簡約',
        questionCount: index % 2 + 1,
        paragraphCount: index % 3 + 2,
        callToAction: index >= total / 2 ? '包含' : '不包含'
      };
    }
    
    function getPlatformOptimization(platform, index) {
      return {
        Facebook: index % 2 === 0 ? '對話互動優化' : '分享擴散優化',
        Instagram: index % 2 === 0 ? '視覺吸引優化' : 'hashtag策略優化',
        LinkedIn: index % 2 === 0 ? '專業價值優化' : '職場洞察優化'
      }[platform] || '通用優化';
    }
    
    function getInteractionStyle(index) {
      const styles = ['開放討論', '直接提問', '分享邀請', '反思引導', '行動鼓勵'];
      return styles[index % styles.length];
    }

    // 🚀 強制內容差異化系統 - 確保每篇文章完全不同
    async function forceContentDifferentiation(rawContent, previousContents, currentVariation, index, baseFormData) {
      console.log(`🔧 開始強制差異化第 ${index + 1} 篇內容`);
      
      let processedContent = rawContent;
      const transformations = [];
      
      // 1. 結構性轉換 - 基於索引應用不同的結構
      processedContent = applyStructuralTransformation(processedContent, index, transformations);
      
      // 2. 語言風格轉換
      processedContent = applyLanguageStyleTransformation(processedContent, index, transformations);
      
      // 3. 社交媒體格式優化
      processedContent = applySocialMediaFormatting(processedContent, baseFormData.platform, index, transformations);
      
      // 4. 開頭結尾強制差異化
      processedContent = applyOpeningClosingDifferentiation(processedContent, index, transformations);
      
      // 5. 表情符號和視覺元素差異化
      processedContent = applyVisualElementDifferentiation(processedContent, index, transformations);
      
      // 6. 互動元素差異化
      processedContent = applyInteractionDifferentiation(processedContent, index, transformations);
      
      // 7. 檢查與前面內容的相似度並進一步調整
      if (previousContents.length > 0) {
        processedContent = await avoidSimilarityWithPrevious(processedContent, previousContents, index, transformations);
      }
      
      console.log(`✅ 第 ${index + 1} 篇差異化完成，應用了 ${transformations.length} 項轉換`);
      
      return {
        content: processedContent,
        transformations: transformations
      };
    }

    // 結構性轉換
    function applyStructuralTransformation(content, index, transformations) {
      const structures = [
        {
          name: '問題解決型',
          apply: (text) => {
            // 將內容重新組織為：問題提出 → 分析 → 解決方案 → 行動建議
            const sentences = text.split(/[。！？]/).filter(s => s.trim());
            if (sentences.length >= 4) {
              return `🤔 ${sentences[0]}？\n\n💭 ${sentences[1]}。\n\n💡 ${sentences[2]}。\n\n🚀 ${sentences.slice(3).join('。')}！`;
            }
            return `🤔 你是否也遇到這樣的困擾？\n\n${text}\n\n💪 一起來解決這個問題吧！`;
          }
        },
        {
          name: '故事敘述型',
          apply: (text) => {
            // 將內容包裝成故事形式
            const sentences = text.split(/[。！？]/).filter(s => s.trim());
            return `📖 分享一個真實的故事...\n\n${sentences[0]}。想像一下，${sentences.slice(1).join('。')}\n\n✨ 這就是為什麼我們需要改變的原因。`;
          }
        },
        {
          name: '對比分析型',
          apply: (text) => {
            // 創建對比結構
            const mid = Math.floor(text.length / 2);
            const part1 = text.substring(0, mid);
            const part2 = text.substring(mid);
            return `⚖️ 讓我們來看兩個不同的角度：\n\n❌ 過去的做法：\n${part1}\n\n✅ 更好的方式：\n${part2}\n\n你會選擇哪一種？`;
          }
        },
        {
          name: '列表指南型',
          apply: (text) => {
            // 轉換為步驟列表
            const sentences = text.split(/[。！？]/).filter(s => s.trim());
            const steps = sentences.slice(0, Math.min(5, sentences.length));
            return `📋 完整指南來了：\n\n${steps.map((step, i) => `${i + 1}️⃣ ${step}`).join('\n\n')}\n\n💡 照著做，你也能做到！`;
          }
        },
        {
          name: '反思啟發型',
          apply: (text) => {
            // 轉換為反思性內容
            return `🤲 停下來想一想...\n\n${text}\n\n🌟 也許，真正的改變就從這個想法開始。\n\n你準備好了嗎？`;
          }
        }
      ];
      
      const structure = structures[index % structures.length];
      const transformedContent = structure.apply(content);
      transformations.push(`結構轉換: ${structure.name}`);
      
      return transformedContent;
    }

    // 語言風格轉換
    function applyLanguageStyleTransformation(content, index, transformations) {
      const styles = [
        {
          name: '親切對話風',
          apply: (text) => text.replace(/你/g, '你').replace(/。/g, '～').replace(/！/g, '！😊')
        },
        {
          name: '專業權威風',
          apply: (text) => text.replace(/我覺得/g, '根據研究顯示').replace(/可能/g, '必然').replace(/。/g, '。')
        },
        {
          name: '激勵鼓舞風',
          apply: (text) => text.replace(/可以/g, '一定可以').replace(/嘗試/g, '勇敢行動').replace(/。/g, '！💪')
        },
        {
          name: '溫暖分享風',
          apply: (text) => `❤️ ${text}`.replace(/。/g, '。🌟').replace(/問題/g, '挑戰')
        },
        {
          name: '幽默輕鬆風',
          apply: (text) => text.replace(/很重要/g, '超重要').replace(/需要/g, '必須').replace(/。/g, '啦！😄')
        }
      ];
      
      const style = styles[index % styles.length];
      const transformedContent = style.apply(content);
      transformations.push(`語言風格: ${style.name}`);
      
      return transformedContent;
    }

    // 社交媒體格式優化
    function applySocialMediaFormatting(content, platform, index, transformations) {
      const formats = {
        'Facebook': [
          (text) => {
            // Facebook格式：短段落 + 表情符號
            const paragraphs = text.split('\n\n');
            return paragraphs.map(p => p.length > 100 ? 
              p.split('。').join('。\n') : p
            ).join('\n\n');
          },
          (text) => {
            // Facebook格式：對話式
            return `嗨朋友們！👋\n\n${text}\n\n你們有什麼想法嗎？留言跟我分享！ 💬`;
          }
        ],
        'Instagram': [
          (text) => {
            // Instagram格式：短行 + hashtag
            return text.split('。').join('。\n・\n').replace(/\n\n/g, '\n\n📷 ') + '\n\n#生活分享 #正能量 #成長 #日常';
          },
          (text) => {
            // Instagram視覺化格式
            return `✨ ${text.split('。')[0]}。\n\n📸 ${text.split('。').slice(1).join('。')}\n\n💫 記得點讚告訴我你喜歡！`;
          }
        ],
        'LinkedIn': [
          (text) => {
            // LinkedIn專業格式
            return `💼 職場分享：\n\n${text}\n\n🔗 你在職場上有類似經驗嗎？歡迎在評論區分享你的看法。`;
          },
          (text) => {
            // LinkedIn洞察格式
            return `🎯 深度觀察：\n\n${text}\n\n📊 這是我在多年工作中觀察到的現象，你認為如何？`;
          }
        ]
      };
      
      const platformFormats = formats[platform] || formats['Facebook'];
      const formatFunction = platformFormats[index % platformFormats.length];
      const transformedContent = formatFunction(content);
      transformations.push(`${platform}平台格式化`);
      
      return transformedContent;
    }

    // 開頭結尾差異化
    function applyOpeningClosingDifferentiation(content, index, transformations) {
      const openings = [
        '🌅 早安！今天想跟大家分享...',
        '💭 突然想到一個重要的事情...',
        '📚 最近學到一個很棒的概念...',
        '🎯 有個問題一直在我心中...',
        '✨ 剛剛經歷了一件很有意思的事...'
      ];
      
      const closings = [
        '\n\n💬 你有什麼想法？留言跟我說！',
        '\n\n🌟 希望對你有幫助，記得分享給需要的朋友！',
        '\n\n🤔 你會怎麼做？我很好奇大家的想法！',
        '\n\n💪 一起努力，一起成長！',
        '\n\n📩 有問題可以私訊我，很樂意聊聊！'
      ];
      
      // 移除原有的開頭結尾，添加新的
      let processedContent = content.trim();
      
      // 添加獨特開頭
      const opening = openings[index % openings.length];
      processedContent = `${opening}\n\n${processedContent}`;
      
      // 添加獨特結尾
      const closing = closings[index % closings.length];
      processedContent = processedContent + closing;
      
      transformations.push(`開頭結尾差異化`);
      
      return processedContent;
    }

    // 表情符號和視覺元素差異化
    function applyVisualElementDifferentiation(content, index, transformations) {
      const emojiSets = [
        ['🌟', '✨', '💫', '⭐', '🌈'], // 閃亮系列
        ['💪', '🚀', '🎯', '⚡', '🔥'], // 力量系列
        ['❤️', '🌸', '🌺', '💝', '🌹'], // 溫暖系列
        ['📚', '💡', '🧠', '📖', '✏️'], // 學習系列
        ['🎉', '🎊', '🥳', '🎈', '🎁']  // 慶祝系列
      ];
      
      const emojiSet = emojiSets[index % emojiSets.length];
      let processedContent = content;
      
      // 隨機插入不同的表情符號
      const sentences = processedContent.split('。');
      processedContent = sentences.map((sentence, i) => {
        if (sentence.trim() && i < emojiSet.length) {
          return sentence + '。 ' + emojiSet[i % emojiSet.length];
        }
        return sentence + (sentence.trim() ? '。' : '');
      }).join(' ');
      
      transformations.push(`視覺元素: ${emojiSet.join('')}`);
      
      return processedContent;
    }

    // 互動元素差異化
    function applyInteractionDifferentiation(content, index, transformations) {
      const interactions = [
        (text) => text + '\n\n🗳️ 投票：你同意這個觀點嗎？\n👍 同意 | 👎 不同意',
        (text) => text + '\n\n🎮 小挑戰：試試看這個方法，然後回來跟我分享結果！',
        (text) => text + '\n\n📝 作業時間：在評論寫下你的三個行動計畫！',
        (text) => text + '\n\n🤝 找朋友：標記一個需要看到這篇的朋友！',
        (text) => text + '\n\n💭 反思時間：花30秒想想，這對你的生活有什麼啟發？'
      ];
      
      const interaction = interactions[index % interactions.length];
      const transformedContent = interaction(content);
      transformations.push(`互動元素: 類型${index + 1}`);
      
      return transformedContent;
    }

    // 避免與前面內容相似
    async function avoidSimilarityWithPrevious(content, previousContents, index, transformations) {
      let processedContent = content;
      
      // 檢查關鍵詞重複
      const previousTexts = previousContents.map(item => item.content);
      const currentWords = processedContent.match(/\b\w+\b/g) || [];
      
      // 如果發現重複的關鍵詞太多，進行同義詞替換
      const synonymReplacements = {
        '重要': ['關鍵', '核心', '重點', '要緊', '關鍵性'],
        '方法': ['策略', '技巧', '做法', '路徑', '秘訣'],
        '問題': ['挑戰', '困難', '障礙', '課題', '難題'],
        '成功': ['成就', '達成', '實現', '完成', '勝利'],
        '學習': ['學會', '掌握', '了解', '領悟', '吸收']
      };
      
      for (const [original, synonyms] of Object.entries(synonymReplacements)) {
        if (processedContent.includes(original)) {
          const replacement = synonyms[index % synonyms.length];
          processedContent = processedContent.replace(new RegExp(original, 'g'), replacement);
          transformations.push(`同義詞替換: ${original}→${replacement}`);
        }
      }
      
      // 如果內容長度相似，調整長度
      const averagePreviousLength = previousTexts.length > 0 ? 
        previousTexts.reduce((sum, text) => sum + text.length, 0) / previousTexts.length : 0;
      
      if (Math.abs(processedContent.length - averagePreviousLength) < 50) {
        if (index % 2 === 0) {
          // 擴展內容
          processedContent += '\n\n💡 補充說明：這個觀點值得我們深入思考，因為它不僅影響當下，更關係到未來的發展方向。';
          transformations.push('內容擴展');
        } else {
          // 精簡內容
          const sentences = processedContent.split('。');
          processedContent = sentences.slice(0, Math.max(2, sentences.length - 1)).join('。') + '。';
          transformations.push('內容精簡');
        }
      }
      
      return processedContent;
    }

    // 基於Jab理論的強化多樣性生成函數
    function generateDiversityKeywords() {
      // Jab核心價值類型
      const jabValueTypes = [
        '教育啟發價值', '娛樂互動價值', '情感共鳴價值', '實用工具價值', 
        '社群歸屬價值', '專業權威價值', '創新思維價值', '生活美學價值',
        '成長激勵價值', '問題解決價值', '趨勢洞察價值', '文化認同價值'
      ];
      
      // 平台原生表達方式
      const platformNativeApproaches = [
        'Facebook對話式故事', 'Instagram視覺化分段', 'LinkedIn專業數據分析', 
        'Twitter觀點式金句', 'YouTube深度教學式', 'TikTok趨勢挑戰式',
        '個人經驗分享式', '案例研究式', '步驟指導式', '對比分析式',
        '問答互動式', '清單總結式', '場景描述式', '反思思考式'
      ];
      
      // 情感連結層次
      const emotionalConnections = [
        '同理心共鳴', '成就感激勵', '歸屬感建立', '安全感提供', 
        '好奇心激發', '成長感啟發', '認同感強化', '幸福感傳遞',
        '挑戰感鼓舞', '溫暖感陪伴', '新鮮感驚喜', '價值感肯定'
      ];

      // 內容結構框架（確保每篇不同）
      const structureFrameworks = [
        '問題-洞察-解決方案', '故事-教訓-應用', '現況-趨勢-建議',
        '挑戰-策略-成果', '觀察-分析-行動', '經驗-反思-分享',
        '發現-驗證-推廣', '困難-突破-成長', '需求-方法-效益',
        '現象-原因-對策', '目標-路徑-實現', '疑問-探索-答案'
      ];

      // 語言風格變化（基於Jab理論的自然度）
      const languageStyles = [
        '親切朋友式對話', '專業導師式指導', '溫暖長輩式分享', '活力同伴式互動',
        '睿智觀察家式', '實務經驗家式', '創意發想家式', '理性分析家式',
        '感性故事家式', '幽默陪伴者式', '激勵教練式', '溫柔引導者式'
      ];

      // 獨特角度切入點
      const uniquePerspectives = [
        '新手視角發現', '專家深度剖析', '跨界思維連結', '逆向思考挑戰',
        '文化背景觀察', '世代差異洞察', '性別視角分析', '職業特色角度',
        '地域文化特色', '時間軸演變', '價值觀衝突', '生活型態差異'
      ];
      
      return {
        jabValue: jabValueTypes[Math.floor(Math.random() * jabValueTypes.length)],
        platformApproach: platformNativeApproaches[Math.floor(Math.random() * platformNativeApproaches.length)],
        emotionalLayer: emotionalConnections[Math.floor(Math.random() * emotionalConnections.length)],
        structureType: structureFrameworks[Math.floor(Math.random() * structureFrameworks.length)],
        languageStyle: languageStyles[Math.floor(Math.random() * languageStyles.length)],
        uniqueAngle: uniquePerspectives[Math.floor(Math.random() * uniquePerspectives.length)]
      };
    }

    function generateStyleVariations(baseStyle) {
      const jabTheoryVariations = {
        '原生價值導向': ['平台自然融入', '價值優先呈現', '社群文化適應', '無壓力給予'],
        '故事情感型': ['個人經驗分享', '情感共鳴觸發', '生活場景連結', '溫暖人性化'],
        '教育分享型': ['專業知識傳遞', '技能提升指導', '學習價值創造', '成長啟發'],
        '娛樂親和型': ['輕鬆幽默互動', '親和力建立', '正向情緒傳遞', '社群娛樂'],
        '啟發思考型': ['深度觀點分享', '思維角度拓展', '洞察力提供', '智慧啟發'],
        '實用指導型': ['具體步驟指南', '實作價值提供', '問題解決導向', '立即應用'],
        '社群互動型': ['對話參與促進', '社群連結強化', '互動價值創造', '關係建立'],
        '趨勢洞察型': ['前瞻視野分享', '趨勢分析價值', '未來思考啟發', '洞察智慧']
      };
      
      const baseVariations = jabTheoryVariations[baseStyle] || ['Jab價值創造', 'Right Hook行動', '原生表達', '情感連結'];
      return baseVariations[Math.floor(Math.random() * baseVariations.length)];
    }

    function generateRequestId() {
      return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // 基於Jab理論的內容差異化限制條件
    function generateContentConstraints(index, total) {
      // Jab vs Right Hook 差異化要求
      const jabRightHookModes = [
        'pure_jab_education', 'pure_jab_entertainment', 'pure_jab_inspiration',
        'soft_right_hook', 'direct_right_hook', 'story_based_jab',
        'data_driven_jab', 'emotional_jab', 'practical_jab'
      ];
      
      // 內容結構模板（確保截然不同）
      const structuralTemplates = [
        '問題提出→深度分析→解決建議→價值總結',
        '故事開場→教訓提取→實用應用→感悟分享',
        '數據震撼→趨勢解讀→行動指南→未來展望',
        '個人經驗→反思洞察→通用原則→啟發邀請',
        '現象觀察→原因剖析→策略建議→行動呼籲',
        '對比分析→優劣評估→最佳實踐→學習建議',
        '案例研究→成功要素→複製方法→進階思考',
        '困難描述→突破過程→關鍵學習→成長分享'
      ];
      
      // 語言風格強制差異
      const languageMandates = [
        '第一人稱親身經驗敘述', '第二人稱直接對話式', '第三人稱客觀分析式',
        '問答自問自答式', '列表條理化呈現', '對話情境模擬式',
        '比喻類比說明式', '數據圖表描述式', '時間順序敘述式'
      ];
      
      // 情感調性差異
      const emotionalTones = [
        '溫暖鼓勵支持調性', '專業權威指導調性', '輕鬆幽默互動調性',
        '深度思考啟發調性', '急迫行動呼籲調性', '溫和建議分享調性',
        '激勵鼓舞挑戰調性', '理性客觀分析調性', '感性共鳴連結調性'
      ];
      
      // 內容開頭方式（強制不同）
      const openingStyles = [
        '問題提問開場', '數據震撼開場', '故事情境開場', '個人感悟開場',
        '趨勢觀察開場', '對比衝突開場', '場景描述開場', '名言引用開場',
        '反思質疑開場', '經驗分享開場', '未來預測開場', '現況描述開場'
      ];
      
      // 結尾呼籲方式
      const closingStyles = [
        '開放式思考邀請', '具體行動建議', '社群互動呼籲', '進一步學習建議',
        '個人經驗分享邀請', '未來展望分享', '反思問題提出', '實踐挑戰發起',
        '資源推薦提供', '社群連結建立', '持續關注邀請', '價值確認強化'
      ];
      
      // 基於索引和總數創建獨特組合
      const uniqueSeed = (index + 1) * (total + 1) * Date.now();
      
      return {
        // Jab理論應用
        jabMode: jabRightHookModes[index % jabRightHookModes.length],
        structuralTemplate: structuralTemplates[index % structuralTemplates.length],
        languageMandate: languageMandates[index % languageMandates.length],
        emotionalTone: emotionalTones[index % emotionalTones.length],
        openingStyle: openingStyles[index % openingStyles.length],
        closingStyle: closingStyles[index % closingStyles.length],
        
        // 強制差異化要求
        mustDiffer: true,
        contentNumber: index + 1,
        totalCount: total,
        uniquenessSeed: uniqueSeed,
        
        // 特殊差異化指令
        differentiation: {
          structural: `必須使用與其他${total-1}篇完全不同的結構模板`,
          tonal: `情感調性必須與其他篇章形成鮮明對比`,
          linguistic: `語言風格必須展現獨特的表達方式`,
          perspective: `切入角度必須提供全新的觀點視野`,
          format: `內容格式必須呈現不同的組織方式`
        },
        
        // Jab價值差異化
        jabValueDifferentiation: index === 0 ? '教育啟發主導' : 
                                index === 1 ? '情感連結主導' :
                                index === 2 ? '實用價值主導' :
                                index === 3 ? '娛樂互動主導' :
                                '綜合價值創新'
      };
    }

    function generateContentVariationLabel(index, formData) {
      // 基於Jab理論的內容類型
      const jabTheoryTypes = [
        'Jab教育型', 'Jab娛樂型', 'Jab啟發型', 'Jab共鳴型', 'Jab實用型',
        'Right Hook軟性', 'Right Hook直接', 'Jab故事型', 'Jab專業型', 'Jab互動型'
      ];
      
      // 平台原生角度
      const platformNativeAngles = [
        'Facebook對話風', 'Instagram視覺風', 'LinkedIn專業風', 'Twitter觀點風',
        '個人經驗分享', '專業洞察分析', '生活場景連結', '趨勢觀察解讀',
        '情感故事敘述', '實用技巧指導', '深度思考啟發', '輕鬆幽默互動'
      ];
      
      // 根據內容類型決定Jab標籤
      const contentTypeLabels = {
        'jab': 'Jab純粹給予',
        'right_hook': 'Right Hook行動',
        'jab_story': 'Jab故事價值',
        'jab_education': 'Jab教育價值',
        'jab_entertainment': 'Jab娛樂價值',
        'right_hook_soft': 'Right Hook溫和',
        'right_hook_direct': 'Right Hook直接'
      };
      
      // 基於索引確保每篇都不同
      const typeIndex = index % jabTheoryTypes.length;
      const angleIndex = (index + 1) % platformNativeAngles.length;
      
      const baseLabel = contentTypeLabels[formData.contentType] || 'Jab價值型';
      const variationType = jabTheoryTypes[typeIndex];
      const angleType = platformNativeAngles[angleIndex];
      
      return `${baseLabel}・${variationType}・${angleType}`;
    }

    // 實用函數
    function copyToClipboard(button, text, index) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = '✅ 已複製';
        button.style.backgroundColor = '#10b981';
        button.style.color = 'white';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
          button.style.color = '';
        }, 2000);
      }).catch(() => {
        showSystemMessage('❌ 複製失敗，請手動選擇文字', 'error');
      });
    }

    function regenerateContent() {
      if (STATE.lastGenerated) {
        document.getElementById('topic').value = STATE.lastGenerated.formData.topic;
        elements.contentForm.dispatchEvent(new Event('submit'));
      }
    }

    function optimizeContent() {
      if (STATE.lastGenerated) {
        const content = STATE.lastGenerated.contents[0];
        elements.chatInput.value = `請幫我分析並優化這個內容：\n\n${content}`;
        elements.chatForm.dispatchEvent(new Event('submit'));
      }
    }

         // 額外實用函數
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('❌ 請先連接到伺服器', 'error');
         return;
       }
       
       try {
         showSystemMessage('🧪 測試API連線中...', 'info');
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: AbortSignal.timeout(10000)
         });
         
         const data = await response.json();
         if (response.ok) {
           showSystemMessage('✅ API連線正常！', 'success');
         } else {
           showSystemMessage(`❌ API測試失敗: ${data.error || '未知錯誤'}`, 'error');
         }
       } catch (error) {
         showSystemMessage(`❌ API測試失敗: ${error.message}`, 'error');
       }
     }
     
     function showApiGuide() {
       const guideContent = `
         <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto p-6">
             <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-bold text-gray-800">🔑 OpenRouter API 設定指南</h3>
               <button onclick="closeApiGuide()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
             </div>
             
             <div class="space-y-4 text-sm">
               <div class="bg-blue-50 p-4 rounded">
                 <h4 class="font-medium text-blue-800 mb-2">📝 步驟 1: 申請API金鑰</h4>
                 <p class="text-blue-700">前往 <a href="https://openrouter.ai/keys" target="_blank" class="underline">OpenRouter.ai</a> 註冊帳號並創建API金鑰</p>
               </div>
               
               <div class="bg-green-50 p-4 rounded">
                 <h4 class="font-medium text-green-800 mb-2">📄 步驟 2: 創建 .env 檔案</h4>
                 <p class="text-green-700 mb-2">在專案根目錄創建 .env 檔案，內容如下：</p>
                 <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">OPENROUTER_API_KEY=sk-or-v1-你的實際金鑰
PORT=3001
DEBUG=true</pre>
               </div>
               
               <div class="bg-orange-50 p-4 rounded">
                 <h4 class="font-medium text-orange-800 mb-2">🔄 步驟 3: 重新啟動</h4>
                 <p class="text-orange-700">在終端機執行 <code class="bg-gray-100 px-1 rounded">npm start</code> 重新啟動伺服器</p>
               </div>
               
               <div class="bg-purple-50 p-4 rounded">
                 <h4 class="font-medium text-purple-800 mb-2">💡 免費額度說明</h4>
                 <ul class="text-purple-700 space-y-1">
                   <li>• 新用戶有 $5 免費額度</li>
                   <li>• 部分模型完全免費使用</li>
                   <li>• DeepSeek 模型性價比極高</li>
                 </ul>
               </div>
             </div>
             
             <div class="mt-6 flex justify-end space-x-2">
               <a href="https://openrouter.ai/keys" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                 🔗 前往申請金鑰
               </a>
               <button onclick="closeApiGuide()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition">
                 關閉
               </button>
             </div>
           </div>
         </div>
       `;
       
       document.body.insertAdjacentHTML('beforeend', guideContent);
     }
     
     function closeApiGuide() {
       const guide = document.querySelector('.fixed.inset-0');
       if (guide) guide.remove();
     }

     // 檢查伺服器日誌（超時錯誤專用）
     function checkServerLogs() {
       showSystemMessage('💡 請查看黑色控制台視窗（伺服器日誌），內容可能已經成功生成', 'info');
       // 嘗試檢查最近的健康狀態
       if (STATE.currentServer) {
         fetch(`${STATE.currentServer}/health`)
           .then(response => response.json())
           .then(data => {
             console.log('🏥 伺服器健康狀態:', data);
             showSystemMessage('✅ 伺服器運行正常，請檢查控制台的詳細日誌', 'success');
           })
           .catch(err => {
             console.error('❌ 健康檢查失敗:', err);
           });
       }
     }

     // 重試生成（減少數量）
     function retryWithReducedCount() {
       if (STATE.isGenerating) return;
       
       // 設定為1篇內容
       document.getElementById('count').value = '1';
       showSystemMessage('🔄 重新嘗試生成 1 篇內容...', 'info');
       
       // 重新提交表單
       setTimeout(() => {
         elements.contentForm.dispatchEvent(new Event('submit'));
       }, 1000);
     }

     // 增強的API測試
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('❌ 請先連接到伺服器', 'error');
         return;
       }
       
       try {
         showSystemMessage('🧪 測試API連線中...', 'info');
         updateGenerateButton(true);
         
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: new AbortController().signal
         });
         
         const data = await response.json();
         if (response.ok && data.success) {
           showSystemMessage(`✅ API連線正常！AI回應: ${data.response || 'OK'}`, 'success');
           console.log('🧪 API測試結果:', data);
         } else {
           showSystemMessage(`❌ API測試失敗: ${data.error || '未知錯誤'}`, 'error');
         }
       } catch (error) {
         console.error('❌ API測試錯誤:', error);
         showSystemMessage(`❌ API測試失敗: ${error.message}`, 'error');
       } finally {
         updateGenerateButton(false);
       }
     }

     // 停用定期檢查以避免干擾（調試期間）
     console.log('ℹ️ 定期健康檢查已停用，避免干擾內容生成');
     /*
     setInterval(() => {
       if (STATE.isConnected) {
         fetch(`${STATE.currentServer}/health`)
           .catch(() => {
             STATE.isConnected = false;
             updateConnectionStatus('offline', '❌ 連線中斷');
             showSystemMessage('⚠️ 與伺服器的連線已中斷', 'warning');
           });
       }
     }, 30000);
     */
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIå…§å®¹ç”Ÿç”¢å™¨èˆ‡æ™ºèƒ½åŠ©æ‰‹ - ä¿®å¾©ç‰ˆæœ¬</title>
  <link href="../input.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    .loading { animation: pulse 2s infinite; }
    .error-shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .status-online { background: #10b981; color: white; }
    .status-offline { background: #ef4444; color: white; }
    .status-checking { background: #f59e0b; color: white; }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-8">
  <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
  <div id="connectionStatus" class="connection-status status-checking">
    ğŸ”„ æª¢æ¸¬ä¸­...
  </div>

  <!-- ä¸»è¦å…§å®¹ç”Ÿç”¢å™¨ -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8 mb-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-blue-700">ğŸ“ AIå…§å®¹ç”Ÿç”¢å™¨</h1>
        <div class="text-xs text-green-600 font-medium mt-1">ğŸ”§ ä¿®å¾©ç‰ˆæœ¬ v2.0 - è¶…æ™‚å•é¡Œå·²è§£æ±º</div>
      </div>
      <div class="text-sm text-gray-500">
        <span id="serverInfo">ä¼ºæœå™¨: æœªé€£æ¥</span>
      </div>
    </div>

    <form id="contentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- åŸºæœ¬è¨­å®š -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">åŸºæœ¬è¨­å®š</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">ä¸»é¡Œ *</span>
          <input type="text" id="topic" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" 
                 placeholder="ä¾‹ï¼šè·å ´å£“åŠ›ç®¡ç†ã€æ•¸ä½è¡ŒéŠ·ç­–ç•¥" required>
          <span class="text-xs text-gray-400">å…·é«”æ˜ç¢ºçš„ä¸»é¡Œæœƒç”¢ç”Ÿæ›´å¥½çš„å…§å®¹</span>
        </label>
        
        <label class="block">
          <span class="text-gray-700 font-medium">å…§å®¹å‹æ…‹</span>
          <select id="contentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="jab">ğŸ¥Š Jabï¼ˆé‹ªå¢Šå‹ï¼‰- å»ºç«‹é—œä¿‚èˆ‡ä¿¡ä»»</option>
            <option value="right_hook">ğŸ’¥ Right Hookï¼ˆä¸»æ‰“å‹ï¼‰- ä¿ƒé€²è¡Œå‹•å‘¼ç±²</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">ç”¢å‡ºæ•¸é‡</span>
          <select id="count" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="1">1 ç¯‡</option>
            <option value="2">2 ç¯‡</option>
            <option value="3" selected>3 ç¯‡</option>
            <option value="4">4 ç¯‡</option>
            <option value="5">5 ç¯‡</option>
          </select>
        </label>
      </div>

      <!-- å¹³å°èˆ‡é¢¨æ ¼ -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">å¹³å°èˆ‡é¢¨æ ¼</h3>
        <label class="block">
          <span class="text-gray-700 font-medium">ç›®æ¨™å¹³å°</span>
          <select id="platform" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="Facebook">ğŸ“˜ Facebook - ç¤¾ç¾¤äº’å‹•</option>
            <option value="Instagram">ğŸ“· Instagram - è¦–è¦ºå…§å®¹</option>
            <option value="Twitter">ğŸ¦ Twitter - å³æ™‚å‹•æ…‹</option>
            <option value="LinkedIn">ğŸ’¼ LinkedIn - å°ˆæ¥­ç¶²çµ¡</option>
            <option value="Pinterest">ğŸ“Œ Pinterest - å‰µæ„éˆæ„Ÿ</option>
            <option value="TikTok">ğŸµ TikTok - çŸ­å½±éŸ³</option>
            <option value="YouTube">ğŸ“º YouTube - é•·å½±éŸ³</option>
            <option value="é€šç”¨">ğŸŒ é€šç”¨å¹³å°</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">å…§å®¹é¢¨æ ¼</span>
          <select id="style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="åŸç”Ÿ">ğŸ¯ åŸç”Ÿé¢¨æ ¼ - èå…¥å¹³å°æ–‡åŒ–</option>
            <option value="éå¹²æ“¾">ğŸ¤ éå¹²æ“¾å‹ - è‡ªç„¶ä¸å¼·æ¨</option>
            <option value="å°‘è¦æ±‚">ğŸ’­ ä½å£“åŠ›å‹ - è¼•é¬†äº’å‹•</option>
            <option value="æµè¡Œæ–‡åŒ–">ğŸ”¥ æµè¡Œæ–‡åŒ– - çµåˆç†±é»</option>
            <option value="å¾®å‹">âš¡ å¾®å‹å…§å®¹ - ç°¡æ½”æœ‰åŠ›</option>
            <option value="å°ˆæ¥­">ğŸ‘” å°ˆæ¥­æ­£å¼ - æ¬Šå¨å¯ä¿¡</option>
            <option value="æƒ…æ„Ÿ">â¤ï¸ æƒ…æ„Ÿå…±é³´ - è§¸å‹•äººå¿ƒ</option>
          </select>
        </label>
      </div>

      <!-- æŠ€è¡“è¨­å®š -->
      <div class="space-y-4">
        <h3 class="font-semibold text-gray-700 border-b pb-2">æŠ€è¡“è¨­å®š</h3>
        <label class="block">
          <span class="text-gray-700 font-medium tooltip">AIæ¨¡å‹
            <span class="tooltiptext">ä¸åŒæ¨¡å‹æœ‰ä¸åŒç‰¹æ€§ï¼Œå¯å˜—è©¦åˆ‡æ›ç²å¾—æœ€ä½³æ•ˆæœ</span>
          </span>
          <select id="model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="tngtech/deepseek-r1t2-chimera:free">ğŸ§  DeepSeek R1T2 (æ¨è–¦)</option>
            <option value="tngtech/deepseek-r1t-chimera:free">ğŸ”¬ DeepSeek R1T (ç©©å®š)</option>
            <option value="openai/gpt-3.5-turbo">ğŸ’¨ GPT-3.5 Turbo (å¿«é€Ÿ)</option>
          </select>
        </label>

        <label class="block">
          <span class="text-gray-700 font-medium">å‰µæ„åº¦</span>
          <input type="range" id="creativity" min="0" max="100" value="70" class="mt-1 block w-full">
          <div class="flex justify-between text-xs text-gray-400">
            <span>ä¿å®ˆ</span>
            <span id="creativityValue">70%</span>
            <span>å‰µæ–°</span>
          </div>
        </label>

        <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 font-semibold shadow-lg mb-2">
          ğŸš€ ç”¢ç”Ÿå…§å®¹
        </button>
        
        <button type="button" id="quickTestBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-medium text-sm">
          ğŸ§ª å¿«é€Ÿæ¸¬è©¦ï¼ˆä¿®å¾©é©—è­‰ï¼‰
        </button>
      </div>
    </form>

    <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
    <div id="contentResult" class="space-y-4"></div>
  </div>

  <!-- AIæ™ºèƒ½åŠ©æ‰‹ -->
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</h2>
      <button id="clearChat" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition">æ¸…é™¤å°è©±</button>
    </div>

    <!-- å¿«é€Ÿè¨­å®š -->
    <div id="chatOptions" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">å…§å®¹å‹æ…‹</span>
        <select id="chatContentType" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="jab">ğŸ¥Š Jab</option>
          <option value="right_hook">ğŸ’¥ Right Hook</option>
          <option value="analysis">ğŸ“Š åˆ†æ</option>
          <option value="optimization">âš¡ å„ªåŒ–</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">å¹³å°</span>
        <select id="chatPlatform" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="Facebook">ğŸ“˜ Facebook</option>
          <option value="Instagram">ğŸ“· Instagram</option>
          <option value="Twitter">ğŸ¦ Twitter</option>
          <option value="LinkedIn">ğŸ’¼ LinkedIn</option>
          <option value="é€šç”¨">ğŸŒ é€šç”¨</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">é¢¨æ ¼</span>
        <select id="chatStyle" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="åŸç”Ÿ">ğŸ¯ åŸç”Ÿ</option>
          <option value="å°ˆæ¥­">ğŸ‘” å°ˆæ¥­</option>
          <option value="è¼•é¬†">ğŸ˜Š è¼•é¬†</option>
          <option value="å‰µæ„">ğŸ¨ å‰µæ„</option>
        </select>
      </label>
      <label class="block">
        <span class="text-gray-700 text-sm font-medium">èªèª¿</span>
        <select id="chatTone" class="mt-1 block w-full text-sm rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50">
          <option value="å‹å–„">ğŸ˜Š å‹å–„</option>
          <option value="æ­£å¼">ğŸ‘” æ­£å¼</option>
          <option value="ç†±æƒ…">ğŸ”¥ ç†±æƒ…</option>
          <option value="å†·éœ">ğŸ§˜ å†·éœ</option>
        </select>
      </label>
    </div>

    <!-- å°è©±çª—å£ -->
    <div id="chatWindow" class="h-80 overflow-y-auto bg-gradient-to-b from-gray-50 to-white rounded-lg p-4 mb-4 border space-y-3">
      <div class="text-center text-gray-400 text-sm">
        ğŸ’¬ æ­¡è¿ä½¿ç”¨AIåŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¹«ä½ å„ªåŒ–å…§å®¹ã€åˆ†æç­–ç•¥ã€æˆ–å›ç­”ä»»ä½•ç›¸é—œå•é¡Œ
      </div>
    </div>

    <!-- è¼¸å…¥å€åŸŸ -->
    <form id="chatForm" class="flex gap-3">
      <div class="flex-1 relative">
        <input type="text" id="chatInput" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 pr-12" 
               placeholder="è¼¸å…¥ä½ çš„å•é¡Œæˆ–æƒ³æ³•..." required>
        <div id="inputCounter" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">0</div>
      </div>
      <button type="submit" id="sendBtn" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 font-semibold">
        ğŸ“¤ é€å‡º
      </button>
    </form>

    <!-- å¿«é€Ÿæç¤º -->
    <div class="mt-4 flex flex-wrap gap-2">
      <span class="text-sm text-gray-500">å¿«é€Ÿæç¤ºï¼š</span>
      <button class="quick-prompt text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition" data-prompt="å¹«æˆ‘åˆ†æé€™å€‹å…§å®¹çš„å„ªç¼ºé»">ğŸ“Š åˆ†æå…§å®¹</button>
      <button class="quick-prompt text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition" data-prompt="å¦‚ä½•æå‡é€™å€‹è²¼æ–‡çš„äº’å‹•ç‡ï¼Ÿ">ğŸš€ æå‡äº’å‹•</button>
      <button class="quick-prompt text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition" data-prompt="çµ¦æˆ‘3å€‹ç›¸é—œçš„å…§å®¹å‰µæ„">ğŸ’¡ å…§å®¹å‰µæ„</button>
      <button class="quick-prompt text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition" data-prompt="ä»€éº¼æ™‚å€™ç™¼æ–‡æ•ˆæœæœ€å¥½ï¼Ÿ">â° ç™¼æ–‡æ™‚æ©Ÿ</button>
    </div>
  </div>

  <script>
    // å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç†
    const STATE = {
      isConnected: false,
      currentServer: null,
      isGenerating: false,
      isChatting: false,
      chatHistory: [],
      lastGenerated: null
    };

    // API é…ç½®
    const API_CONFIG = {
      ports: [3001, 3002, 3003, 3004, 3005, 3006, 3007, 3008, 3009, 3010, 3000, 8080, 5000],
      timeout: 120000, // å»¶é•·åˆ°120ç§’ï¼ˆ2åˆ†é˜ï¼‰ï¼Œçµ¦AIå……è¶³æ™‚é–“ç”Ÿæˆå…§å®¹
      retryAttempts: 2 // æ¸›å°‘é‡è©¦æ¬¡æ•¸é¿å…éé•·ç­‰å¾…
    };

    // DOM å…ƒç´ 
    const elements = {
      connectionStatus: document.getElementById('connectionStatus'),
      serverInfo: document.getElementById('serverInfo'),
      contentForm: document.getElementById('contentForm'),
      contentResult: document.getElementById('contentResult'),
      chatForm: document.getElementById('chatForm'),
      chatWindow: document.getElementById('chatWindow'),
      chatInput: document.getElementById('chatInput'),
      generateBtn: document.getElementById('generateBtn'),
      quickTestBtn: document.getElementById('quickTestBtn'),
      sendBtn: document.getElementById('sendBtn'),
      creativitySlider: document.getElementById('creativity'),
      creativityValue: document.getElementById('creativityValue'),
      inputCounter: document.getElementById('inputCounter'),
      clearChat: document.getElementById('clearChat')
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ AIå…§å®¹ç”Ÿç”¢å™¨ ä¿®å¾©ç‰ˆæœ¬ v2.0 è¼‰å…¥å®Œæˆ');
      console.log('ğŸ”§ ä¸»è¦ä¿®å¾©: è¶…æ™‚å•é¡Œã€ç€è¦½å™¨ç›¸å®¹æ€§ã€éŒ¯èª¤è™•ç†');
      
      initializeApp();
      setupEventListeners();
      detectServer();
      
      // é¡¯ç¤ºä¿®å¾©ç‰ˆæœ¬æç¤º
      setTimeout(() => {
        showSystemMessage('ğŸ‰ ä¿®å¾©ç‰ˆæœ¬å·²è¼‰å…¥ï¼è¶…æ™‚å•é¡Œå·²è§£æ±ºï¼Œæ”¯æ´2åˆ†é˜AIç”Ÿæˆæ™‚é–“', 'success');
      }, 2000);
    });

    // æ‡‰ç”¨åˆå§‹åŒ–
    function initializeApp() {
      // å‰µæ„åº¦æ»‘æ¡¿
      elements.creativitySlider.addEventListener('input', function() {
        elements.creativityValue.textContent = this.value + '%';
      });

      // è¼¸å…¥å­—æ•¸çµ±è¨ˆ
      elements.chatInput.addEventListener('input', function() {
        elements.inputCounter.textContent = this.value.length;
      });

      // å¿«é€Ÿæç¤ºæŒ‰éˆ•
      document.querySelectorAll('.quick-prompt').forEach(btn => {
        btn.addEventListener('click', function() {
          const prompt = this.dataset.prompt;
          elements.chatInput.value = prompt;
          elements.chatInput.focus();
        });
      });

      // æ¸…é™¤å°è©±
      elements.clearChat.addEventListener('click', function() {
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
          elements.chatWindow.innerHTML = '<div class="text-center text-gray-400 text-sm">ğŸ’¬ å°è©±å·²æ¸…é™¤ï¼Œé‡æ–°é–‹å§‹å§ï¼</div>';
          STATE.chatHistory = [];
        }
      });
    }

    // äº‹ä»¶ç›£è½å™¨è¨­ç½®
    function setupEventListeners() {
      elements.contentForm.addEventListener('submit', handleContentGeneration);
      elements.chatForm.addEventListener('submit', handleChatSubmission);
      
      // å¿«é€Ÿæ¸¬è©¦æŒ‰éˆ•
      if (elements.quickTestBtn) {
        elements.quickTestBtn.addEventListener('click', handleQuickTest);
      }

      // è¡¨å–®å³æ™‚é©—è­‰
      document.getElementById('topic').addEventListener('blur', validateTopic);
      
      // éµç›¤å¿«æ·éµ
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          if (document.activeElement === elements.chatInput) {
            handleChatSubmission(e);
          }
        }
      });
    }

    // ä¼ºæœå™¨åµæ¸¬
    async function detectServer() {
      updateConnectionStatus('checking', 'ğŸ”„ åµæ¸¬ä¼ºæœå™¨...');
      
      for (let port of API_CONFIG.ports) {
        try {
          const response = await fetch(`http://localhost:${port}/health`, {
            method: 'GET',
            signal: AbortSignal.timeout(2000)
          });
          
          if (response.ok) {
            STATE.currentServer = `http://localhost:${port}`;
            STATE.isConnected = true;
            updateConnectionStatus('online', `âœ… å·²é€£æ¥ (${port})`);
            elements.serverInfo.textContent = `ä¼ºæœå™¨: localhost:${port}`;
            break;
          }
        } catch (error) {
          console.log(`Port ${port} ä¸å¯ç”¨:`, error.message);
        }
      }

      if (!STATE.isConnected) {
        updateConnectionStatus('offline', 'âŒ ç„¡æ³•é€£æ¥');
        elements.serverInfo.textContent = 'ä¼ºæœå™¨: é›¢ç·š';
        showSystemMessage('âš ï¸ ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªä¼ºæœå™¨å·²å•Ÿå‹•', 'warning');
      }
    }

    // æ›´æ–°é€£ç·šç‹€æ…‹
    function updateConnectionStatus(status, text) {
      elements.connectionStatus.className = `connection-status status-${status}`;
      elements.connectionStatus.textContent = text;
    }

    // è¡¨å–®é©—è­‰
    function validateTopic() {
      const topic = document.getElementById('topic').value.trim();
      const topicField = document.getElementById('topic');
      
      if (topic.length < 2) {
        topicField.classList.add('border-red-300', 'error-shake');
        showSystemMessage('âŒ ä¸»é¡Œè‡³å°‘éœ€è¦2å€‹å­—ç¬¦', 'error');
        return false;
      } else {
        topicField.classList.remove('border-red-300', 'error-shake');
        return true;
      }
    }

    // å¿«é€Ÿæ¸¬è©¦åŠŸèƒ½
    async function handleQuickTest() {
      if (STATE.isGenerating) {
        showSystemMessage('âš ï¸ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...', 'warning');
        return;
      }
      
      if (!STATE.isConnected) {
        showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
        return;
      }
      
      // è‡ªå‹•å¡«å…¥æ¸¬è©¦æ•¸æ“š
      document.getElementById('topic').value = 'æ¸¬è©¦è¶…æ™‚ä¿®å¾©';
      document.getElementById('count').value = '1';
      document.getElementById('contentType').value = 'jab';
      document.getElementById('platform').value = 'Facebook';
      document.getElementById('style').value = 'éå¹²æ“¾å‹';
      document.getElementById('creativity').value = '70';
      
      showSystemMessage('ğŸ§ª é–‹å§‹å¿«é€Ÿæ¸¬è©¦ä¿®å¾©æ•ˆæœ...', 'info');
      console.log('ğŸ§ª === å¿«é€Ÿæ¸¬è©¦é–‹å§‹ ===');
      console.log('ğŸ“Š è¶…æ™‚è¨­å®š:', API_CONFIG.timeout, 'ms');
      console.log('ğŸ”„ é‡è©¦æ¬¡æ•¸:', API_CONFIG.retryAttempts);
      
      // è§¸ç™¼å…§å®¹ç”Ÿæˆ
      const fakeEvent = { preventDefault: () => {} };
      await handleContentGeneration(fakeEvent);
    }

    // å…§å®¹ç”Ÿæˆè™•ç†
    async function handleContentGeneration(e) {
      e.preventDefault();
      
      if (!validateTopic() || !STATE.isConnected || STATE.isGenerating) {
        return;
      }

      STATE.isGenerating = true;
      updateGenerateButton(true);

      const formData = {
        topic: document.getElementById('topic').value.trim(),
        count: document.getElementById('count').value,
        model: document.getElementById('model').value,
        contentType: document.getElementById('contentType').value,
        platform: document.getElementById('platform').value,
        style: document.getElementById('style').value,
        creativity: document.getElementById('creativity').value
      };

      showLoadingState();

      try {
        console.log('ğŸ“¤ é–‹å§‹ç™¼é€å…§å®¹ç”Ÿæˆè«‹æ±‚:', formData);
        
        const response = await fetchWithRetry(`${STATE.currentServer}/api/generate-content`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        console.log('ğŸ“¨ æ”¶åˆ°éŸ¿æ‡‰ï¼Œé–‹å§‹è§£æJSON...');
        const data = await response.json();
        console.log('âœ… JSONè§£ææˆåŠŸ:', data);
        
        if (data && Array.isArray(data.contents)) {
          displayGeneratedContent(data.contents, formData);
          STATE.lastGenerated = { contents: data.contents, formData };
          showSystemMessage('âœ… å…§å®¹ç”ŸæˆæˆåŠŸï¼', 'success');
        } else {
          console.error('âŒ æ•¸æ“šæ ¼å¼éŒ¯èª¤:', data);
          throw new Error(`è¿”å›æ•¸æ“šæ ¼å¼éŒ¯èª¤: ${JSON.stringify(data)}`);
        }
      } catch (error) {
        console.error('ğŸ’¥ å…§å®¹ç”Ÿæˆå®Œæ•´éŒ¯èª¤:', {
          message: error.message,
          name: error.name,
          stack: error.stack,
          isTimeout: error.isTimeout
        });
        
        // ç‰¹æ®Šè™•ç†è¶…æ™‚éŒ¯èª¤
        if (error.isTimeout || error.message.includes('è¶…æ™‚')) {
          showErrorState(`${error.message}\n\nğŸ’¡ æç¤ºï¼šè«‹æª¢æŸ¥ä¼ºæœå™¨æ§åˆ¶å°ï¼Œå…§å®¹å¯èƒ½å·²ç¶“æˆåŠŸç”Ÿæˆï¼`);
          console.log('ğŸ” å»ºè­°æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒï¼Œå…§å®¹å¯èƒ½å·²ç”Ÿæˆä½†å‰ç«¯è¶…æ™‚');
        } else {
          showErrorState(error.message);
        }
      } finally {
        STATE.isGenerating = false;
        updateGenerateButton(false);
      }
    }

    // èŠå¤©è™•ç†
    async function handleChatSubmission(e) {
      e.preventDefault();
      
      if (!STATE.isConnected || STATE.isChatting) {
        return;
      }

      const message = elements.chatInput.value.trim();
      if (!message) return;

      STATE.isChatting = true;
      const chatOptions = {
        contentType: document.getElementById('chatContentType').value,
        platform: document.getElementById('chatPlatform').value,
        style: document.getElementById('chatStyle').value,
        tone: document.getElementById('chatTone').value
      };

      appendChatMessage('user', message, chatOptions);
      elements.chatInput.value = '';
      elements.inputCounter.textContent = '0';
      
      const thinkingMsg = appendChatMessage('ai', 'ğŸ¤” æ€è€ƒä¸­...', chatOptions, true);
      updateSendButton(true);

      try {
        const response = await fetchWithRetry(`${STATE.currentServer}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            model: document.getElementById('model').value,
            ...chatOptions,
            history: STATE.chatHistory.slice(-10) // ä¿ç•™æœ€è¿‘10æ¢å°è©±
          })
        });

        const data = await response.json();
        
        // ç§»é™¤æ€è€ƒä¸­è¨Šæ¯
        thinkingMsg.remove();
        
        if (data && data.reply) {
          appendChatMessage('ai', data.reply, chatOptions);
          STATE.chatHistory.push({ user: message, ai: data.reply });
        } else {
          throw new Error('AIå›å¾©ç‚ºç©º');
        }
      } catch (error) {
        console.error('èŠå¤©éŒ¯èª¤:', error);
        thinkingMsg.remove();
        appendChatMessage('ai', 'âŒ æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›æ‡‰ã€‚è«‹ç¨å¾Œå†è©¦ã€‚', chatOptions);
      } finally {
        STATE.isChatting = false;
        updateSendButton(false);
        elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      }
    }

    // å¾¹åº•ä¿®å¾©è¶…æ™‚å•é¡Œ - ä½¿ç”¨ Promise.race é¿å… AbortController å•é¡Œ
    async function fetchWithRetry(url, options, retries = API_CONFIG.retryAttempts) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`ğŸ”„ å˜—è©¦ ${i + 1}/${retries}: ${url}`);
          console.log(`â° è¶…æ™‚è¨­å®š: ${API_CONFIG.timeout/1000} ç§’`);
          
          // ä½¿ç”¨ Promise.race ä»£æ›¿ AbortController ä¾†é¿å…ç€è¦½å™¨ç›¸å®¹æ€§å•é¡Œ
          const fetchPromise = fetch(url, options);
          
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => {
              reject(new Error(`è«‹æ±‚è¶…æ™‚ (è¶…é ${API_CONFIG.timeout/1000} ç§’)ï¼ŒAIå…§å®¹ç”Ÿæˆéœ€è¦è¼ƒé•·æ™‚é–“`));
            }, API_CONFIG.timeout);
          });

          console.log(`ğŸŒ ç™¼é€è«‹æ±‚ä¸­...`);
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          console.log(`âœ… è«‹æ±‚æˆåŠŸ: ${response.status} ${response.statusText}`);
          return response;
          
        } catch (error) {
          console.log(`âŒ å˜—è©¦ ${i + 1} å¤±æ•—:`, error.message);
          console.log(`ğŸ” éŒ¯èª¤é¡å‹:`, error.name);
          console.log(`ğŸ“Š éŒ¯èª¤å †ç–Š:`, error.stack);
          
          // æ¨™æº–åŒ–éŒ¯èª¤è¨Šæ¯
          if (error.message.includes('è¶…æ™‚') || error.message.includes('timeout')) {
            error.message = `ğŸ• AIç”Ÿæˆè¶…æ™‚ï¼šå…§å®¹ç”Ÿæˆé€šå¸¸éœ€è¦1-2åˆ†é˜ï¼Œè«‹æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°ç¢ºèªæ˜¯å¦å·²ç”ŸæˆæˆåŠŸ`;
            error.isTimeout = true;
          }
          
          if (i === retries - 1) {
            console.log(`ğŸ’€ æ‰€æœ‰å˜—è©¦å¤±æ•—ï¼Œæœ€çµ‚éŒ¯èª¤:`, error.message);
            throw error;
          }
          
          const delay = 1000 * (i + 1); // éå¢å»¶é²ï¼š1ç§’ã€2ç§’
          console.log(`â³ ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // UI æ›´æ–°å‡½æ•¸
    function updateGenerateButton(isLoading) {
      elements.generateBtn.disabled = isLoading;
      elements.generateBtn.innerHTML = isLoading ? 
        '<span class="loading">â³ ç”Ÿæˆä¸­...</span>' : 
        'ğŸš€ ç”¢ç”Ÿå…§å®¹';
    }

    function updateSendButton(isLoading) {
      elements.sendBtn.disabled = isLoading;
      elements.sendBtn.innerHTML = isLoading ? 
        '<span class="loading">â³</span>' : 
        'ğŸ“¤ é€å‡º';
    }

    function showLoadingState() {
      elements.contentResult.innerHTML = `
        <div class="flex items-center justify-center p-8 bg-blue-50 rounded-lg">
          <div class="text-center">
            <div class="loading text-2xl mb-2">ğŸ¤–</div>
            <div class="text-blue-600 font-medium">AIæ­£åœ¨å‰µä½œä¸­...</div>
            <div class="text-sm text-gray-500 mt-1">é€šå¸¸éœ€è¦ 1-2 åˆ†é˜ï¼Œè«‹è€å¿ƒç­‰å¾…</div>
            <div class="text-xs text-blue-500 mt-2">ğŸ’¡ æ‚¨å¯ä»¥æŸ¥çœ‹ä¼ºæœå™¨æ§åˆ¶å°äº†è§£ç”Ÿæˆé€²åº¦</div>
          </div>
        </div>
      `;
    }

         function showErrorState(errorMsg) {
       console.log('ğŸš¨ é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹:', errorMsg);
       
       const isApiError = errorMsg.includes('401') || errorMsg.includes('Unauthorized');
       const isTimeoutError = errorMsg.includes('è¶…æ™‚') || errorMsg.includes('timeout') || errorMsg.includes('AbortError') || errorMsg.includes('AIç”Ÿæˆè¶…æ™‚');
       const isServerError = errorMsg.includes('500') || errorMsg.includes('Internal Server Error');
       
       let errorTitle = 'å…§å®¹ç”Ÿæˆå¤±æ•—';
       let errorIcon = 'âŒ';
       
       if (isApiError) {
         errorTitle = 'API é‡‘é‘°å•é¡Œ';
         errorIcon = 'ğŸ”‘';
       } else if (isTimeoutError) {
         errorTitle = 'è«‹æ±‚è¶…æ™‚';
         errorIcon = 'â°';
       } else if (isServerError) {
         errorTitle = 'ä¼ºæœå™¨éŒ¯èª¤';
         errorIcon = 'ğŸš§';
       }
       
       elements.contentResult.innerHTML = `
         <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
           <div class="flex items-center mb-3">
             <span class="text-red-500 text-xl mr-2">${errorIcon}</span>
             <span class="font-medium text-red-700">${errorTitle}</span>
           </div>
           <div class="text-red-600 text-sm mb-4">${errorMsg}</div>
           
           ${isTimeoutError ? `
             <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
               <h4 class="font-medium text-blue-800 mb-2">â° è¶…æ™‚å•é¡Œè§£æ±ºæ–¹æ¡ˆ</h4>
               <ul class="text-sm text-blue-700 space-y-1 mb-3">
                 <li>â€¢ AI å…§å®¹ç”Ÿæˆéœ€è¦è¼ƒé•·æ™‚é–“ï¼Œé€™æ˜¯æ­£å¸¸ç¾è±¡</li>
                 <li>â€¢ ä¼ºæœå™¨æ—¥èªŒé¡¯ç¤ºå…§å®¹å·²æˆåŠŸç”Ÿæˆï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°</li>
                 <li>â€¢ å˜—è©¦é‡æ–°æ•´ç†é é¢ä¸¦é‡æ–°ç”Ÿæˆ</li>
                 <li>â€¢ è€ƒæ…®æ¸›å°‘ç”Ÿæˆæ•¸é‡ï¼ˆä¾‹ï¼šæ”¹ç‚º1ç¯‡ï¼‰</li>
               </ul>
               <div class="bg-green-100 border border-green-300 rounded p-2 text-xs text-green-700">
                 ğŸ’¡ æç¤ºï¼šå¾ä¼ºæœå™¨æ—¥èªŒçœ‹ï¼Œæ‚¨çš„å…§å®¹å¯èƒ½å·²ç¶“ç”ŸæˆæˆåŠŸï¼è«‹æª¢æŸ¥é»‘è‰²æ§åˆ¶å°è¦–çª—çš„æœ€æ–°å…§å®¹ã€‚
               </div>
             </div>
           ` : ''}
           ${isApiError ? `
             <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
               <h4 class="font-medium text-yellow-800 mb-2">ğŸ”‘ éœ€è¦è¨­å®š OpenRouter API é‡‘é‘°</h4>
               <ol class="text-sm text-yellow-700 space-y-1 mb-3">
                 <li>1. å‰å¾€ <a href="https://openrouter.ai/keys" target="_blank" class="text-blue-600 underline">OpenRouter.ai</a> ç”³è«‹å…è²»APIé‡‘é‘°</li>
                 <li>2. åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å‰µå»º <code class="bg-yellow-100 px-1 rounded">.env</code> æª”æ¡ˆ</li>
                 <li>3. æ·»åŠ : <code class="bg-yellow-100 px-1 rounded">OPENROUTER_API_KEY=æ‚¨çš„é‡‘é‘°</code></li>
                 <li>4. é‡æ–°å•Ÿå‹•ä¼ºæœå™¨</li>
               </ol>
               <button onclick="showApiGuide()" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded text-sm transition mr-2">
                 ğŸ“– è©³ç´°è¨­å®šèªªæ˜
               </button>
             </div>
           ` : ''}
           <div class="space-x-2">
             <button onclick="detectServer()" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm transition">
               ğŸ”„ é‡æ–°æª¢æ¸¬ä¼ºæœå™¨
             </button>
             <button onclick="testApiConnection()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition">
               ğŸ§ª æ¸¬è©¦APIé€£ç·š
             </button>
             ${isTimeoutError ? `
               <button onclick="checkServerLogs()" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition">
                 ğŸ“‹ æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒ
               </button>
               <button onclick="retryWithReducedCount()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm transition">
                 ğŸ”„ é‡è©¦ï¼ˆ1ç¯‡å…§å®¹ï¼‰
               </button>
             ` : ''}
           </div>
         </div>
       `;
     }

    function displayGeneratedContent(contents, formData) {
      const typeLabel = formData.contentType === 'jab' ? 'Jabï¼ˆé‹ªå¢Šå‹ï¼‰' : 'Right Hookï¼ˆä¸»æ‰“å‹ï¼‰';
      
      elements.contentResult.innerHTML = `
        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold text-blue-700">ğŸ“‹ ç”Ÿæˆçµæœ</h3>
            <div class="text-sm text-blue-600">
              ${contents.length} ç¯‡å…§å®¹ | ${typeLabel} | ${formData.platform}
            </div>
          </div>
          <div class="text-sm text-gray-600">
            ä¸»é¡Œ: ${formData.topic} | é¢¨æ ¼: ${formData.style} | å‰µæ„åº¦: ${formData.creativity}%
          </div>
        </div>
        ${contents.map((content, i) => `
          <div class="p-6 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg shadow-md border-l-4 border-blue-400 mb-4">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold text-blue-700">ğŸ“ å…§å®¹ ${i + 1}</div>
              <button onclick="copyToClipboard(this, '${content.replace(/'/g, "\\'")}', ${i})" 
                      class="copy-btn bg-blue-200 hover:bg-blue-300 text-blue-700 px-3 py-1 rounded text-sm transition">
                ğŸ“‹ è¤‡è£½
              </button>
            </div>
            <div class="text-gray-800 leading-relaxed whitespace-pre-wrap">${content}</div>
            <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-blue-600">
              é©ç”¨: ${formData.platform} | é¢¨æ ¼: ${formData.style}
            </div>
          </div>
        `).join('')}
        <div class="mt-4 text-center">
          <button onclick="regenerateContent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition mr-2">
            ğŸ”„ é‡æ–°ç”Ÿæˆ
          </button>
          <button onclick="optimizeContent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            âš¡ AIå„ªåŒ–å»ºè­°
          </button>
        </div>
      `;
    }

    function appendChatMessage(role, text, options, isTemporary = false) {
      const div = document.createElement('div');
      div.className = `chat-message ${role === 'user' ? 'text-right' : 'text-left'} ${isTemporary ? 'temporary' : ''}`;
      
      const timeStr = new Date().toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      div.innerHTML = `
        <div class="mb-1 text-xs text-gray-500">
          ${role === 'user' ? 'ğŸ‘¤ æˆ‘' : 'ğŸ¤– AI'} | ${timeStr} | 
          ${options.contentType} | ${options.platform} | ${options.style}
        </div>
        <div class="inline-block ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-white border'} 
                  px-4 py-2 rounded-lg max-w-xs lg:max-w-md break-words">
          ${text}
        </div>
      `;
      
      elements.chatWindow.appendChild(div);
      elements.chatWindow.scrollTop = elements.chatWindow.scrollHeight;
      return div;
    }

    function showSystemMessage(message, type = 'info') {
      const colors = {
        success: 'bg-green-100 border-green-400 text-green-700',
        error: 'bg-red-100 border-red-400 text-red-700',
        warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
        info: 'bg-blue-100 border-blue-400 text-blue-700'
      };
      
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-20 right-4 p-3 rounded-lg border z-50 ${colors[type]} shadow-lg`;
      msgDiv.textContent = message;
      
      document.body.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.style.opacity = '0';
        msgDiv.style.transform = 'translateX(100%)';
        setTimeout(() => msgDiv.remove(), 300);
      }, 3000);
    }

    // å¯¦ç”¨å‡½æ•¸
    function copyToClipboard(button, text, index) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ… å·²è¤‡è£½';
        button.style.backgroundColor = '#10b981';
        button.style.color = 'white';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
          button.style.color = '';
        }, 2000);
      }).catch(() => {
        showSystemMessage('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æ–‡å­—', 'error');
      });
    }

    function regenerateContent() {
      if (STATE.lastGenerated) {
        document.getElementById('topic').value = STATE.lastGenerated.formData.topic;
        elements.contentForm.dispatchEvent(new Event('submit'));
      }
    }

    function optimizeContent() {
      if (STATE.lastGenerated) {
        const content = STATE.lastGenerated.contents[0];
        elements.chatInput.value = `è«‹å¹«æˆ‘åˆ†æä¸¦å„ªåŒ–é€™å€‹å…§å®¹ï¼š\n\n${content}`;
        elements.chatForm.dispatchEvent(new Event('submit'));
      }
    }

         // é¡å¤–å¯¦ç”¨å‡½æ•¸
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
         return;
       }
       
       try {
         showSystemMessage('ğŸ§ª æ¸¬è©¦APIé€£ç·šä¸­...', 'info');
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: AbortSignal.timeout(10000)
         });
         
         const data = await response.json();
         if (response.ok) {
           showSystemMessage('âœ… APIé€£ç·šæ­£å¸¸ï¼', 'success');
         } else {
           showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
         }
       } catch (error) {
         showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
       }
     }
     
     function showApiGuide() {
       const guideContent = `
         <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
           <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto p-6">
             <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-bold text-gray-800">ğŸ”‘ OpenRouter API è¨­å®šæŒ‡å—</h3>
               <button onclick="closeApiGuide()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
             </div>
             
             <div class="space-y-4 text-sm">
               <div class="bg-blue-50 p-4 rounded">
                 <h4 class="font-medium text-blue-800 mb-2">ğŸ“ æ­¥é©Ÿ 1: ç”³è«‹APIé‡‘é‘°</h4>
                 <p class="text-blue-700">å‰å¾€ <a href="https://openrouter.ai/keys" target="_blank" class="underline">OpenRouter.ai</a> è¨»å†Šå¸³è™Ÿä¸¦å‰µå»ºAPIé‡‘é‘°</p>
               </div>
               
               <div class="bg-green-50 p-4 rounded">
                 <h4 class="font-medium text-green-800 mb-2">ğŸ“„ æ­¥é©Ÿ 2: å‰µå»º .env æª”æ¡ˆ</h4>
                 <p class="text-green-700 mb-2">åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„å‰µå»º .env æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š</p>
                 <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">OPENROUTER_API_KEY=sk-or-v1-ä½ çš„å¯¦éš›é‡‘é‘°
PORT=3001
DEBUG=true</pre>
               </div>
               
               <div class="bg-orange-50 p-4 rounded">
                 <h4 class="font-medium text-orange-800 mb-2">ğŸ”„ æ­¥é©Ÿ 3: é‡æ–°å•Ÿå‹•</h4>
                 <p class="text-orange-700">åœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œ <code class="bg-gray-100 px-1 rounded">npm start</code> é‡æ–°å•Ÿå‹•ä¼ºæœå™¨</p>
               </div>
               
               <div class="bg-purple-50 p-4 rounded">
                 <h4 class="font-medium text-purple-800 mb-2">ğŸ’¡ å…è²»é¡åº¦èªªæ˜</h4>
                 <ul class="text-purple-700 space-y-1">
                   <li>â€¢ æ–°ç”¨æˆ¶æœ‰ $5 å…è²»é¡åº¦</li>
                   <li>â€¢ éƒ¨åˆ†æ¨¡å‹å®Œå…¨å…è²»ä½¿ç”¨</li>
                   <li>â€¢ DeepSeek æ¨¡å‹æ€§åƒ¹æ¯”æ¥µé«˜</li>
                 </ul>
               </div>
             </div>
             
             <div class="mt-6 flex justify-end space-x-2">
               <a href="https://openrouter.ai/keys" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                 ğŸ”— å‰å¾€ç”³è«‹é‡‘é‘°
               </a>
               <button onclick="closeApiGuide()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition">
                 é—œé–‰
               </button>
             </div>
           </div>
         </div>
       `;
       
       document.body.insertAdjacentHTML('beforeend', guideContent);
     }
     
     function closeApiGuide() {
       const guide = document.querySelector('.fixed.inset-0');
       if (guide) guide.remove();
     }

     // æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒï¼ˆè¶…æ™‚éŒ¯èª¤å°ˆç”¨ï¼‰
     function checkServerLogs() {
       showSystemMessage('ğŸ’¡ è«‹æŸ¥çœ‹é»‘è‰²æ§åˆ¶å°è¦–çª—ï¼ˆä¼ºæœå™¨æ—¥èªŒï¼‰ï¼Œå…§å®¹å¯èƒ½å·²ç¶“æˆåŠŸç”Ÿæˆ', 'info');
       // å˜—è©¦æª¢æŸ¥æœ€è¿‘çš„å¥åº·ç‹€æ…‹
       if (STATE.currentServer) {
         fetch(`${STATE.currentServer}/health`)
           .then(response => response.json())
           .then(data => {
             console.log('ğŸ¥ ä¼ºæœå™¨å¥åº·ç‹€æ…‹:', data);
             showSystemMessage('âœ… ä¼ºæœå™¨é‹è¡Œæ­£å¸¸ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°çš„è©³ç´°æ—¥èªŒ', 'success');
           })
           .catch(err => {
             console.error('âŒ å¥åº·æª¢æŸ¥å¤±æ•—:', err);
           });
       }
     }

     // é‡è©¦ç”Ÿæˆï¼ˆæ¸›å°‘æ•¸é‡ï¼‰
     function retryWithReducedCount() {
       if (STATE.isGenerating) return;
       
       // è¨­å®šç‚º1ç¯‡å…§å®¹
       document.getElementById('count').value = '1';
       showSystemMessage('ğŸ”„ é‡æ–°å˜—è©¦ç”Ÿæˆ 1 ç¯‡å…§å®¹...', 'info');
       
       // é‡æ–°æäº¤è¡¨å–®
       setTimeout(() => {
         elements.contentForm.dispatchEvent(new Event('submit'));
       }, 1000);
     }

     // å¢å¼·çš„APIæ¸¬è©¦
     async function testApiConnection() {
       if (!STATE.currentServer) {
         showSystemMessage('âŒ è«‹å…ˆé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
         return;
       }
       
       try {
         showSystemMessage('ğŸ§ª æ¸¬è©¦APIé€£ç·šä¸­...', 'info');
         updateGenerateButton(true);
         
         const response = await fetch(`${STATE.currentServer}/api/test-api`, {
           method: 'GET',
           signal: new AbortController().signal
         });
         
         const data = await response.json();
         if (response.ok && data.success) {
           showSystemMessage(`âœ… APIé€£ç·šæ­£å¸¸ï¼AIå›æ‡‰: ${data.response || 'OK'}`, 'success');
           console.log('ğŸ§ª APIæ¸¬è©¦çµæœ:', data);
         } else {
           showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
         }
       } catch (error) {
         console.error('âŒ APIæ¸¬è©¦éŒ¯èª¤:', error);
         showSystemMessage(`âŒ APIæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
       } finally {
         updateGenerateButton(false);
       }
     }

     // åœç”¨å®šæœŸæª¢æŸ¥ä»¥é¿å…å¹²æ“¾ï¼ˆèª¿è©¦æœŸé–“ï¼‰
     console.log('â„¹ï¸ å®šæœŸå¥åº·æª¢æŸ¥å·²åœç”¨ï¼Œé¿å…å¹²æ“¾å…§å®¹ç”Ÿæˆ');
     /*
     setInterval(() => {
       if (STATE.isConnected) {
         fetch(`${STATE.currentServer}/health`)
           .catch(() => {
             STATE.isConnected = false;
             updateConnectionStatus('offline', 'âŒ é€£ç·šä¸­æ–·');
             showSystemMessage('âš ï¸ èˆ‡ä¼ºæœå™¨çš„é€£ç·šå·²ä¸­æ–·', 'warning');
           });
       }
     }, 30000);
     */
  </script>
</body>
</html>
